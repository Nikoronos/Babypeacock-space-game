<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BPC Space â€” Mars (Level 2)</title>
<style>
  :root{--fg:#d7ebff;--accent:#37d8ff;--heart:#ff2f55}
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .hud{position:sticky;top:0;z-index:3;display:flex;gap:10px;align-items:center;justify-content:space-between;
       padding:8px 10px;background:linear-gradient(#04070b,#0a0f16);color:var(--fg);max-width:480px;margin:0 auto}
  .brand{color:#9db9ff;font-weight:800;font-size:22px;letter-spacing:.4px;display:flex;gap:6px;align-items:center}
  .stat{font-weight:700}
  #wrap{position:relative;max-width:480px;aspect-ratio:9/16;margin:0 auto;border-radius:14px;overflow:hidden;background:#000}
  canvas{width:100%;height:100%;display:block}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.75);display:flex;flex-direction:column;gap:14px;
           align-items:center;justify-content:center;color:var(--fg);z-index:4;text-align:center;padding:18px}
  .btn{padding:12px 18px;border:0;border-radius:10px;background:#0b424a;color:#eaffff;font-weight:800;letter-spacing:.3px}
  .hearts{display:flex;gap:6px}
  .hearts i{width:18px;height:18px;background:var(--heart);
    mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 29"><path d="M23.6,0c-2.9,0-5.4,1.6-6.6,3.9C15.8,1.6,13.3,0,10.4,0C4.7,0,0,4.7,0,10.4c0,10.1,16.9,18.4,16.9,18.4S33.7,20.5,33.7,10.4C33.7,4.7,29,0,23.6,0z"/></svg>') center/contain no-repeat}
</style>
</head>
<body>
  <div class="hud">
    <div class="brand">Babypeacock ðŸ¦š</div>
    <div class="stat">Mars (Level 2)</div>
    <div class="stat">Score: <span id="sc">0</span></div>
    <div id="hearts" class="hearts"></div>
  </div>

  <div id="wrap">
    <canvas id="cv" width="360" height="640"></canvas>

    <div id="start" class="overlay">
      <h2>Mars GÃ¶revi</h2>
      <div>ParmaÄŸÄ±nÄ± saÄŸ/sol sÃ¼rÃ¼kle Â· Otomatik ateÅŸ Â· <b>Elmas = 12s 3â€™lÃ¼ atÄ±ÅŸ</b></div>
      <button class="btn" onclick="startGame()">BAÅžLA</button>
      <small style="opacity:.8">Ã‡izgisiz Mars zemini Â· mobil iÃ§in optimize</small>
    </div>

    <div id="gameover" class="overlay" style="display:none">
      <h2>GAME OVER</h2>
      <button class="btn" onclick="restart()">TEKRAR</button>
    </div>
  </div>

<script>
(() => {
  // ======== UTIL: robust image loader with multiple filename fallbacks ========
  function loadOne(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
  async function loadTry(list){for(const s of list){try{return await loadOne(s)}catch{}} throw "image not found "+list.join(", ");}

  // ======== UTIL: chroma key (remove white/black backgrounds) + edge soften ========
  function stripBG(img){
    const w=img.width,h=img.height, c=document.createElement('canvas'); c.width=w; c.height=h;
    const g=c.getContext('2d',{willReadFrequently:true}); g.drawImage(img,0,0);
    const d=g.getImageData(0,0,w,h), p=d.data;
    for(let i=0;i<p.length;i+=4){
      const r=p[i],g1=p[i+1],b=p[i+2],a=p[i+3];
      // keep already transparent
      if(a<10) continue;
      // kill near-white OR near-black
      if((r>235&&g1>235&&b>235) || (r<18&&g1<18&&b<18)) { p[i+3]=0; continue; }
      // slight soften halo: if very bright, reduce alpha
      const lum=(r+g1+b)/3;
      if(lum>225) p[i+3]=Math.max(0, p[i+3]- (lum-225));
    }
    g.putImageData(d,0,0);
    return c;
  }

  // ======== CANVAS ========
  const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
  const W=cv.width, H=cv.height;
  const SC=document.getElementById('sc'), HEARTS=document.getElementById('hearts');

  // ======== ASSET PATHS (tÃ¼m varyantlarÄ± dener) ========
  const P = {
    player: ["./img/player/bpc_mini.png","./img/player/bpc.png","./peacock_gemisi.png"],
    green : ["./mars_enemy_green.png","./mars enemy green.png","./merkur/mars_enemy_green.png","./merkur/mars enemy green.png"],
    yellow: ["./mars_enemy_yellow.png","./Mars enemy yellow.png","./merkur/mars_enemy_yellow.png","./merkur/Mars enemy yellow.png"],
    white : ["./mars_enemy_white.png","./mars enemy white.png","./merkur/mars_enemy_white.png","./merkur/mars enemy white.png"],
    red   : ["./mars_enemy_red.png","./mars enemy red.png","./mars enemy red .png","./merkur/mars_enemy_red.png","./merkur/mars enemy red .png"]
  };

  const art = {p:null,g:null,y:null,w:null,r:null};

  // ======== GAME STATE ========
  const S={
    running:false, score:0, lives:3, time:0, last:0,
    player:{x:W/2,y:H*0.82,w:44,h:44,tripleUntil:0},
    bullets:[], enemies:[], gems:[],
    spawnEvery:900, lastSpawn:0, diamondT:0
  };

  function setHearts(n){ HEARTS.innerHTML=""; for(let i=0;i<n;i++){HEARTS.appendChild(document.createElement('i'));} }

  // ======== INPUT: drag only X ========
  let drag=false,lastX=0,mouse=false;
  cv.addEventListener('touchstart',e=>{drag=true; lastX=e.touches[0].clientX; e.preventDefault();},{passive:false});
  cv.addEventListener('touchmove',e=>{ if(!drag) return; const t=e.touches[0].clientX; S.player.x=Math.max(20,Math.min(W-20,S.player.x+(t-lastX))); lastX=t; e.preventDefault();},{passive:false});
  addEventListener('touchend',()=>drag=false);
  cv.addEventListener('mousedown',e=>{mouse=true; lastX=e.offsetX});
  addEventListener('mouseup',()=>mouse=false);
  cv.addEventListener('mousemove',e=>{ if(!mouse) return; S.player.x=Math.max(20,Math.min(W-20,S.player.x+(e.offsetX-lastX))); lastX=e.offsetX; });

  // ======== GAMEPLAY ========
  function marsBG(){
    // Ã§izgisiz, gÃ¼rÃ¼ltÃ¼lÃ¼ kum
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,"#4a1915"); grd.addColorStop(1,"#2d0f0e");
    ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
    ctx.fillStyle="rgba(0,0,0,.35)";
    for(let i=0;i<70;i++){
      const x=(i*57.3 + (S.time*0.08))%W, y=(i*103.7 + S.time*0.21)%H;
      ctx.fillRect(x,y,1.3,1.3);
    }
  }

  function addBullet(x,y){
    if(S.time<S.player.tripleUntil){
      S.bullets.push({x:x-12,y,vy:-0.9}); S.bullets.push({x,y,vy:-0.9}); S.bullets.push({x:x+12,y,vy:-0.9});
    }else S.bullets.push({x,y,vy:-0.9});
  }

  function spawnEnemy(){
    const lane = 40 + Math.floor(Math.random()*5)*(W-80)/4;
    const pool = (S.score<150)?["green","yellow","white"]:["green","yellow","white","red"];
    const kind=pool[Math.floor(Math.random()*pool.length)];
    const vy = (kind==="red")?0.46:(kind==="yellow"?0.38:0.33);
    const hp = (kind==="red")?3:1;
    const pts= (kind==="green")?2:3; // green=2, yellow/white=3
    S.enemies.push({x:lane,y:-60,w:48,h:48,vy,kind,hp,pts,cd:0});
  }

  function spawnGem(){ S.gems.push({x:20+Math.random()*(W-40),y:-20,vy:0.28}); }

  function hitPlayer(){ S.lives--; setHearts(S.lives); if(S.lives<=0) gameOver(); }

  function gameOver(){ S.running=false; document.getElementById('gameover').style.display=""; }

  // ======== LOOP ========
  let shootT=0;
  function loop(t){
    if(!S.running) return;
    const dt = S.last?(t-S.last):16; S.last=t; S.time+=dt;

    marsBG();

    // spawn pacing
    if(t-S.lastSpawn>S.spawnEvery){S.lastSpawn=t; spawnEnemy(); if(S.spawnEvery>450) S.spawnEvery-=8;}
    S.diamondT+=dt; if(S.diamondT>4500){S.diamondT=0; spawnGem();}

    // auto shoot
    shootT+=dt; const rate=(S.time<S.player.tripleUntil)?140:220;
    if(shootT>rate){shootT=0; addBullet(S.player.x,S.player.y-24);}

    // bullets
    ctx.fillStyle="#86e0ff";
    for(const b of S.bullets){ b.y+=b.vy*dt; ctx.fillRect(b.x-2,b.y-10,4,12); }
    S.bullets=S.bullets.filter(b=>b.y>-20);

    // enemies
    for(const e of S.enemies){
      e.y+=e.vy*dt;
      const img=(e.kind==="green")?art.g:(e.kind==="yellow")?art.y:(e.kind==="red")?art.r:art.w;
      if(e.kind==="white"){ // ters Ã§izim
        ctx.save(); ctx.translate(e.x+24,e.y-24); ctx.scale(-1,1); ctx.drawImage(img,0,0,48,48); ctx.restore();
      }else ctx.drawImage(img,e.x-24,e.y-24,48,48);

      // red kÄ±sa lazer
      if(e.kind==="red"){ e.cd-=dt; if(e.cd<=0){e.cd=900; ctx.fillStyle="#ff5b5b"; ctx.fillRect(e.x-1,e.y+20,2,18);
        if(Math.abs(S.player.x-e.x)<18 && Math.abs(S.player.y-(e.y+30))<28) hitPlayer();
      }}
    }

    // bullets vs enemies
    for(const e of S.enemies){
      for(const b of S.bullets){
        if(Math.abs(b.x-e.x)<22 && Math.abs(b.y-e.y)<26){ b.y=-9999; e.hp--; if(e.hp<=0){e.dead=true; S.score+=e.pts; SC.textContent=S.score;}}
      }
    }
    // player vs enemy
    S.enemies=S.enemies.filter(e=>{ if(Math.abs(S.player.x-e.x)<26 && Math.abs(S.player.y-e.y)<26){e.dead=true; hitPlayer();} return !e.dead && e.y<H+40; });

    // gems
    for(const d of S.gems){ d.y+=d.vy*dt;
      ctx.fillStyle="#6bdcff"; ctx.beginPath(); ctx.moveTo(d.x,d.y-8); ctx.lineTo(d.x+10,d.y); ctx.lineTo(d.x,d.y+8); ctx.lineTo(d.x-10,d.y); ctx.closePath(); ctx.fill();
      if(Math.abs(S.player.x-d.x)<18 && Math.abs(S.player.y-d.y)<22){ d.take=true; S.player.tripleUntil=Math.max(S.player.tripleUntil,S.time+12000); }
    }
    S.gems=S.gems.filter(d=>!d.take && d.y<H+20);

    // player
    ctx.drawImage(art.p,S.player.x-S.player.w/2,S.player.y-S.player.h/2,S.player.w,S.player.h);

    requestAnimationFrame(loop);
  }

  // ======== START / RESTART ========
  function startGame(){
    document.getElementById('start').style.display="none";
    document.getElementById('gameover').style.display="none";
    S.running=true; S.score=0; SC.textContent="0"; S.lives=3; setHearts(3);
    S.bullets.length=0; S.enemies.length=0; S.gems.length=0; S.spawnEvery=900; S.player.tripleUntil=0; S.time=0; S.last=0;
    requestAnimationFrame(loop);
  }
  window.startGame=startGame;
  window.restart=()=>{document.getElementById('gameover').style.display="none"; startGame();};

  // ======== LOAD ASSETS (tek sefer; tÃ¼m PNGâ€™lerde arka planÄ± siler) ========
  (async () => {
    const pRaw=await loadTry(P.player);   art.p=stripBG(pRaw);   // siyah/beyazÄ± sil
    art.g=stripBG(await loadTry(P.green));
    art.y=stripBG(await loadTry(P.yellow));
    art.w=stripBG(await loadTry(P.white));  // white sprite ÅŸeffaf + oyunda ters Ã§iziliyor
    art.r=stripBG(await loadTry(P.red));
    setHearts(3);
  })();
})();
</script>
</body>
</html>
