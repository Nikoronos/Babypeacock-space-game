<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BPC Space — Level 2 (Mars)</title>
<style>
  :root{
    --ui:#0ff;--text:#cfe9ff;--hud:#001a23;--brand:#12e3a9;--danger:#ff3b3b;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  #topbar{position:fixed;inset:0 0 auto 0;height:34px;display:flex;align-items:center;gap:12px;
          padding:6px 12px;background:#081b23;color:var(--text);z-index:10}
  #brand{font-weight:800;color:#9bf;letter-spacing:.2px}
  #score{margin-left:auto}
  #lives{display:flex;gap:6px}
  #wrap{display:flex;align-items:center;justify-content:center;height:100%}
  canvas{background:#0b3c49;touch-action:none}
  /* overlay */
  #over{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
        background:rgba(0,0,0,.6);z-index:20}
  .card{background:#07141b;border:1px solid #11303b;border-radius:14px;padding:22px 20px;text-align:center;
        color:#eaf7ff;min-width:240px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
  .btn{margin-top:12px;background:#00d4c4;border:0;padding:10px 18px;border-radius:12px;color:#001b1a;
       font-weight:800;cursor:pointer}
  /* wolf hp bar (boss) */
  #bossbar{position:fixed;left:8px;right:8px;top:36px;height:10px;background:#192a33;border-radius:10px;
           display:none}
  #bossfill{height:100%;width:0;background:#19d34b;border-radius:10px}
</style>
</head>
<body>
  <div id="topbar">
    <div id="brand">Babypeacock 🦚</div>
    <div id="level">Mars (Level 2)</div>
    <div id="score">SCORE: 0</div>
    <div id="lives"></div>
  </div>

  <div id="bossbar"><div id="bossfill"></div></div>

  <div id="wrap"><canvas id="game" width="420" height="740"></canvas></div>

  <div id="over">
    <div class="card">
      <div id="overText" style="font-size:28px;font-weight:900;letter-spacing:.5px;margin-bottom:2px">GAME OVER</div>
      <button id="retry" class="btn">RETRY</button>
    </div>
  </div>

  <!-- Opsiyonel: mevcutsa Firebase sayaç kodun (Js/fribase.js) -->
  <script defer src="../Js/fribase.js"></script>

<script>
(() => {
  /* ===============  Canvas  =============== */
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d'); ctx.imageSmoothingEnabled = false;
  const W = cvs.width, H = cvs.height;

  /* ===============  UI refs  =============== */
  const uiScore = document.getElementById('score');
  const uiLives = document.getElementById('lives');
  const over = document.getElementById('over');
  const overText = document.getElementById('overText');
  const retry = document.getElementById('retry');
  const bossbar = document.getElementById('bossbar');
  const bossfill = document.getElementById('bossfill');

  /* ===============  Background (Mars)  =============== */
  const bg = new Image();
  bg.src = '../assets/mars_bg.png';  // varsa döşer; yoksa degrade
  let bgReady=false, bgPat=null, bgY=0;
  bg.onload = () => { bgPat = ctx.createPattern(bg, 'repeat'); bgReady=true; };

  function drawBackground(dt){
    // scroll etkisi
    bgY = (bgY + dt * 0.02) % H;
    if(bgReady){
      ctx.save();
      ctx.translate(0, -bgY);
      ctx.fillStyle = bgPat;
      ctx.fillRect(0,0,W,H+bg.height);
      ctx.restore();
    }else{
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0,'#6b2d1a'); g.addColorStop(1,'#472015');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
      // toz parçacık efekti
      ctx.fillStyle = 'rgba(0,0,0,.25)';
      for(let i=0;i<120;i++){ ctx.fillRect((i*37)%W, (i*83+bgY*3)%H, 2, 2); }
    }
  }

  /* ===============  Input  =============== */
  const keys = {};
  addEventListener('keydown', e => keys[e.key] = true);
  addEventListener('keyup',   e => keys[e.key] = false);
  cvs.addEventListener('mousemove', e => {
    const r = cvs.getBoundingClientRect();
    player.x = Math.max(22, Math.min(W-22, e.clientX - r.left));
  });
  cvs.addEventListener('touchmove', e => {
    const r = cvs.getBoundingClientRect();
    const t = e.touches[0];
    player.x = Math.max(22, Math.min(W-22, t.clientX - r.left));
    e.preventDefault();
  }, {passive:false});

  /* ===============  Player  =============== */
  const playerImg = new Image();
  playerImg.src = '../img/player/peacock_gemisi.png'; // repona göre doğru
  let playerReady=false; playerImg.onload = () => playerReady = true;

  const player = { x: W/2, y: H-72, w: 44, h: 44, fireCd: 0, lives: 3 };

  function drawPlayer(){
    if(playerReady){
      ctx.drawImage(playerImg, player.x - 24, player.y - 24, 48, 48);
    }else{
      // yedek üçgen
      ctx.fillStyle = '#00e5ff';
      ctx.beginPath();
      ctx.moveTo(player.x, player.y-18);
      ctx.lineTo(player.x-14, player.y+18);
      ctx.lineTo(player.x+14, player.y+18);
      ctx.closePath(); ctx.fill();
    }
  }

  /* ===============  Bullets  =============== */
  const bullets = [];        // player
  const ebullets = [];       // enemy/boss

  function shoot(){
    bullets.push({x:player.x, y:player.y-26, vy:-0.85, w:3, h:10, col:'#ffd94a'});
  }

  /* ===============  Enemies  =============== */
  const enemies = [];
  const G = {
    MAX_ENEMIES: 8,
    SPAWN_EVERY: 480, // ms
  };

  // Görseller (root'ta oldukları için ../ ile çıkmadım)
  const IMG = {
    green: new Image(), yellow: new Image(), white: new Image(), boss: new Image()
  };
  IMG.green.src  = '../mars_enemy_green.png';
  IMG.yellow.src = '../mars_enemy_yellow.png';
  IMG.white.src  = '../mars_enemy_white.png';
  IMG.boss.src   = '../mars_enemy_bigger_green.png';

  function spawnEnemy(){
    if(enemies.length >= G.MAX_ENEMIES) return;
    // tip seçimi: green / yellow / white
    const t = Math.random();
    const type = t < .45 ? 'green' : (t < .8 ? 'yellow' : 'white');
    const img = IMG[type];
    const w = type==='white' ? 56 : 48, h = type==='white' ? 56 : 48;
    enemies.push({
      type, img, x: 30 + Math.random()*(W-60), y: -60,
      w, h, vy: .15 + Math.random()*.1, // yavaş süzülme
      fireCd: 400 + Math.random()*600
    });
  }

  // Boss
  let boss=null;
  function spawnBoss(){
    boss = {
      img: IMG.boss, x: W/2, y: -140, w: 128, h: 128,
      hp: 30, enter:false, fireCd: 0, vx: .18
    };
    bossbar.style.display='block';
  }

  /* ===============  Score & UI  =============== */
  let score = 0;
  function setScore(s){ score=s; uiScore.textContent = 'SCORE: ' + score; }
  function drawLives(){
    uiLives.innerHTML = '';
    for(let i=0;i<player.lives;i++){ const span=document.createElement('span'); span.textContent='❤️'; uiLives.appendChild(span); }
  }
  drawLives();

  /* ===============  Game Flow  =============== */
  let running=true, last=performance.now(), spawnTimer=0;

  // Firebase sayaç: startta bir kez (varsa)
  try{ if(window.BPC_incrementOnStart) window.BPC_incrementOnStart(); }catch(_){}

  retry.onclick = () => location.reload();

  function endGame(text){
    running=false; over.style.display='flex'; overText.textContent = text || 'GAME OVER';
  }

  function rectHit(a,b){
    return Math.abs(a.x-b.x) < (a.w+b.w)/2 && Math.abs(a.y-b.y) < (a.h+b.h)/2;
  }

  /* ===============  LOOP  =============== */
  function loop(t){
    if(!running) return;
    const dt = Math.min(40, t-last); last=t;

    // arka plan
    drawBackground(dt);

    // input
    if(keys['ArrowLeft'])  player.x -= .33*dt;
    if(keys['ArrowRight']) player.x += .33*dt;
    player.x = Math.max(22, Math.min(W-22, player.x));

    // auto fire
    player.fireCd -= dt;
    if(player.fireCd <= 0){ shoot(); player.fireCd = 160; }

    // bullets update/draw
    ctx.fillStyle = '#ffd94a';
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; b.y += b.vy*dt;
      ctx.fillStyle = b.col; ctx.fillRect(b.x-2,b.y-8,4,10);
      if(b.y < -20) bullets.splice(i,1);
    }

    // spawn küçük düşmanlar (boss yokken)
    if(!boss){
      spawnTimer += dt;
      if(spawnTimer >= G.SPAWN_EVERY){ spawnEnemy(); spawnTimer=0; }
    }

    // enemies move/draw/shoot
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      e.y += e.vy*dt;

      // ateş
      e.fireCd -= dt;
      if(e.fireCd <= 0){
        if(e.type==='white'){
          // iki beyaz lazer, sağ & sol
          ebullets.push({x:e.x-16,y:e.y+22,vy:.45,w:3,h:12,col:'#ffffff'});
          ebullets.push({x:e.x+16,y:e.y+22,vy:.45,w:3,h:12,col:'#ffffff'});
          e.fireCd = 720 + Math.random()*600;
        }else{
          // tek atış
          ebullets.push({x:e.x,y:e.y+22,vy:.42,w:3,h:12,col:e.type==='green'?'#3cff8a':'#fff04b'});
          e.fireCd = 620 + Math.random()*600;
        }
      }

      // çiz
      if(e.img?.complete) ctx.drawImage(e.img, e.x-e.w/2, e.y-e.h/2, e.w, e.h);

      // ekran dışı
      if(e.y > H+60){ enemies.splice(i,1); continue; }

      // bullet çarpışması
      for(let k=bullets.length-1;k>=0;k--){
        if(rectHit({x:e.x,y:e.y,w:e.w,h:e.h}, {x:bullets[k].x,y:bullets[k].y,w:8,h:12})){
          bullets.splice(k,1);
          enemies.splice(i,1);
          setScore(score+10);
          break;
        }
      }

      // player çarpışması
      if(rectHit({x:e.x,y:e.y,w:e.w,h:e.h}, {x:player.x,y:player.y,w:36,h:36})){
        enemies.splice(i,1);
        if(--player.lives<=0) return endGame('GAME OVER'); drawLives();
      }
    }

    // boss doğsun: 500 puan ve boss yoksa
    if(score>=500 && !boss) spawnBoss();

    // boss davranışları
    if(boss){
      // sahneye giriş
      if(!boss.enter){ boss.y += .2*dt; if(boss.y>=120){ boss.enter=true; } }
      else{
        boss.x += boss.vx*dt;
        if(boss.x < 80 || boss.x > W-80) boss.vx *= -1;

        // atış (yeşil lazerler)
        boss.fireCd -= dt;
        if(boss.fireCd<=0){
          ebullets.push({x:boss.x-28,y:boss.y+46,vy:.48,w:4,h:14,col:'#33ff66'});
          ebullets.push({x:boss.x+28,y:boss.y+46,vy:.48,w:4,h:14,col:'#33ff66'});
          boss.fireCd = 420;
        }
      }

      // çiz
      if(boss.img?.complete) ctx.drawImage(boss.img, boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h);

      // boss bullet çarpması
      for(let i=bullets.length-1;i>=0;i--){
        if(rectHit({x:boss.x,y:boss.y,w:boss.w-20,h:boss.h-20},{x:bullets[i].x,y:bullets[i].y,w:8,h:12})){
          bullets.splice(i,1);
          boss.hp -= 1;
          const pct = Math.max(0,boss.hp/30);
          bossfill.style.width = (pct*100)+'%';
          if(boss.hp<=0){
            boss=null; bossbar.style.display='none';
            // Level 3 yoksa oyun bitti ekranı:
            setTimeout(()=>endGame('VICTORY!'), 600);
          }
        }
      }
    }

    // enemy bullets
    for(let i=ebullets.length-1;i>=0;i--){
      const b=ebullets[i]; b.y += b.vy*dt;
      ctx.fillStyle = b.col; ctx.fillRect(b.x-2,b.y-8,4,12);
      if(b.y>H+20){ ebullets.splice(i,1); continue; }
      if(rectHit({x:player.x,y:player.y,w:32,h:32}, {x:b.x,y:b.y,w:6,h:14})){
        ebullets.splice(i,1);
        if(--player.lives<=0) return endGame('GAME OVER'); drawLives();
      }
    }

    // player draw en sonda
    drawPlayer();

    requestAnimationFrame(loop);
  }

  // ilk skor/life
  setScore(0); drawLives();

  // başlat
  requestAnimationFrame(ts=>{ last=ts; loop(ts); });
})();
</script>
</body>
</html>
