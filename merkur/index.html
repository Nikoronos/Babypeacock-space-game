<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>BPC Space ‚Äî Level 2 (Merk√ºr)</title>
  <style>
    html,body{margin:0;background:#0b1d23;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
    #hud{position:fixed;left:0;top:0;right:0;height:34px;display:flex;align-items:center;gap:10px;padding:6px 10px;background:#001820cc}
    #brand{font-weight:800}
    #msg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;font-weight:900;font-size:26px}
    #msg>div{background:#001820; padding:16px 20px; border-radius:12px; box-shadow:0 10px 30px #0008; text-align:center}
    canvas{display:block;margin:0 auto;background:#0b1d23;touch-action:none}
    .btn{margin-top:10px; padding:10px 16px; border-radius:10px; background:#00e7e7; color:#003; border:0; font-weight:800}
  </style>
</head>
<body>
  <div id="hud">
    <span id="brand">Babypeacock ü¶ö</span>
    <span id="score">SCORE: 0</span>
    <span id="lives" style="margin-left:auto">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
  </div>
  <canvas id="game" width="420" height="740"></canvas>
  <div id="msg"><div>
    <div id="msgText">GAME OVER</div>
    <button id="retry" class="btn">RETRY</button>
  </div></div>

  <!-- Firebase (opsiyonel) -->
  <script src="../Js/fribase.js"></script>

<script>
/* ================== CANVAS ================== */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d', {alpha:false});
ctx.imageSmoothingEnabled = false;
const W = cvs.width, H = cvs.height;

/* ================== HUD ================== */
const scoreEl = document.getElementById('score');
const livesEl = document.getElementById('lives');
const msg = document.getElementById('msg');
const msgText = document.getElementById('msgText');
const retryBtn = document.getElementById('retry');

/* ================== KAYNAKLAR ================== */
const IMG = {
  green:  loadImg('../mars_enemy_green.png'),
  yellow: loadImg('../mars_enemy_yellow.png'),
  white:  loadImg('../mars_enemy_white.png'),         // not: ters kayƒ±t ise FLIP_WHITE=true
  boss:   loadImg('../mars_enemy_bigger_green.png')
};
const FLIP_WHITE = true; // white ters kaydedildiyse true; d√ºzse false yaparsƒ±n

function loadImg(src){ const im=new Image(); im.src=src; return im; }

/* ================== DURUMLAR ================== */
let started=false, running=false, lastT=0;
let score=0, lives=3;

const player = {
  x: W/2, y: H-80, w: 26, h: 26, spd: 3.3, fireCD: 0
};

const bullets = [];      // oyuncu mermileri
const ebullets = [];     // d√º≈üman mermileri
const enemies = [];      // aktif d√º≈ümanlar
let boss=null, bossActive=false, bossSpawned=false;

/* ================== OYUNU BA≈ûLAT ================== */
function startGame(){
  if (started) return;
  started = true;
  running = true;
  score = 0; lives = 3;
  bullets.length = ebullets.length = enemies.length = 0;
  boss=null; bossActive=false; bossSpawned=false;
  lastT = performance.now();
  if (window.BPC_incrementOnStart) { try{ window.BPC_incrementOnStart(); }catch{} }
  if (window.BPC_logCountryOnStart){ try{ window.BPC_logCountryOnStart(); }catch{} }
  msg.style.display='none';
  requestAnimationFrame(loop);
}
addEventListener('keydown', startGame, {passive:true});
cvs.addEventListener('pointerdown', startGame, {passive:true});
cvs.addEventListener('touchstart', startGame, {passive:true});
retryBtn.onclick = startGame;

/* ================== KONTROL ================== */
const keys={};
addEventListener('keydown',e=>keys[e.key]=true);
addEventListener('keyup',e=>keys[e.key]=false);
cvs.addEventListener('pointermove',e=>{
  const r=cvs.getBoundingClientRect();
  const px = e.clientX - r.left;
  player.x = Math.max(16, Math.min(W-16, px));
});

/* ================== YARDIMCI ================== */
function rand(a,b){return a + Math.random()*(b-a);}
function aabb(a,b){return Math.abs(a.x-b.x) < (a.w+b.w)/2 && Math.abs(a.y-b.y) < (a.h+b.h)/2;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

/* ================== ARKAPLAN (MARS) ================== */
function drawMarsBackground(t){
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#5c2a1e'); g.addColorStop(1,'#7a3a25');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  ctx.globalAlpha=0.12;
  ctx.fillStyle='#a55234';
  const s = 0.022;
  for(let i=0;i<6;i++){
    const y=((t*s + i*90)%(H+60))-60;
    ctx.beginPath(); ctx.ellipse(W*0.5,y,W*0.65,34,0,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;

  ctx.fillStyle='#3b1c14';
  const seed=((t/16)|0)%5;
  for(let i=0;i<70;i++){
    const x=(i*97+seed*19)%W;
    const y=(i*53+seed*37)%H;
    const r=1+((i*7)%3);
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}

/* ================== D√ú≈ûMAN OLU≈ûTURUCU ================== */
let spawnTimer=0;
function spawnEnemy(){
  // skor arttƒ±k√ßa spawn hƒ±zƒ± artar
  const roll = Math.random();
  if (roll < 0.45){
    enemies.push(makeEnemy('green'));
  } else if (roll < 0.85){
    enemies.push(makeEnemy('yellow'));
  } else {
    enemies.push(makeEnemy('white'));
  }
}
function makeEnemy(type){
  // ortak
  const x = rand(40, W-40), y = -40;
  const base = {type, x, y, vx:0, vy: rand(0.6, 1.2), w:40, h:40, fireT: rand(400,900), t:0, img:IMG[type], hp:1};
  if (type==='yellow'){ base.vx = Math.sin(rand(0,6.28))*0.8; base.color='#ffdd33'; }
  if (type==='green'){ base.vx = Math.sin(rand(0,6.28))*0.6; base.color='#55ff88'; }
  if (type==='white'){ base.vx = Math.sin(rand(0,6.28))*0.7; base.color='#ffffff'; base.hp=2; }
  return base;
}
function spawnBoss(){
  bossActive=true; bossSpawned=true;
  boss = {
    type:'boss', x:W/2, y:-120, w:120, h:120, vx:0, vy:0.6, dir:1,
    img:IMG.boss, hp:30, fireT: 0
  };
}

/* ================== G√ñRSELLERƒ∞ √áƒ∞Z ================== */
function drawEnemy(e){
  const im = e.img;
  if (!im.complete){ // placeholder
    ctx.fillStyle='#888'; ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h); return;
  }
  if (e.type==='white' && FLIP_WHITE){
    // beyaz gemi ters kaydedildiyse dikey √ßevir
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.scale(1,-1);
    ctx.drawImage(im, -e.w/2, -e.h/2, e.w, e.h);
    ctx.restore();
  } else {
    ctx.drawImage(im, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
  }
}
function drawBoss(b){
  const im=b.img;
  if (im.complete) ctx.drawImage(im, b.x-b.w/2, b.y-b.h/2, b.w, b.h);
  else { ctx.fillStyle='#0f5'; ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h); }
  // HP bar
  const w= W*0.72, x=(W-w)/2, y=10;
  ctx.fillStyle='#0a0'; ctx.fillRect(x, y, w, 8);
  ctx.fillStyle='#222'; ctx.fillRect(x + w*(b.hp/30), y, w*(1-b.hp/30), 8);
}

/* ================== ANA D√ñNG√ú ================== */
function loop(t){
  if(!running) return;
  const dt = Math.min(33, t-lastT); lastT=t;

  // arkaplan
  drawMarsBackground(t);

  // oyuncu hareket
  if(keys['ArrowLeft'])  player.x -= player.spd*dt/5;
  if(keys['ArrowRight']) player.x += player.spd*dt/5;
  player.x = clamp(player.x, 16, W-16);

  // oyuncu otomatik ate≈ü
  if ((player.fireCD-=dt)<=0){
    bullets.push({x:player.x, y:player.y-18, w:4, h:10, vy:-4.4, col:'#1effd5'});
    player.fireCD = 170;
  }

  // mermiler (oyuncu)
  for (let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y += b.vy*dt/16;
    // d√º≈üman √ßarpƒ±≈üma
    let hit=false;
    if(!bossActive){
      for (let j=enemies.length-1;j>=0;j--){
        const e=enemies[j];
        if (Math.abs(b.x-e.x) < (b.w+e.w)/2 && Math.abs(b.y-e.y) < (b.h+e.h)/2){
          hit=true; e.hp--; if(e.hp<=0){ enemies.splice(j,1); score+= (e.type==='white'?30:20); }
          break;
        }
      }
    } else if (boss && aabb(b,boss)){ hit=true; boss.hp--; score+=2; if(boss.hp<=0){ // level clear
        bossActive=false; boss=null;
        victory();
      }
    }
    if (hit || b.y<-20) bullets.splice(i,1);
  }

  // d√º≈üman spawn (boss yoksa)
  if(!bossActive){
    spawnTimer -= dt;
    if (spawnTimer<=0){
      spawnEnemy();
      spawnTimer = 500 - Math.min(350, score); // skor arttƒ±k√ßa daha sƒ±k
    }
  }

  // d√º≈üman g√ºncelle/√ßiz
  for (let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.t+=dt;
    e.x += e.vx*dt/24;
    e.y += e.vy*dt/14;

    // atƒ±≈ü
    e.fireT -= dt;
    if (e.fireT<=0){
      if (e.type==='white'){
        // saƒü/sol √ßift BEYAZ lazer
        ebullets.push({x:e.x-18,y:e.y+18,w:5,h:12,vy:2.6,col:'#ffffff'});
        ebullets.push({x:e.x+18,y:e.y+18,w:5,h:12,vy:2.6,col:'#ffffff'});
        e.fireT = 850;
      } else {
        // tek atƒ±≈ü
        ebullets.push({x:e.x,y:e.y+18,w:5,h:12,vy:2.2,col:(e.type==='green'?'#66ff66':'#ffd84a')});
        e.fireT = 900;
      }
    }

    // oyuncuya √ßarpƒ±≈üma
    if (aabb(e,player)){ enemies.splice(i,1); damage(); continue; }

    // ekran dƒ±≈üƒ±
    if (e.y > H+40){ enemies.splice(i,1); continue; }

    drawEnemy(e);
  }

  // Boss (spawn ko≈üulu: 500+ skor)
  if (!bossSpawned && score>=500){ spawnBoss(); }
  if (bossActive && boss){
    // sahneye giri≈ü
    if (boss.y < 120) boss.y += boss.vy*dt/14;
    else {
      // yanal hareket
      boss.x += boss.dir*1.3*dt/14;
      if (boss.x < 90) {boss.x=90; boss.dir=1;}
      if (boss.x > W-90){boss.x=W-90; boss.dir=-1;}
      // ate≈ü
      boss.fireT -= dt;
      if (boss.fireT<=0){
        // √º√ßl√º YE≈ûƒ∞L lazer
        ebullets.push({x:boss.x,   y:boss.y+boss.h/2-10, w:6,h:14,vy:3,col:'#53ff6a'});
        ebullets.push({x:boss.x-28,y:boss.y+boss.h/2,   w:6,h:14,vy:3,col:'#53ff6a'});
        ebullets.push({x:boss.x+28,y:boss.y+boss.h/2,   w:6,h:14,vy:3,col:'#53ff6a'});
        boss.fireT = 420;
      }
    }
    // √ßarpƒ±≈üma
    if (aabb(boss, player)) damage();

    drawBoss(boss);
  }

  // d√º≈üman mermileri
  for (let i=ebullets.length-1;i>=0;i--){
    const b=ebullets[i]; b.y += b.vy*dt/16;
    if (b.y>H+20){ ebullets.splice(i,1); continue; }
    if (Math.abs(b.x-player.x) < (b.w+player.w)/2 && Math.abs(b.y-player.y) < (b.h+player.h)/2){
      ebullets.splice(i,1); damage(); continue;
    }
    ctx.fillStyle=b.col; ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h);
  }

  // oyuncu √ßiz
  ctx.fillStyle='#1effd5';
  ctx.beginPath();
  ctx.moveTo(player.x, player.y-14);
  ctx.lineTo(player.x-14, player.y+14);
  ctx.lineTo(player.x+14, player.y+14);
  ctx.closePath(); ctx.fill();

  // HUD
  scoreEl.textContent = `SCORE: ${score|0}`;

  requestAnimationFrame(loop);
}

/* ================== HASAR & SONU√á ================== */
function damage(){
  lives--;
  livesEl.textContent = '‚ù§Ô∏è'.repeat(lives>0?lives:0);
  if (lives<=0){ gameOver(); }
}
function gameOver(){
  running=false;
  msgText.textContent = 'GAME OVER';
  msg.style.display='flex';
}
function victory(){
  running=false;
  msgText.textContent = 'LEVEL 2 CLEARED!';
  msg.style.display='flex';
}

/* ================== BA≈ûLANGI√á ================== */
startGame(); // otomatik ba≈ülat
</script>
</body>
</html>
