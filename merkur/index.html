<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>BPC Space ‚Äî Mars (Level 2)</title>
<style>
  :root{ --w:420; --h:740; }
  html,body{margin:0;background:#000;color:#cfe6ff;font-family:system-ui,Segoe UI,Roboto,Arial}
  #topbar{
    position:fixed;left:0;top:0;right:0;height:58px;display:flex;align-items:center;
    gap:14px;padding:8px 12px;background:rgba(10,15,25,.9);backdrop-filter:blur(4px);
    box-shadow:0 2px 0 rgba(0,0,0,.4); z-index:10;
  }
  #brand{font-weight:800;font-size:28px;letter-spacing:.5px;color:#7fb0ff; display:flex;align-items:center;gap:8px}
  #hud{margin-left:auto;display:flex;align-items:center;gap:18px;font-size:26px;font-weight:700}
  #hearts{display:flex;gap:8px}
  .heart{width:22px;height:22px;background:#c30000;border-radius:50%;
         box-shadow:0 0 0 4px #ff4d4d inset, 0 0 10px #ff4d4d;}
  #wrap{padding-top:58px; display:flex; justify-content:center;}
  canvas{display:block; background:#081b23; image-rendering:pixelated;}
  /* Mobilde geni≈üliƒüi doldur, oranƒ± koru */
  canvas{ width:100vw; height:calc(100vw * var(--h) / var(--w)); max-height:calc(100dvh - 58px);}
  /* Start overlay (gerekirse) */
  #start{
    position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.75);
    font-weight:800;z-index:20
  }
  #start button{
    padding:12px 20px;border:0;border-radius:14px;background:#00c2b7;color:#001b20;
    font-weight:900;font-size:18px;box-shadow:0 6px 20px rgba(0,194,183,.25)
  }
</style>
</head>
<body>
  <div id="topbar">
    <div id="brand">Babypeacock ü¶ö</div>
    <div style="font-weight:800;">Mars (Level 2)</div>
    <div id="hud">
      <span>Score: <span id="score">0</span></span>
      <div id="hearts"></div>
    </div>
  </div>

  <div id="wrap">
    <canvas id="game" width="420" height="740"></canvas>
  </div>

  <!-- ƒ∞stersen kapat: ƒ∞lk a√ßƒ±lƒ±≈üta START -->
  <div id="start"><button id="startBtn">START</button></div>

<script>
/* ========= KURULUM ========= */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d', { alpha:true });
ctx.imageSmoothingEnabled = false;

const W = cvs.width, H = cvs.height;
const scoreEl = document.getElementById('score');
const heartsEl = document.getElementById('hearts');
const startEl = document.getElementById('start');
const startBtn = document.getElementById('startBtn');

/* ========= STATE ========= */
let running = false, lastT = 0, score = 0;
let lives = 3;
let bullets = [], enemies = [], enemyBullets = [], diamonds = [];
let spawnTimer = 0, diamondTimer = 0;

/* ========= ASSETS ========= */
// Yol notu: merkur/ klas√∂r√ºnden k√∂k dizindeki g√∂rsellere ../ ile gidiyoruz
const ASSETS = {
  player: '../img/player/bpc_mini.png',
  enemy_green: '../mars_enemy_green.png',
  enemy_yellow: '../mars_enemy_yellow.png',
  enemy_white: '../mars_enemy_white.png', // ters √ßevrilecek
  enemy_red: '../mars_enemy_red.png'
};
const IMG = {};
const PROC = {}; // arka planƒ± temizlenmi≈ü img cache

function loadImage(src){ return new Promise(res=>{ const i=new Image(); i.src=src; i.onload=()=>res(i); }); }
function near(a,b,t){ return Math.abs(a-b)<=t; }

/* Beyaz & siyah arka planƒ± ≈üeffaf yap (chroma key) */
function stripBgToAlpha(img,{whiteTol=18, blackTol=8}={}){
  const key = img.src + `|w${whiteTol}|b${blackTol}`;
  if (PROC[key]) return PROC[key];

  const off = document.createElement('canvas');
  off.width = img.width; off.height = img.height;
  const octx = off.getContext('2d', {willReadFrequently:true});
  octx.drawImage(img,0,0);
  const d = octx.getImageData(0,0,off.width,off.height);
  const px = d.data;
  for (let i=0;i<px.length;i+=4){
    const r=px[i], g=px[i+1], b=px[i+2], a=px[i+3];
    // beyaz veya siyah yakƒ±nlarƒ±nƒ± alpha=0 yap
    const isWhite = (r>255-whiteTol && g>255-whiteTol && b>255-whiteTol);
    const isBlack = (r<blackTol && g<blackTol && b<blackTol);
    if ((isWhite || isBlack) && a>0){ px[i+3]=0; }
  }
  octx.putImageData(d,0,0);
  const out = new Image(); out.src = off.toDataURL();
  PROC[key]=out; return out;
}

/* ========= PLAYER ========= */
const player = {
  x: W/2, y: H-120, w: 52, h: 52,
  fireCd: 0, fireRate: 220, speed: 0.24,
};

function drawPlayer(){
  const img = IMG.player? stripBgToAlpha(IMG.player): null;
  if (img) ctx.drawImage(img, player.x-player.w/2, player.y-player.h/2, player.w, player.h);
  else { // yedek √º√ßgen
    ctx.fillStyle='#26e0ff';
    ctx.beginPath();
    ctx.moveTo(player.x, player.y-20);
    ctx.lineTo(player.x-16, player.y+18);
    ctx.lineTo(player.x+16, player.y+18);
    ctx.closePath(); ctx.fill();
  }
}

function shoot(){
  bullets.push({x:player.x, y:player.y-28, vy:-520});
}

/* ========= ENEMIES ========= */
const ENEMY_TYPES = [
  { key:'green',  img:'enemy_green',  w:56, h:56, vy: 90 },
  { key:'yellow', img:'enemy_yellow', w:56, h:56, vy: 110 },
  { key:'white',  img:'enemy_white',  w:60, h:60, vy: 120, flipV:true }, // ters
  { key:'red',    img:'enemy_red',    w:58, h:58, vy: 130 },
];

function spawnEnemy(){
  const t = ENEMY_TYPES[(Math.random()*ENEMY_TYPES.length)|0];
  enemies.push({
    type: t, x: 30 + Math.random()*(W-60), y: -70, w:t.w, h:t.h, vy:t.vy
  });
}

/* ========= DIAMOND (3'l√º atƒ±≈ü buff) ========= */
function spawnDiamond(){
  diamonds.push({x: 20+Math.random()*(W-40), y:-30, vy:80, r:16, t:15000});
}

/* ========= INPUT ========= */
const keys = {};
addEventListener('keydown', (e)=>{ keys[e.key]=true; });
addEventListener('keyup',   (e)=>{ keys[e.key]=false; });

/* Touch/Mouse s√ºr√ºkle */
let rect = cvs.getBoundingClientRect();
addEventListener('resize', ()=>{ rect = cvs.getBoundingClientRect(); });
cvs.addEventListener('touchmove', (e)=>{
  const t = e.touches[0]; const rx = (t.clientX-rect.left)/rect.width;
  player.x = Math.max(28, Math.min(W-28, rx*W));
  e.preventDefault();
},{passive:false});
cvs.addEventListener('mousemove', (e)=>{
  const rx = (e.clientX-rect.left)/rect.width;
  if (rx>=0 && rx<=1) player.x = Math.max(28, Math.min(W-28, rx*W));
});

/* ========= HUD ========= */
function drawHearts(){
  heartsEl.innerHTML='';
  for(let i=0;i<lives;i++){
    const d=document.createElement('div'); d.className='heart';
    heartsEl.appendChild(d);
  }
}
drawHearts();

/* ========= MARS ARKA PLAN ========= */
let bgScroll = 0;
function drawMars(dt){
  bgScroll += dt*40; if(bgScroll>H) bgScroll-=H;

  // taban kum
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#6e2e20'); g.addColorStop(.5,'#7a3323'); g.addColorStop(1,'#5b2418');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // yumu≈üak dalga katmanlarƒ± (√ßizgisiz g√∂r√ºns√ºn diye d√º≈ü√ºk kontrast)
  ctx.strokeStyle='rgba(255,195,130,.12)'; ctx.lineWidth=3;
  for(let i=0;i<6;i++){
    const y=((i*140+bgScroll)% (H+140))-70;
    ctx.beginPath();
    const amp=18, step=W/5;
    ctx.moveTo(0,y);
    for(let x=0;x<=W;x+=step){
      const yy=y + Math.sin((x*0.01)+i)*amp;
      ctx.lineTo(x,yy);
    }
    ctx.stroke();
  }
  // ta≈ü taneleri
  ctx.fillStyle='rgba(0,0,0,.35)';
  for(let i=0;i<80;i++){
    const x = (i*53 + (bgScroll*0.7))%W;
    const y = (i*97 + (bgScroll*1.2))%H;
    ctx.fillRect(x,y,2,2);
  }
}

/* ========= GAME LOOP ========= */
function reset(){
  running=true; lastT=0; score=0; lives=3; drawHearts();
  bullets=[]; enemies=[]; enemyBullets=[]; diamonds=[];
  spawnTimer=0; diamondTimer=4000; // 4 sn sonra ilk elmas
  scoreEl.textContent=score;
}
function endGame(){
  running=false;
  startEl.style.display='grid';
  startBtn.textContent='RETRY';
}

function loop(t){
  if(!running) return;
  const dt = Math.min(0.033, (t - (lastT||t))/1000); lastT=t;

  // Arka plan
  drawMars(dt);

  // Oyuncu hareket + ate≈ü
  if(keys['ArrowLeft'])  player.x-= player.speed*dt*W;
  if(keys['ArrowRight']) player.x+= player.speed*dt*W;
  player.x=Math.max(26, Math.min(W-26, player.x));

  player.fireCd -= dt*1000;
  if (player.fireCd<=0){ shoot(); player.fireCd=player.fireRate; }
  bullets = bullets.filter(b=> (b.y += b.vy*dt) > -30);
  // Bullets draw
  ctx.fillStyle='#7fd8ff';
  bullets.forEach(b=>{ ctx.fillRect(b.x-3, b.y-12, 6, 12); });

  // Spawn
  spawnTimer -= dt*1000; if(spawnTimer<=0){ spawnEnemy(); spawnTimer = 800; }
  diamondTimer -= dt*1000; if(diamondTimer<=0){ spawnDiamond(); diamondTimer=12000; }

  // Enemies
  enemies = enemies.filter(e=>{
    e.y += e.vy*dt;
    // √áizim
    const raw = IMG[ e.type.img ];
    let img = raw ? stripBgToAlpha(raw) : null;

    if (img){
      if (e.type.flipV){
        // ters √ßevir (white)
        ctx.save();
        ctx.translate(e.x, e.y);
        ctx.scale(1,-1);
        ctx.drawImage(img, -e.w/2, -e.h/2, e.w, e.h);
        ctx.restore();
      }else{
        ctx.drawImage(img, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
      }
    }else{
      ctx.fillStyle='#9cff57'; ctx.fillRect(e.x-18,e.y-18,36,36);
    }

    // √áarpƒ±≈üma: player kur≈üunlarƒ±
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i];
      if (Math.abs(b.x-e.x)<(e.w*0.45) && Math.abs(b.y-e.y)<(e.h*0.45)){
        bullets.splice(i,1);
        score += 1; // puanlarƒ± deƒüi≈ütirmedik
        scoreEl.textContent=score;
        return false; // d√º≈ümanƒ± sil
      }
    }
    // √áarpƒ±≈üma: oyuncu
    if (Math.abs(player.x-e.x)<(e.w*0.45) && Math.abs(player.y-e.y)<(e.h*0.45)){
      lives--; drawHearts();
      if(lives<=0){ endGame(); }
      return false;
    }

    return e.y < H+40;
  });

  // Diamonds
  diamonds = diamonds.filter(d=>{
    d.y += d.vy*dt;
    // √ßiz
    drawDiamond(d.x,d.y,16);
    // toplama
    if (Math.abs(player.x-d.x)<22 && Math.abs(player.y-d.y)<22){
      // 15 sn 3'l√º atƒ±≈ü
      tripleStart(15000);
      return false;
    }
    return d.y< H+30;
  });

  // Oyuncu
  drawPlayer();

  requestAnimationFrame(loop);
}

/* ========= DIAMOND √áƒ∞Zƒ∞M ========= */
function drawDiamond(x,y,r){
  ctx.save();
  ctx.translate(x,y);
  ctx.beginPath();
  ctx.moveTo(0,-r*0.8);
  ctx.lineTo(-r, -r*0.1);
  ctx.lineTo(0, r);
  ctx.lineTo(r, -r*0.1);
  ctx.closePath();
  ctx.fillStyle='rgba(0,240,255,.9)';
  ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=2; ctx.stroke();
  ctx.restore();
}

/* ========= 3'l√º atƒ±≈ü buff ========= */
let tripleUntil = 0;
const baseShoot = shoot;
function tripleStart(ms){
  tripleUntil = performance.now()+ms;
}
shoot = function(){
  const now = performance.now();
  if (now<tripleUntil){
    bullets.push({x:player.x-14,y:player.y-28,vy:-520});
    bullets.push({x:player.x    ,y:player.y-34,vy:-520});
    bullets.push({x:player.x+14,y:player.y-28,vy:-520});
  }else{
    bullets.push({x:player.x,y:player.y-28,vy:-520});
  }
}

/* ========= LOAD & START ========= */
Promise.all(Object.entries(ASSETS).map(async([k,src])=>{
  IMG[k] = await loadImage(src);
})).then(()=>{
  // Auto-start yerine butonla ba≈ülat
  startBtn.onclick = ()=>{
    startEl.style.display='none';
    reset();
    requestAnimationFrame(loop);
  };
});
</script>
</body>
</html>
