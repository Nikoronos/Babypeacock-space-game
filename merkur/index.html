<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Babypeacock ‚Äî Mars (Level 2)</title>
<style>
  :root{--hud:#0ae2b2;--ink:#cfe3ff;--bg:#09121c;}
  html,body{margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  #wrap{display:flex;flex-direction:column;min-height:100dvh;background:#000;}
  header{height:46px;display:flex;align-items:center;gap:10px;padding:8px 12px;background:#0b0f17;position:sticky;top:0;z-index:3}
  header .brand{font-weight:800;font-size:26px;letter-spacing:1px;color:#89aefc}
  header .dot{font-size:22px;margin-left:4px}
  header .stat{margin-left:auto;display:flex;gap:16px;align-items:center;font-weight:700}
  header .heart{filter:drop-shadow(0 0 4px #f00);font-size:24px}
  #stage{flex:1;display:flex;justify-content:center;align-items:center;background:#000}
  canvas{touch-action:none;background:#000;display:block;max-width:100vw;max-height:calc(100dvh - 46px)}
  #start,#over{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.72);z-index:4}
  .panel{background:#0b1219;border:1px solid #203046;padding:18px 20px;border-radius:14px;box-shadow:0 10px 38px rgba(0,0,0,.5);text-align:center}
  .panel h1{margin:4px 0 12px;font-size:22px}
  .btn{border:0;border-radius:12px;padding:12px 20px;background:#0ae2b2;color:#022;font-weight:900;font-size:16px;cursor:pointer}
  .hide{display:none}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand">Babypeacock <span class="dot">ü¶ö</span></div>
    <div id="lvl" class="stat">Mars (Level 2)</div>
    <div id="scoreHud" class="stat">Score: <span id="scoreTxt">0</span></div>
    <div id="livesHud" class="stat" aria-label="Lives">
      <span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span>
    </div>
  </header>

  <div id="stage"><canvas id="game" width="420" height="740"></canvas></div>

  <div id="start" class="">
    <div class="panel">
      <h1>Mars G√∂revi</h1>
      <p>Parmaƒüƒ±nƒ± s√ºr√ºkle ¬∑ Otomatik ate≈ü ¬∑ Elmas = 12s √º√ßl√º ate≈ü</p>
      <button class="btn" id="startBtn">BA≈ûLAT</button>
    </div>
  </div>

  <div id="over" class="hide">
    <div class="panel">
      <h1 id="overText">GAME OVER</h1>
      <button class="btn" id="retryBtn">TEKRAR</button>
    </div>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const scoreTxt = document.getElementById('scoreTxt');
  const startDlg = document.getElementById('start');
  const overDlg  = document.getElementById('over');
  const startBtn = document.getElementById('startBtn');
  const retryBtn = document.getElementById('retryBtn');
  const livesHud = document.getElementById('livesHud');

  // --- sizing (mobil tam ekran ve 9:16 civarƒ±) ---
  function fit() {
    const w = Math.min(480, window.innerWidth);
    const h = Math.min(window.innerHeight - 46, w * 16/9 + 140);
    cvs.width  = Math.floor(w);
    cvs.height = Math.floor(h);
  }
  fit();
  addEventListener('resize', fit);

  // --- assets (depolarƒ±nda zaten var) ---
  const SPRITES = {
    player: "img/player/bpc_mini.png",
    g: "mars_enemy_green.png",
    y: "mars_enemy_yellow.png",
    w: "mars_enemy_white.png",
    gem: "assets/diamond.png"
  };
  const imgs = {};
  function loadImage(key, src) {
    return new Promise((res,rej) => {
      const i = new Image();
      i.onload = () => { imgs[key]=i; res(); };
      i.onerror = rej;
      i.src = src;
    });
  }
  const toLoad = [
    loadImage('player', SPRITES.player),
    loadImage('g', SPRITES.g),
    loadImage('y', SPRITES.y),
    loadImage('w', SPRITES.w),
  ];
  // elmas g√∂rseli yoksa mavi √ßizgi ile √ßizeriz
  let gemLoaded=false;
  toLoad.push(loadImage('gem', SPRITES.gem).then(()=>gemLoaded=true).catch(()=>{}));

  // --- state ---
  let running=false, tPrev=0;
  let score=0, lives=3;
  let bullets=[], enemies=[], gems=[];
  let triple=false, tripleUntil=0;

  const player = { x: 0, y: 0, w: 42, h: 42, fireCd:0 };

  function reset() {
    score=0; scoreTxt.textContent='0';
    lives=3; renderLives();
    bullets.length=0; enemies.length=0; gems.length=0;
    player.w = Math.floor(cvs.width * 0.12);
    player.h = player.w;
    player.x = cvs.width/2 - player.w/2;
    player.y = cvs.height - player.h - 26;
    player.fireCd = 0;
    triple=false; tripleUntil=0;
    spawnTicker = 0; speedBase = 70;
  }

  function renderLives() {
    livesHud.innerHTML = '‚ù§Ô∏è'.repeat(lives).split('').map(h=>`<span class="heart">${h}</span>`).join('');
  }

  // --- input: parmak/maus s√ºr√ºkle ---
  let dragging=false;
  function toLocal(e){
    const r=cvs.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    return {x,y};
  }
  cvs.addEventListener('pointerdown', e=>{dragging=true; const p=toLocal(e); player.x = p.x - player.w/2; player.y = p.y - player.h/2;});
  addEventListener('pointerup',   ()=> dragging=false);
  addEventListener('pointercancel',()=> dragging=false);
  cvs.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const p = toLocal(e);
    player.x = p.x - player.w/2;
    player.y = p.y - player.h/2;
    clampPlayer();
  });

  function clampPlayer(){
    player.x = Math.max(2, Math.min(cvs.width - player.w - 2, player.x));
    player.y = Math.max(2, Math.min(cvs.height - player.h - 2, player.y));
  }

  // --- Mars arkaplanƒ± (kumsu/dots, kaydƒ±rmalƒ±) ---
  let bgOffset = 0;
  function drawMars(dt){
    bgOffset += dt * 40;
    const stripeH = 120;
    ctx.fillStyle = '#3a1810';
    ctx.fillRect(0,0,cvs.width,cvs.height);
    // hafif ton dalgalarƒ±
    for(let i=-1;i<=Math.ceil(cvs.height/stripeH)+1;i++){
      ctx.fillStyle = i%2? '#4a1f12' : '#421c12';
      const y = Math.floor((i*stripeH + (bgOffset % stripeH)));
      ctx.fillRect(0, y, cvs.width, stripeH*0.75);
    }
    // kum noktalarƒ±
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    for(let i=0;i<70;i++){
      const x = (i*53 % cvs.width);
      const y = ((i*97 + Math.floor(bgOffset*0.6)) % cvs.height);
      ctx.fillRect(x,y,1,1);
    }
  }

  // --- oyun akƒ±≈üƒ± ---
  let spawnTicker=0, speedBase=70;

  function spawnEnemy(){
    // dalgayƒ± skorla zorla≈ütƒ±r
    const pick = Math.random();
    let type='g';
    if (score>120 && pick<0.25) type='y';
    if (score>240 && pick<0.5)  type='w';

    const w = imgs[type].width  * 0.28;
    const h = imgs[type].height * 0.28;
    enemies.push({
      type, x: Math.random()*(cvs.width - w), y: -h-10,
      w, h,
      hp: (type==='g'?1:(type==='y'?2:2)),
      vy: (type==='g'? 90 : type==='y' ? 120 : 140) + (score*0.15)
    });
  }

  function spawnGem(){
    if(Math.random()<0.22){
      gems.push({x: Math.random()*(cvs.width-22), y:-28, vy: 95, r: 10});
    }
  }

  function fire(){
    if(player.fireCd>0) return;
    player.fireCd = 140; // ms
    const midx = player.x + player.w/2;
    const y    = player.y - 6;
    bullets.push({x:midx, y, vy:-320});
    if(triple){
      bullets.push({x:midx-12, y, vy:-320});
      bullets.push({x:midx+12, y, vy:-320});
    }
  }

  // --- √ßarpƒ±≈üma ---
  function hit(a,b){
    return a.x<b.x+b.w && a.x+ (a.w||4) > b.x && a.y<b.y+b.h && a.y+(a.h||8)>b.y;
  }

  function loseLife(){
    lives--;
    renderLives();
    if(lives<=0){
      running=false;
      document.getElementById('overText').textContent='GAME OVER';
      overDlg.classList.remove('hide');
    }
  }

  // --- d√∂ng√º ---
  function loop(ts){
    if(!running) return;
    const dt = Math.min(32, (ts - tPrev)) / 1000;
    tPrev = ts;

    // arkaplan
    drawMars(dt);

    // oyuncu
    player.fireCd = Math.max(0, player.fireCd - dt*1000);
    fire(); // auto-fire
    clampPlayer();

    // mermi g√ºncelle/√ßiz
    ctx.fillStyle = '#7fd9ff';
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i];
      b.y += b.vy * dt;
      if(b.y<-16){ bullets.splice(i,1); continue; }
      ctx.fillRect(b.x-2, b.y-10, 4, 10);
    }

    // d√º≈üman √ºret
    spawnTicker -= dt;
    if(spawnTicker<=0){
      spawnEnemy();
      if(Math.random()<0.4) spawnEnemy();
      if(Math.random()<0.25) spawnGem();
      const step = Math.max(0.35, 1.0 - Math.min(0.6, score/600));
      spawnTicker = 0.45 * step;
    }

    // d√º≈üman g√ºncelle/√ßiz
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      e.y += e.vy * dt;

      // √ßizim (white ters √ßevrilir)
      if(e.type==='w'){
        ctx.save();
        ctx.translate(e.x+e.w/2, e.y+e.h/2);
        ctx.scale(-1,1);
        ctx.drawImage(imgs[e.type], -e.w/2, -e.h/2, e.w, e.h);
        ctx.restore();
      }else{
        ctx.drawImage(imgs[e.type], e.x, e.y, e.w, e.h);
      }

      // mermi ile √ßarpƒ±≈üma
      for(let k=bullets.length-1;k>=0;k--){
        const b=bullets[k];
        if(hit({x:b.x-2,y:b.y-10,w:4,h:10}, e)){
          bullets.splice(k,1);
          e.hp--;
          // patlama partik√ºl k√º√ß√ºk
          ctx.fillStyle = (e.type==='g')?'#6cff6c':(e.type==='y')?'#ffd84d':'#ffffff';
          for(let p=0;p<6;p++){
            ctx.fillRect(e.x + e.w/2 + (Math.random()*12-6), e.y + e.h/2 + (Math.random()*12-6), 2, 2);
          }
          if(e.hp<=0){
            // skor
            score += (e.type==='g'?2:(e.type==='y'?3:3));
            scoreTxt.textContent = score;
            enemies.splice(i,1);
          }
          break;
        }
      }

      // oyuncuya √ßarpma
      if(hit({x:player.x,y:player.y,w:player.w,h:player.h}, e)){
        enemies.splice(i,1);
        loseLife();
      }

      // ekran dƒ±≈üƒ±
      if(e.y > cvs.height+30) enemies.splice(i,1);
    }

    // elmas power-up
    for(let i=gems.length-1;i>=0;i--){
      const g = gems[i];
      g.y += g.vy * dt;
      if(gemLoaded){
        const s = 22;
        ctx.drawImage(imgs.gem, g.x, g.y, s, s);
      }else{
        ctx.fillStyle = '#5de0ff';
        ctx.beginPath(); ctx.moveTo(g.x+10,g.y); ctx.lineTo(g.x+20,g.y+10); ctx.lineTo(g.x+10,g.y+20); ctx.lineTo(g.x,g.y+10); ctx.closePath(); ctx.fill();
      }
      if(hit({x:g.x,y:g.y,w:24,h:24}, {x:player.x,y:player.y,w:player.w,h:player.h})){
        gems.splice(i,1);
        triple=true; tripleUntil = performance.now()+12000;
      }
      if(g.y>cvs.height+30) gems.splice(i,1);
    }
    if(triple && performance.now()>tripleUntil) triple=false;

    // oyuncuyu √ßiz
    ctx.drawImage(imgs.player, player.x, player.y, player.w, player.h);

    requestAnimationFrame(loop);
  }

  // --- start / retry ---
  Promise.all(toLoad).then(()=>{
    startBtn.onclick = () => {
      startDlg.classList.add('hide');
      reset();
      running=true; tPrev=performance.now(); requestAnimationFrame(loop);
    };
    retryBtn.onclick = () => {
      overDlg.classList.add('hide');
      reset();
      running=true; tPrev=performance.now(); requestAnimationFrame(loop);
    };
  }).catch(()=>{
    startBtn.disabled=true;
    startBtn.textContent='G√∂rseller y√ºklenemedi (dosya adlarƒ±nƒ± kontrol et)';
  });
})();
</script>
</body>
</html>
