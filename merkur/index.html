<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BPC Space – Level 2 (Merkür)</title>
<style>
  html,body{margin:0;background:#001a1f;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  #wrap{display:flex;min-height:100dvh;align-items:center;justify-content:center}
  #game{background:#002b33;touch-action:none}
  #hud,#over,#start{position:fixed;left:0;right:0;display:flex;justify-content:center}
  #hud{top:8px;gap:14px;align-items:center}
  #start{top:0;bottom:0;align-items:center;background:rgba(0,0,0,.6)}
  #over{top:0;bottom:0;align-items:center;background:rgba(0,0,0,.6);display:none}
  button{background:#00e6ff;border:0;color:#00222a;padding:10px 18px;border-radius:12px;font-weight:700}
  #score{background:#003b49;padding:6px 10px;border-radius:10px}
  #bossbar{position:fixed;left:60px;right:60px;top:10px;height:12px;background:#11353a;border-radius:8px;display:none}
  #bossfill{height:100%;width:0;background:#26d07c;border-radius:8px}
</style>
</head>
<body>
<div id="hud">
  <span id="score">SCORE: 0</span>
</div>
<div id="bossbar"><div id="bossfill"></div></div>

<div id="wrap">
  <canvas id="game" width="420" height="740"></canvas>
</div>

<div id="start">
  <div style="text-align:center">
    <h2>BPC Space – Level 2</h2>
    <p>Yellow/Green tek atar • White çift atar • Boss: Bigger Green</p>
    <button id="startBtn">START</button>
  </div>
</div>

<div id="over">
  <div style="text-align:center">
    <h2 style="margin-bottom:16px">GAME OVER</h2>
    <button id="retryBtn">RETRY</button>
  </div>
</div>

<!-- Firebase sayaç & ülke logunu çağıran senin dosyan -->
<script src="../Js/fribase.js"></script>
<script>
/* ========= Temel kurulum ========= */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d', { alpha:false });
ctx.imageSmoothingEnabled = false;

const startUI = document.getElementById('start');
const overUI  = document.getElementById('over');
const startBtn= document.getElementById('startBtn');
const retryBtn= document.getElementById('retryBtn');
const scoreEl = document.getElementById('score');
const bossbar = document.getElementById('bossbar');
const bossfill= document.getElementById('bossfill');

let running=false, last=0, score=0, lives=3;
let bullets=[], eBullets=[], enemies=[];
let boss=null, bossActive=false;

/* ========= Varlıklar ========= */
function loadImg(p){ const i=new Image(); i.src=p; return i; }

const IMG = {
  player: loadImg('../img/player/peacock_gemisi.png'), // sende nasıl’sa düzelt
  yellow: loadImg('./mars enemy yellow.png'),
  green:  loadImg('./mars enemy green.png'),
  white:  loadImg('./mars enemy white.png'),
  boss:   loadImg('./mars enemy bigger green.png')
};

const SFX = { }; // istersen ekleriz

const player = { x:210, y:640, w:44, h:44, vx:0, speed:3, fireCD:0 };

/* ========= Girdi ========= */
const keys={};
addEventListener('keydown',e=>keys[e.key]=true);
addEventListener('keyup',e=>keys[e.key]=false);
cvs.addEventListener('mousemove',e=>{
  const r=cvs.getBoundingClientRect();
  player.x = Math.max(22, Math.min(cvs.width-22, e.clientX - r.left));
});

/* ========= Yardımcılar ========= */
function rect(a,b){
  return !(a.x+a.w<b.x || b.x+b.w<a.x || a.y+a.h<b.y || b.y+b.h<a.y);
}
function shoot(x,y,vy= -6,color='#ffd24a'){ bullets.push({x,y,w:4,h:10,vy,color}); }
function eShoot(x,y,vy= 5,color='#ff3b3b',w=4,h=10){ eBullets.push({x,y,w,h,vy,color}); }
function drawLaser(b){
  ctx.fillStyle=b.color; ctx.fillRect(b.x- b.w/2, b.y, b.w, b.h);
}

/* ========= Düşman oluşturma ========= */
const SPAWN_SCORE_BOSS = 500;

function spawnEnemy(){
  if (bossActive || score>=SPAWN_SCORE_BOSS) return;
  const types = ['yellow','green','white'];
  const t = types[Math.floor(Math.random()*types.length)];
  const x = 40 + Math.random()*(cvs.width-80);
  const base = { x, y:-50, w:64, h:64, t, hp: (t==='white'?3:2), fireT:0, t0:performance.now() };
  enemies.push(base);
}

function drawFlipped(img, x,y,w,h){ // white’ı ters çizmek için
  ctx.save(); ctx.translate(x+w, y); ctx.scale(-1,1);
  ctx.drawImage(img,0,0,img.width,img.height,x, y, w, h);
  ctx.restore();
}

/* ========= Boss ========= */
function spawnBoss(){
  bossActive=true;
  bossbar.style.display='block';
  boss = { x:cvs.width/2-80, y:-120, w:160, h:160, hp:30, dir:1, fireT:0 };
}

/* ========= Oyun Akışı ========= */
function startGame(){
  if(running) return;
  score=0; lives=3;
  bullets.length=0; eBullets.length=0; enemies.length=0;
  boss=null; bossActive=false; bossbar.style.display='none'; bossfill.style.width='0%';
  startUI.style.display='none'; overUI.style.display='none';
  running=true; last=performance.now();

  // Firebase sayaç + ülke
  try{ if(window.BPC_incrementOnStart) window.BPC_incrementOnStart(); }catch(_){}
  try{ if(window.BPC_logCountryOnStart) window.BPC_logCountryOnStart(); }catch(_){}

  requestAnimationFrame(loop);
}
function endGame(){
  running=false; overUI.style.display='flex';
}

/* ========= Döngü ========= */
function loop(t){
  if(!running) return;
  const dt = Math.min(32, t-last); last=t;

  // arka plan
  ctx.fillStyle='#082a31'; ctx.fillRect(0,0,cvs.width,cvs.height);
  for(let i=0;i<18;i++){ ctx.fillStyle=`rgba(255,255,255,${0.05+0.05*Math.random()})`; ctx.fillRect((i*33)%cvs.width,(t*0.03+i*17)%cvs.height,2,2); }

  // oyuncu kontrol
  if(keys['ArrowLeft'])  player.x-=player.speed;
  if(keys['ArrowRight']) player.x+=player.speed;
  player.x=Math.max(22,Math.min(cvs.width-22,player.x));

  // otomatik ateş
  player.fireCD-=dt; if(player.fireCD<=0){ shoot(player.x, player.y-18); player.fireCD=140; }

  // mermiler
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y+=b.vy;
    drawLaser(b);
    if(b.y<-20) bullets.splice(i,1);
  }

  // spawn
  if(!bossActive && score<SPAWN_SCORE_BOSS && Math.random()<0.02) spawnEnemy();
  if(!bossActive && score>=SPAWN_SCORE_BOSS && enemies.length===0) spawnBoss();

  // düşmanlar
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    // hareket
    const tt=(t-e.t0)*0.003;
    e.x += Math.sin(tt*1.1)*0.6;
    e.y += (e.t==='white'?1.2:1.6);

    // çizim & atış
    if(e.t==='white'){
      // sprite ters (horizontal flip)
      drawFlipped(IMG.white, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
      e.fireT+=dt;
      if(e.fireT>900){
        // iki beyaz lazer (sağ/sol)
        eShoot(e.x-28, e.y+24, 5, '#e8f2ff', 4,12);
        eShoot(e.x+28, e.y+24, 5, '#e8f2ff', 4,12);
        e.fireT=0;
      }
    }else{
      const img = (e.t==='yellow')?IMG.yellow:IMG.green;
      ctx.drawImage(img, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
      e.fireT+=dt;
      if(e.fireT>1100){
        eShoot(e.x, e.y+24, 5, '#ff3b3b', 4,12);
        e.fireT=0;
      }
    }

    // vurulma
    for(let k=bullets.length-1;k>=0;k--){
      const b=bullets[k];
      if(rect({x:b.x-2,y:b.y,w:b.w,h:b.h},{x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
        bullets.splice(k,1);
        if(--e.hp<=0){ enemies.splice(i,1); score+=10; }
        break;
      }
    }

    // ekran dışı
    if(e.y>cvs.height+60){ enemies.splice(i,1); }
  }

  // boss
  if(bossActive && boss){
    if(boss.y<110) boss.y+=1;  // sahneye giriş
    boss.x+=0.9*boss.dir;
    if(boss.x<70 || boss.x>cvs.width-70) boss.dir*=-1;

    // çiz
    ctx.drawImage(IMG.boss, boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h);

    // atış (yeşil lazer)
    boss.fireT+=dt;
    if(boss.fireT>550){
      eShoot(boss.x-28, boss.y+40, 6, '#00ff85', 5,14);
      eShoot(boss.x+28, boss.y+40, 6, '#00ff85', 5,14);
      boss.fireT=0;
    }

    // vurulma
    for(let k=bullets.length-1;k>=0;k--){
      const b=bullets[k];
      if(rect({x:b.x-2,y:b.y,w:b.w,h:b.h},{x:boss.x-boss.w/2,y:boss.y-boss.h/2,w:boss.w,h:boss.h})){
        bullets.splice(k,1);
        boss.hp--;
        const p = Math.max(0, Math.min(1, boss.hp/30));
        bossfill.style.width = (p*100)+'%';
        if(boss.hp<=0){
          // Level clear → (istersen sonraki sayfaya yönlendir)
          running=false;
          bossfill.style.width='0%';
          location.href = '../index.html'; // veya tebrik ekranı
          return;
        }
      }
    }
  }

  // düşman mermileri
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i]; b.y+=b.vy;
    drawLaser(b);
    if(b.y>cvs.height+20) { eBullets.splice(i,1); continue; }
    if(rect({x:b.x-2,y:b.y,w:b.w,h:b.h},{x:player.x-14,y:player.y-18,w:28,h:28})){
      eBullets.splice(i,1);
      if(--lives<=0){ endGame(); return; }
    }
  }

  // oyuncu çiz
  ctx.drawImage(IMG.player, player.x-22, player.y-22, 44, 44);

  // skor
  scoreEl.textContent = 'SCORE: ' + score;

  requestAnimationFrame(loop);
}

/* ========= UI ========= */
startBtn.onclick = startGame;
retryBtn.onclick = ()=>{ startUI.style.display='flex'; overUI.style.display='none'; };

</script>
</body>
</html>
