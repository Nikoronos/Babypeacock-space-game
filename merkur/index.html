<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BPC Space â€” Mars (Level 2)</title>
<style>
  :root{
    --hud-bg: rgba(5,10,20,.85);
    --hud-fg: #cfe8ff;
    --accent: #10b981;
  }
  html,body{margin:0;height:100%;background:#000;touch-action:none;font-family:system-ui,Segoe UI,Roboto,Arial}
  #wrap{position:fixed;inset:0;display:grid;place-items:center}
  canvas{background:#1a1f29;border-radius:16px;image-rendering:pixelated}
  /* HUD */
  .hud{position:fixed;left:0;right:0;top:0;display:flex;align-items:center;gap:12px;
       padding:8px 12px;background:var(--hud-bg);backdrop-filter:blur(6px)}
  .title{color:#8fb4ff;font-weight:800;font-size:22px;letter-spacing:.5px}
  .pill{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--hud-fg);font-weight:700}
  .hearts{display:flex;gap:6px}
  .heart{width:20px;height:20px;background:radial-gradient(circle at 30% 30%,#ff6aa3,#ff1f55);
         clip-path: polygon(50% 85%, 12% 52%, 12% 30%, 28% 18%, 50% 32%, 72% 18%, 88% 30%, 88% 52%);}
  /* Overlays */
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.7);z-index:10}
  .card{width:min(560px,90vw);background:#0b1220;color:#e7f2ff;border:1px solid #1e293b;
        border-radius:24px;padding:20px 18px;box-shadow:0 10px 40px rgba(0,0,0,.45);text-align:center}
  .card h1{margin:6px 0 10px 0;font-size:26px}
  .card p{opacity:.85;margin:6px 0 14px 0}
  .btn{display:inline-block;background:var(--accent);color:#00160e;border:none;font-weight:800;
       padding:12px 18px;border-radius:14px;cursor:pointer}
  .tips{font-size:12px;opacity:.7;margin-top:8px}
  /* letterbox */
  .bars{position:fixed;inset:0;pointer-events:none}
  .bar{position:absolute;background:#000}
  .bar.h{height:100%;width:calc((100vw - min(100vh*9/16,100vw))/2);top:0}
  .bar.h.left{left:0} .bar.h.right{right:0}
</style>
</head>
<body>
  <!-- HUD -->
  <div class="hud">
    <div class="title">Babypeacock ðŸ¦š</div>
    <div class="pill">Mars (Level 2)</div>
    <div class="pill">Score: <span id="scoreEl">0</span></div>
    <div class="pill">âŸ¡ <span id="gemTimer">0s</span></div>
    <div class="hearts" id="hearts"></div>
  </div>

  <div id="wrap"><canvas id="cv" width="360" height="640"></canvas></div>
  <div class="bars"><div class="bar h left"></div><div class="bar h right"></div></div>

  <!-- START -->
  <div id="startOverlay" class="overlay">
    <div class="card">
      <h1>Mars GÃ¶revi</h1>
      <p>Gemini <b>saÄŸa/sola sÃ¼rÃ¼kle</b> Â· Otomatik <b>ateÅŸ</b> Â· Elmas = <b>3â€™lÃ¼ yayÄ±lÄ±m</b> (12s)</p>
      <button class="btn" onclick="startGame()">BAÅžLA</button>
      <div class="tips">BÃ¼yÃ¼k ekran uyumu: 9:16 gÃ¶rÃ¼ntÃ¼, yanlarda siyah bar.</div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="overOverlay" class="overlay" style="display:none">
    <div class="card">
      <h1 id="overTitle">GAME OVER</h1>
      <p id="overDesc">Skorun: <b id="finalScore">0</b></p>
      <button class="btn" onclick="restart()">TEKRAR</button>
    </div>
  </div>

<script>
/* ===== CANVAS & WORLD ===== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const W_BASE = 360, H_BASE = 640;        // TasarÄ±m Ã¶lÃ§Ã¼sÃ¼ (9:16)
let W=W_BASE, H=H_BASE;

/* letterbox: canvasa 9:16 Ã¶lÃ§ek uygula */
function fit(){
  const vw = innerWidth, vh = innerHeight;
  const targetW = Math.min(vw, vh*9/16);
  const scale = targetW/W_BASE;
  W = W_BASE; H = H_BASE;
  cv.style.transform = `scale(${scale})`;
  cv.style.transformOrigin = 'top left';
  const left = (vw - targetW)/2;
  document.querySelector('.bar.h.left').style.width = left+'px';
  document.querySelector('.bar.h.right').style.width = left+'px';
}
addEventListener('resize', fit); fit();

/* ===== ASSETS ===== */
const img = src => { const i=new Image(); i.src=src; return i; };

const ASSETS = {
  player: img("../img/player/bpc_mini.png"),
  enemyGreen: img("../mars enemy green.png"),
  enemyYellow: img("../Mars enemy yellow.png"),
  enemyWhite: img("../mars enemy white.png"),     // ters Ã§izilecek
  enemyRed:   img("../mars enemy red .png"),      // dosya adÄ±nda boÅŸluk var!
  gem: img("../assets/diamond.png"),              // yoksa aÅŸaÄŸÄ±daki fallback Ã§izim kullanÄ±lÄ±r
};

/* ===== GAME STATE ===== */
let started=false, gameOver=false;
let last=0, t=0;
let score=0;
let lives=3;
let bullets=[], enemies=[], particles=[], gems=[];
let fireTimer=0, spawnTimer=0, gemTimer=0, tripleTimer=0;
const HUD = {
  scoreEl: document.getElementById('scoreEl'),
  hearts:  document.getElementById('hearts'),
  gemTimer:document.getElementById('gemTimer'),
  overTitle:document.getElementById('overTitle'),
  finalScore:document.getElementById('finalScore')
};
function setHearts(){
  HUD.hearts.innerHTML='';
  for(let i=0;i<lives;i++){ const d=document.createElement('div'); d.className='heart'; HUD.hearts.appendChild(d); }
}

/* ===== PLAYER ===== */
const player = {
  x: W/2, y: H-90, r:18, speed: 520, canFire:true
};
let touchId=null;
function toLocalX(globalX){
  const vw = innerWidth, vh = innerHeight;
  const targetW = Math.min(vw, vh*9/16);
  const left = (vw - targetW)/2;
  const scale = targetW/W_BASE;
  return (globalX - left)/scale;
}
addEventListener('pointerdown',e=>{
  if(!started) return;
  touchId=e.pointerId;
  player.x = Math.max(20, Math.min(W-20, toLocalX(e.clientX)));
});
addEventListener('pointermove',e=>{
  if(e.pointerId!==touchId||!started) return;
  player.x = Math.max(20, Math.min(W-20, toLocalX(e.clientX)));
});
addEventListener('pointerup',e=>{ if(e.pointerId===touchId) touchId=null; });

/* ===== HELPERS ===== */
const rnd = (a,b)=>a+Math.random()*(b-a);
function collide(a,b,rad){ const dx=a.x-b.x, dy=a.y-b.y; return (dx*dx+dy*dy) < rad*rad; }

function addParticles(x,y,color,count=10){
  for(let i=0;i<count;i++){
    particles.push({x,y, vx:rnd(-120,120), vy:rnd(-220,-60), life:rnd(.25,.6), color});
  }
}

/* ===== ENEMY SPAWN / DIFFICULTY ===== */
let difficulty=1; // zamanla artar
function spawnEnemy(){
  // kademeli olarak tip seÃ§
  const roll = Math.random()*100;
  let type='green';
  if(roll>70 && roll<=90) type='yellow';
  if(roll>90 && roll<=98) type='white';
  if(roll>98) type='red';
  const x = rnd(30, W-30), y = -40;
  const speed = rnd(80,120)+difficulty*8;
  const hp = (type==='green'?1:(type==='yellow'?2:(type==='white'?2:3)));
  enemies.push({type,x,y,speed,hp,shootTimer:0});
}
function enemyScore(type){
  return type==='green'?2 : type==='yellow'?3 : 3;
}
function enemyColor(type){
  return type==='green'?'#3bff6a' : type==='yellow'?'#ffd74a' : '#ffffff';
}

/* ===== GEMS ===== */
function spawnGem(x,y){
  gems.push({x,y, vy:120});
}

/* ===== DRAW ===== */
function drawMarsBG(){
  // yumuÅŸak Mars zemini + kÃ¼Ã§Ã¼k krater noktalarÄ±
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#4a201a'); g.addColorStop(1,'#6a2b1f');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(255,200,150,.25)';
  ctx.lineWidth=3;
  for(let i=0;i<6;i++){
    const y = (i*(H/6) + (t*20)% (H/6));
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  ctx.fillStyle='rgba(0,0,0,.35)';
  for(let i=0;i<120;i++){
    const x=(i*37.3)%W, y=(i*91.7 + (t*60))%H;
    ctx.fillRect(x,y,2,2);
  }
}
function drawImageCentered(im,x,y,w,h,flipX=false){
  if(!im || !im.complete) { // fallback
    ctx.fillStyle='#fff'; ctx.fillRect(x-w/2,y-h/2,w,h); return;
  }
  ctx.save();
  ctx.translate(x,y);
  if(flipX){ ctx.scale(-1,1); }
  ctx.drawImage(im,-w/2,-h/2,w,h);
  ctx.restore();
}

/* ===== LOOP ===== */
function update(dt){
  t += dt;
  difficulty += dt*0.08;

  // ateÅŸ
  fireTimer -= dt;
  const fireGap = tripleTimer>0 ? 0.12 : 0.18;
  if(fireTimer<=0){
    fireTimer = fireGap;
    if(tripleTimer>0){
      bullets.push({x:player.x-10,y:player.y-20,vy:-420});
      bullets.push({x:player.x,y:player.y-24,vy:-460});
      bullets.push({x:player.x+10,y:player.y-20,vy:-420});
    }else{
      bullets.push({x:player.x,y:player.y-24,vy:-460});
    }
  }

  // mermiler
  bullets.forEach(b=>b.y += b.vy*dt);
  bullets = bullets.filter(b=>b.y>-20);

  // dÃ¼ÅŸman Ã¼ret
  spawnTimer -= dt;
  if(spawnTimer<=0){
    spawnTimer = Math.max(.4, 1.2 - difficulty*0.08);
    spawnEnemy();
  }
  // dÃ¼ÅŸmanlar hareket/ateÅŸ
  enemies.forEach(e=>{
    e.y += e.speed*dt;
    // red kÄ±sa lazer
    if(e.type==='red'){
      e.shootTimer -= dt;
      if(e.shootTimer<=0){
        e.shootTimer = 0.9;
        // kÄ±sa lazer: 2 hÄ±zlÄ± mermi
        bullets.push({x:e.x-8,y:e.y+10,vy:260,enemy:true});
        bullets.push({x:e.x+8,y:e.y+10,vy:260,enemy:true});
      }
    }
  });
  enemies = enemies.filter(e=>e.y< H+40 && e.hp>0);

  // mermi Ã§arpÄ±ÅŸmalarÄ±
  bullets.forEach(b=>{
    if(b.enemy){ // dÃ¼ÅŸman mermisi oyuncuya
      if(collide(b,player,18)){ b.dead=true; hitPlayer(); }
      return;
    }
    enemies.forEach(e=>{
      if(e.hp>0 && collide(b,e,22)){ b.dead=true; e.hp--; 
        addParticles(e.x,e.y, enemyColor(e.type), 12);
        if(e.hp<=0){ score += enemyScore(e.type); spawnGem(e.x,e.y-6); }
      }
    });
  });
  bullets = bullets.filter(b=>!b.dead && b.y>-30 && b.y<H+30);

  // elmaslar
  gems.forEach(g=>{ g.y += g.vy*dt; if(collide(g,player,20)){ g.take=true; tripleTimer=12; }});
  gems = gems.filter(g=>g.y<H+30 && !g.take);

  // parÃ§acÄ±klar
  particles.forEach(p=>{ p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=420*dt;});
  particles = particles.filter(p=>p.life>0);

  // sÃ¼reler
  if(tripleTimer>0) tripleTimer-=dt;
  HUD.gemTimer.textContent = (tripleTimer>0 ? Math.ceil(tripleTimer)+'s' : '0s');
  HUD.scoreEl.textContent = score;
}

function hitPlayer(){
  if(gameOver) return;
  lives--; setHearts();
  addParticles(player.x,player.y,'#ff3b6a',30);
  if(lives<=0){ endGame(); }
}

function draw(){
  drawMarsBG();

  // oyuncu
  drawImageCentered(ASSETS.player, player.x, player.y, 46, 46);

  // mermiler
  bullets.forEach(b=>{
    ctx.fillStyle = b.enemy ? '#ff4444' : '#7dd3fc';
    ctx.fillRect(b.x-2, b.y-8, 4, 10);
  });

  // dÃ¼ÅŸmanlar
  enemies.forEach(e=>{
    const sz = 44;
    if(e.type==='green') drawImageCentered(ASSETS.enemyGreen, e.x, e.y, sz, sz);
    else if(e.type==='yellow') drawImageCentered(ASSETS.enemyYellow, e.x, e.y, sz, sz);
    else if(e.type==='white') drawImageCentered(ASSETS.enemyWhite, e.x, e.y, sz, sz, true); // ters
    else drawImageCentered(ASSETS.enemyRed, e.x, e.y, sz, sz);
  });

  // elmas
  gems.forEach(g=>{
    if(ASSETS.gem.complete) drawImageCentered(ASSETS.gem,g.x,g.y,26,26);
    else{ ctx.fillStyle='#8be9ff'; ctx.beginPath(); ctx.moveTo(g.x,g.y-10); ctx.lineTo(g.x+10,g.y); ctx.lineTo(g.x,g.y+10); ctx.lineTo(g.x-10,g.y); ctx.closePath(); ctx.fill(); }
  });

  // patlama parÃ§acÄ±klarÄ±
  particles.forEach(p=>{
    ctx.globalAlpha = Math.max(0,p.life*1.5);
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, 3, 3);
    ctx.globalAlpha = 1;
  });
}

function frame(ts){
  if(!started||gameOver) return;
  const dt = Math.min(0.033, (ts-last)/1000); last=ts;
  update(dt); draw();
  requestAnimationFrame(frame);
}

/* ===== GAME FLOW ===== */
function startGame(){
  document.getElementById('startOverlay').style.display='none';
  reset();
  started=true; gameOver=false; last=performance.now();
  requestAnimationFrame(frame);
}
function endGame(){
  gameOver=true;
  HUD.finalScore.textContent = score;
  HUD.overTitle.textContent = "GAME OVER";
  document.getElementById('overOverlay').style.display='grid';
}
function restart(){
  document.getElementById('overOverlay').style.display='none';
  startGame();
}
function reset(){
  score=0; lives=3; setHearts();
  bullets.length=0; enemies.length=0; particles.length=0; gems.length=0;
  difficulty=1; fireTimer=0; spawnTimer=0.5; tripleTimer=0; t=0;
  player.x=W/2; player.y=H-90;
}

/* ESC iÃ§in yeniden baÅŸlat (debug) */
addEventListener('keydown',e=>{ if(e.key==='r') restart(); });

</script>
</body>
</html>
