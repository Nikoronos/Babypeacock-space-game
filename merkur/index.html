<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Mars (Level 2) â€” Babypeacock</title>
<style>
  :root{--hud:#0b0e14;--hudTxt:#cfe8ff;}
  html,body{margin:0;padding:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  #hud{
    position:fixed;left:0;top:0;right:0;height:56px;
    background:var(--hud);display:flex;align-items:center;justify-content:space-between;
    padding:0 12px;box-sizing:border-box;z-index:2
  }
  #brand{font-weight:800;color:#79cfff;font-size:22px;letter-spacing:.5px;display:flex;gap:8px;align-items:center}
  #scoreWrap{color:var(--hudTxt);font-weight:800;font-size:22px}
  #hearts{display:flex;gap:6px}
  .heart{width:22px;height:22px;filter:drop-shadow(0 0 3px #700)}
  #stage{position:fixed;left:0;right:0;top:56px;bottom:0;display:flex;justify-content:center;align-items:center}
  canvas{touch-action:none;background:#1a1a1a;display:block;max-width:100%;height:auto;box-shadow:0 0 16px rgba(0,0,0,.6)}
  #overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:3}
  #card{background:#0b1320;border:1px solid #1d2a40;border-radius:14px;padding:18px 22px;color:#eaf6ff;text-align:center;min-width:240px}
  #card h2{margin:0 0 10px;font-size:26px}
  .btn{background:#0bd; border:0;padding:10px 18px;border-radius:10px;color:#001018;font-weight:800;font-size:16px;cursor:pointer}
</style>
</head>
<body>
  <div id="hud">
    <div id="brand">Babypeacock ðŸ¦š</div>
    <div id="title" style="font-weight:800;font-size:20px;color:#cfe8ff">Mars (Level 2)</div>
    <div style="display:flex;align-items:center;gap:14px">
      <div id="scoreWrap">SCORE: <span id="score">0</span></div>
      <div id="hearts"></div>
    </div>
  </div>

  <div id="stage"><canvas id="game" width="420" height="720"></canvas></div>

  <div id="overlay">
    <div id="card">
      <h2 id="ovTitle">GAME OVER</h2>
      <p id="ovText" style="margin:0 0 14px">Tekrar dene?</p>
      <button class="btn" id="retryBtn">RETRY</button>
    </div>
  </div>

<script>
/* ================== BOYUTLANDIRMA ================== */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d', {alpha:false});
let W=420,H=720, lastT=0;
function fit(){
  const hudH = 56;
  const maxW = Math.min(420, window.innerWidth);
  const maxH = Math.min(760, window.innerHeight - hudH - 4);
  const aspect = 420/720;
  let w = maxW, h = Math.floor(maxW/aspect);
  if(h>maxH){ h=maxH; w=Math.floor(maxH*aspect); }
  cvs.width = w; cvs.height = h; W=w; H=h;
}
window.addEventListener('resize', fit); fit();

/* ================== VARS ================== */
const HUD = {
  scoreEl: document.getElementById('score'),
  heartsEl: document.getElementById('hearts'),
  overlay: document.getElementById('overlay'),
  retry: document.getElementById('retryBtn'),
  ovTitle: document.getElementById('ovTitle'),
  ovText: document.getElementById('ovText')
};

let running=true, score=0, lives=3, timeSec=0;
function setScore(v){ score=v; HUD.scoreEl.textContent = score|0; }
function drawHearts(){
  HUD.heartsEl.innerHTML='';
  for(let i=0;i<lives;i++){
    const img=document.createElement('img');
    img.className='heart';
    img.src='data:image/svg+xml;utf8,'+encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path fill="#ff2b4d" d="M12 21s-7.5-4.6-9.6-8.3C.5 9.6 2 6 5.5 6c2.1 0 3.2 1.2 3.9 2.2c.7-1 1.8-2.2 3.9-2.2C17 6 18.5 9.6 21.6 12.7C19.5 16.4 12 21 12 21z"/></svg>`
    );
    HUD.heartsEl.appendChild(img);
  }
}
drawHearts();

/* ================== GÃ–RSELLER ================== */
function load(src){ const i=new Image(); i.src=src; return i; }
const IMG = {
  player: load('../img/player/bpc_mini.png'),
  g: load('../mars_enemy_green.png'),
  y: load('../mars_enemy_yellow.png'),
  w: load('../mars_enemy_white.png'),
  r: load('../bpc_enemy_red.png')
};

/* ================== ARKA PLAN: MARS ================== */
let scrollY = 0;
function nrand(x,y){ let t=(x*374761393 + y*668265263)|0; t=(t^(t>>>13))*1274126177; t=(t^(t>>>16))>>>0; return t/4294967296;}
function drawMars(dt){
  scrollY = (scrollY + dt*60) % 48;
  // taban gradyan
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#5a2919'); g.addColorStop(.7,'#6e3320'); g.addColorStop(1,'#7b3b23');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  // yumuÅŸak kum izleri (Ã§izgi deÄŸil, hafif ÅŸerit)
  ctx.globalAlpha=.22; ctx.fillStyle='#8a4829';
  for(let y=-48;y<H+48;y+=48){ const yy = Math.floor(y + H - (scrollY%48)); ctx.fillRect(0,yy,W,5); }
  ctx.globalAlpha=1;
  // taÅŸ/benek
  ctx.fillStyle='#2b1a12';
  for(let y=0;y<H;y+=16){
    for(let x=0;x<W;x+=16){
      const r=nrand((x+scrollY)>>4, y>>4);
      if(r>.86){ const sz=1+(r-.86)*6; ctx.beginPath(); ctx.arc(x+(r*16)%12, y+((r*47)%12), sz, 0, Math.PI*2); ctx.fill(); }
    }
  }
}

/* ================== OYUN NESNELERÄ° ================== */
const player = {
  x: W*0.5, y: H*0.8, w: 36, h: 36, speed: 280, fireCd:0, triple=false, tripleTime:0
};

let bullets=[], ebullets=[], enemies=[];

function spawnEnemy(){
  // zorluk kademesi
  const t = timeSec;
  const base = Math.max(550 - t*6, 220); // spawn aralÄ±ÄŸÄ± ms
  nextSpawn = performance.now() + base;

  // tÃ¼r seÃ§imi (zamanla red ve white olasÄ±lÄ±ÄŸÄ± artar)
  const r = Math.random();
  let type='g';
  if(r>0.75 && t>20) type='y';
  if(r>0.60 && t>35) type='w';
  if(r>0.82 && t>50) type='r';

  const img=IMG[type];
  const scale = (type==='g'?0.42:type==='y'?0.46:type==='w'?0.50:0.50);
  const w = (img.naturalWidth||120)*scale, h=(img.naturalHeight||120)*scale;

  enemies.push({
    type, img, x: Math.random()*(W-w)+w*0.5, y: -h-6, w, h,
    vy: (type==='g'? 60 : type==='y'? 85 : type==='w'? 70 : 95) + timeSec*0.3,
    fireCd: 600 + Math.random()*700,
    laserCd: 1200 + Math.random()*1500,
    alive:true
  });
}

function shoot(x,y,vy,col='#29d3ff'){ bullets.push({x,y,vy, col, r:3}); }

let touchId=null;
cvs.addEventListener('touchstart',e=>{
  const t = e.changedTouches[0]; touchId=t.identifier;
  player.x = (t.clientX - cvs.getBoundingClientRect().left);
  e.preventDefault();
},{passive:false});
cvs.addEventListener('touchmove',e=>{
  for(const t of e.changedTouches){
    if(t.identifier===touchId){
      const rect=cvs.getBoundingClientRect();
      player.x = Math.max(18, Math.min(W-18, t.clientX-rect.left));
    }
  }
  e.preventDefault();
},{passive:false});
cvs.addEventListener('touchend',e=>{ if([...e.changedTouches].some(t=>t.identifier===touchId)) touchId=null;});

let nextSpawn=0;

/* ================== Ã‡ARPIÅžMA ================== */
function hitRect(a,b){ return Math.abs(a.x-b.x) < (a.w*0.5 + b.w*0.5) && Math.abs(a.y-b.y) < (a.h*0.5 + b.h*0.5); }
function hitCirclePoint(cx,cy,r,px,py){ const dx=cx-px, dy=cy-py; return dx*dx+dy*dy <= r*r; }

/* ================== OYUN DÃ–NGÃœSÃœ ================== */
function reset(){
  running=true; score=0; setScore(0); lives=3; drawHearts();
  bullets.length=0; ebullets.length=0; enemies.length=0;
  player.x=W*0.5; player.y=H*0.82; player.triple=false; player.tripleTime=0; player.fireCd=0;
  timeSec=0; nextSpawn=0; lastT=0;
  HUD.overlay.style.display='none';
  requestAnimationFrame(loop);
}
HUD.retry.onclick = reset;

function loop(ts){
  if(!running) return;
  if(!lastT) lastT=ts; const dt = (ts-lastT)/1000; lastT=ts; timeSec+=dt;

  // ARKA PLAN
  drawMars(dt);

  // PLAYER gÃ¶rÃ¼ntÃ¼
  if(IMG.player.complete && IMG.player.naturalWidth>0){
    const pw=player.w, ph=player.h;
    ctx.drawImage(IMG.player, player.x - pw/2, player.y - ph/2, pw, ph);
  }else{
    ctx.fillStyle='#0bd'; ctx.beginPath(); ctx.moveTo(player.x, player.y-16); ctx.lineTo(player.x-16, player.y+16); ctx.lineTo(player.x+16, player.y+16); ctx.closePath(); ctx.fill();
  }

  // Otomatik ateÅŸ
  player.fireCd -= dt*1000;
  if(player.fireCd<=0){
    player.fireCd = 200; // ms
    if(player.triple){
      shoot(player.x-9, player.y-18, -360);
      shoot(player.x,    player.y-20, -380);
      shoot(player.x+9,  player.y-18, -360);
    }else{
      shoot(player.x, player.y-20, -380);
    }
  }
  if(player.triple){ player.tripleTime -= dt; if(player.tripleTime<=0){ player.triple=false; } }

  // BULLETS (player)
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y += b.vy*dt;
    if(b.y<-8){ bullets.splice(i,1); continue; }
    ctx.fillStyle=b.col; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  }

  // ENEMY SPAWN
  if(ts>=nextSpawn) spawnEnemy();

  // ENEMIES
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.y += e.vy*dt;

    // atÄ±ÅŸ davranÄ±ÅŸÄ±
    if(e.type==='g' || e.type==='y'){
      e.fireCd -= dt*1000;
      if(e.fireCd<=0){
        e.fireCd = 900 + Math.random()*900;
        ebullets.push({x:e.x, y:e.y+e.h*0.3, vy: 180 + (e.type==='y'?60:0), col:'#ffd34a', r:3});
      }
    }
    if(e.type==='w'){ // iki kanat
      e.fireCd -= dt*1000;
      if(e.fireCd<=0){
        e.fireCd = 950 + Math.random()*900;
        ebullets.push({x:e.x - e.w*0.25, y:e.y+e.h*0.2, vy: 210, col:'#ffffff', r:3});
        ebullets.push({x:e.x + e.w*0.25, y:e.y+e.h*0.2, vy: 210, col:'#ffffff', r:3});
      }
    }
    if(e.type==='r'){ // kÄ±sa lazer
      e.laserCd -= dt*1000;
      if(e.laserCd<=0){
        e.laserCd = 850 + Math.random()*900;
        // lazeri kÄ±sa ÅŸaft olarak 110ms gÃ¶ster
        e.laserOn = 0.11;
      }
      if(e.laserOn){ e.laserOn -= dt; }
    }

    // Ã§iz
    if(e.img.complete && e.img.naturalWidth>0){
      ctx.drawImage(e.img, e.x - e.w/2, e.y - e.h/2, e.w, e.h);
    }else{
      ctx.fillStyle='#ccc'; ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h);
    }

    // lazer Ã§izimi ve Ã§arpÄ±ÅŸma
    if(e.type==='r' && e.laserOn>0){
      ctx.fillStyle='#ff3344';
      const lx = e.x, ly1 = e.y+e.h*0.1, ly2 = ly1 + 40;
      ctx.fillRect(lx-2, ly1, 4, 40);
      // temas kontrol
      if(Math.abs(player.x-lx)<(player.w*0.38) && player.y+player.h*0.45>ly1 && player.y- player.h*0.45<ly2){
        damage();
      }
    }

    // ekran dÄ±ÅŸÄ±
    if(e.y - e.h/2 > H+40){ enemies.splice(i,1); continue; }

    // player mermisiyle vurulma
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(hitRect({x:e.x,y:e.y,w:e.w,h:e.h},{x:b.x,y:b.y,w:8,h:8})){
        bullets.splice(j,1);
        explode(e.x,e.y, e.type);
        // puan
        let p = (e.type==='g'?2: e.type==='y'?3: e.type==='w'?3:5);
        setScore(score + p);
        enemies.splice(i,1);
        break;
      }
    }

    // gemi Ã§arpÄ±ÅŸmasÄ±
    if(hitRect({x:e.x,y:e.y,w:e.w*0.8,h:e.h*0.8},{x:player.x,y:player.y,w:player.w,h:player.h})){
      explode(e.x,e.y,e.type);
      enemies.splice(i,1);
      damage();
      continue;
    }
  }

  // ENEMY BULLETS
  for(let i=ebullets.length-1;i>=0;i--){
    const b=ebullets[i]; b.y += b.vy*dt;
    if(b.y>H+8){ ebullets.splice(i,1); continue; }
    ctx.fillStyle=b.col; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    if(hitCirclePoint(b.x,b.y,b.r+6, player.x,player.y)){ ebullets.splice(i,1); damage(); }
  }

  requestAnimationFrame(loop);
}

// hasar
function damage(){
  if(!running) return;
  lives--; drawHearts();
  // kÄ±sa titreÅŸim
  try{ navigator.vibrate && navigator.vibrate(60);}catch{}
  if(lives<=0){
    running=false;
    HUD.ovTitle.textContent='GAME OVER';
    HUD.ovText.textContent='Skor: '+score;
    HUD.overlay.style.display='grid';
  }
}

// patlama partikÃ¼lÃ¼
const boomClr = {g:'#66ff66', y:'#ffd34a', w:'#ffffff', r:'#ff3344'};
function explode(x,y,type){
  const col = boomClr[type]||'#fff';
  const n = 10;
  for(let i=0;i<n;i++){
    const a = Math.random()*Math.PI*2, sp = 60+Math.random()*120;
    const life = .35 + Math.random()*.35;
    particles.push({x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life, max:life, col});
  }
}
let particles=[];
function drawParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=dt; if(p.life<=0){ particles.splice(i,1); continue; }
    p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 40*dt;
    ctx.globalAlpha = Math.max(0, p.life/p.max);
    ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }
}

/* parÃ§acÄ±klarÄ± dÃ¶ngÃ¼ye takalÄ±m */
const _origLoop = loop;
function loop(ts){
  if(!running) return;
  if(!lastT) lastT=ts; const dt=(ts-lastT)/1000; lastT=ts; timeSec+=dt;

  drawMars(dt);
  // parÃ§acÄ±klar altta dursun
  drawParticles(dt);

  // PLAYER
  if(IMG.player.complete && IMG.player.naturalWidth>0){
    ctx.drawImage(IMG.player, player.x-player.w/2, player.y-player.h/2, player.w, player.h);
  }else{
    ctx.fillStyle='#0bd'; ctx.beginPath(); ctx.moveTo(player.x, player.y-18); ctx.lineTo(player.x-18, player.y+18); ctx.lineTo(player.x+18, player.y+18); ctx.closePath(); ctx.fill();
  }

  // fire
  player.fireCd -= dt*1000;
  if(player.fireCd<=0){ player.fireCd=200; if(player.triple){shoot(player.x-9,player.y-18,-360);shoot(player.x,player.y-20,-380);shoot(player.x+9,player.y-18,-360);}else{shoot(player.x,player.y-20,-380);} }
  if(player.triple){ player.tripleTime-=dt; if(player.tripleTime<=0) player.triple=false; }

  // bullets
  for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.y+=b.vy*dt; if(b.y<-8){bullets.splice(i,1); continue;} ctx.fillStyle=b.col; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }

  // spawn
  if(ts>=nextSpawn) spawnEnemy();

  // enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i]; e.y += e.vy*dt;

    // davranÄ±ÅŸ
    if(e.type==='g'||e.type==='y'){ e.fireCd-=dt*1000; if(e.fireCd<=0){ e.fireCd=900+Math.random()*900; ebullets.push({x:e.x,y:e.y+e.h*0.3,vy:180+(e.type==='y'?60:0),col:'#ffd34a',r:3}); } }
    if(e.type==='w'){ e.fireCd-=dt*1000; if(e.fireCd<=0){ e.fireCd=950+Math.random()*900; ebullets.push({x:e.x-e.w*0.25,y:e.y+e.h*0.2,vy:210,col:'#ffffff',r:3}); ebullets.push({x:e.x+e.w*0.25,y:e.y+e.h*0.2,vy:210,col:'#ffffff',r:3}); } }
    if(e.type==='r'){ e.laserCd-=dt*1000; if(e.laserCd<=0){ e.laserCd=850+Math.random()*900; e.laserOn=.11; } if(e.laserOn){ e.laserOn-=dt; } }

    // Ã§izim
    if(e.img.complete && e.img.naturalWidth>0){ ctx.drawImage(e.img, e.x-e.w/2, e.y-e.h/2, e.w, e.h); }
    // lazer
    if(e.type==='r'&&e.laserOn>0){ ctx.fillStyle='#ff3344'; const lx=e.x, ly1=e.y+e.h*0.1, ly2=ly1+40; ctx.fillRect(lx-2,ly1,4,40); if(Math.abs(player.x-lx)<(player.w*0.38) && player.y+player.h*0.45>ly1 && player.y-player.h*0.45<ly2){ damage(); } }

    if(e.y-e.h/2>H+40){ enemies.splice(i,1); continue; }

    // vurulma
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(hitRect({x:e.x,y:e.y,w:e.w,h:e.h},{x:b.x,y:b.y,w:8,h:8})){
        bullets.splice(j,1); explode(e.x,e.y,e.type);
        setScore(score + (e.type==='g'?2:e.type==='y'?3:e.type==='w'?3:5));
        enemies.splice(i,1); break;
      }
    }
    // gemiye Ã§arpma
    if(hitRect({x:e.x,y:e.y,w:e.w*.8,h:e.h*.8},{x:player.x,y:player.y,w:player.w,h:player.h})){
      explode(e.x,e.y,e.type); enemies.splice(i,1); damage();
    }
  }

  // enemy bullets
  for(let i=ebullets.length-1;i>=0;i--){
    const b=ebullets[i]; b.y+=b.vy*dt; if(b.y>H+8){ ebullets.splice(i,1); continue; }
    ctx.fillStyle=b.col; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    if(hitCirclePoint(b.x,b.y,b.r+6, player.x,player.y)){ ebullets.splice(i,1); damage(); }
  }

  requestAnimationFrame(loop);
}

/* ================== BAÅžLAT ================== */
reset();
</script>
</body>
</html>
