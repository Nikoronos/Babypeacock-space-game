<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BPC Space â€” Mars (Level 2)</title>
<style>
  html,body{margin:0;background:#0b0d10;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  #hud{position:fixed;left:0;top:0;right:0;height:44px;display:flex;align-items:center;gap:10px;padding:8px 10px;
       background:rgba(0,0,0,.5);backdrop-filter:saturate(120%) blur(8px);font-weight:700}
  #title{color:#9ecbff}
  #score{margin-left:auto}
  #hearts{letter-spacing:4px}
  #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
  #card{background:#071018;border:1px solid #0f2c3f;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.45);
        padding:22px 24px;text-align:center;min-width:260px}
  #card h2{margin:0 0 14px;font-size:28px;letter-spacing:.5px}
  #btn{border:0;border-radius:12px;background:#07b2b2;color:#001016;font-weight:800;padding:12px 18px;cursor:pointer}
  canvas{display:block;margin:44px auto 0;touch-action:none}
</style>
</head>
<body>
  <div id="hud">
    <div id="title">Babypeacock ðŸ¦š</div>
    <div>Mars (Level 2)</div>
    <div id="score">SCORE: 0</div>
    <div id="hearts">ðŸ’–ðŸ’–ðŸ’–</div>
  </div>
  <canvas id="cv" width="420" height="740"></canvas>

  <div id="overlay"><div id="card">
    <h2 id="ovTitle">GAME OVER</h2>
    <button id="btn">RETRY</button>
  </div></div>

<script>
/* ============ Canvas & State ============ */
const cvs = document.getElementById('cv');
const ctx = cvs.getContext('2d');
const W = cvs.width, H = cvs.height;

const HUD = {
  scoreEl: document.getElementById('score'),
  heartsEl: document.getElementById('hearts'),
  overlay: document.getElementById('overlay'),
  btn: document.getElementById('btn'),
  setScore(v){ this.scoreEl.textContent='SCORE: '+v; },
  setLives(v){ this.heartsEl.textContent = 'ðŸ’–'.repeat(Math.max(0,v)); },
  showOver(title='GAME OVER'){ document.getElementById('ovTitle').textContent=title; this.overlay.style.display='flex'; },
  hideOver(){ this.overlay.style.display='none'; }
};
HUD.hideOver();

/* ============ Images ============ */
function loadImage(src){
  const img=new Image();
  img.src = src; return img;
}
const IMGS = {
  player: loadImage('../img/player/bpc_mini.png'),
  green:  loadImage('../mars_enemy_green.png'),
  yellow: loadImage('../mars_enemy_yellow.png'),
  white:  loadImage('../mars_enemy_white.png'),
  boss:   loadImage('../mars_enemy_bigger_green.png')
};

/* ============ Player ============ */
const player = {
  x: W/2, y: H-90, w: 44, h: 44,
  speed: 3.2, fireCD: 0, lives: 3
};
HUD.setLives(player.lives);

const keys={};
addEventListener('keydown',e=>keys[e.key]=true,{passive:true});
addEventListener('keyup',e=>keys[e.key]=false,{passive:true});
cvs.addEventListener('pointermove',e=>{
  const r=cvs.getBoundingClientRect();
  player.x = Math.max(22, Math.min(W-22, e.clientX - r.left));
},{passive:true});

/* ============ Bullets & Enemies ============ */
let bullets=[], eBullets=[], enemies=[];
let score=0, running=true, lastTime=0, boss=null;

function firePlayer(){
  if(player.fireCD>0) return;
  player.fireCD=180; // ms
  bullets.push({x:player.x, y:player.y-18, vy:-6, w:3, h:10});
}
function spawnEnemy(){
  const r = Math.random();
  const x = 30 + Math.random()*(W-60);
  if(score<500){
    if(r<0.5) enemies.push(makeEnemy('green', x, -40));
    else if(r<0.85) enemies.push(makeEnemy('yellow', x, -40));
    else enemies.push(makeEnemy('white', x, -40));
  }
}
function makeEnemy(type,x,y){
  const base = {type, x, y, w:42, h:42, t:0, fireT: 800+Math.random()*700};
  if(type==='yellow') base.vy = 1.5 + Math.random()*0.5;
  else if(type==='white') base.vy = 1.2, base.w=54, base.h=54;
  else base.vy = 1.3;
  base.img = IMGS[type];
  return base;
}

/* ============ Boss (500 skor) ============ */
function ensureBoss(){
  if(boss || score<500) return;
  boss = {
    x: W/2, y: -140, w: 160, h: 160, vy: 0.6, hp: 30,
    dir: 1, t: 0, img: IMGS.boss
  };
}

/* ============ Helpers ============ */
function aabb(a,b){
  return Math.abs(a.x-b.x) < (a.w+b.w)/2 && Math.abs(a.y-b.y) < (a.h+b.h)/2;
}

/* ============ Mars Background ============ */
function drawMarsBackground(){
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#6b2b17');  // Ã¼st
  g.addColorStop(1,'#3a140b');  // alt
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // kum Ã§izgileri (aÅŸaÄŸÄ± akÄ±yor hissi)
  ctx.strokeStyle='rgba(255,200,70,.25)';
  ctx.lineWidth=4;
  for(let i=0;i<7;i++){
    const yy = (Date.now()*0.06 + i*110) % (H+50) - 50;
    ctx.beginPath();
    ctx.moveTo(0,yy);
    ctx.lineTo(W,yy);
    ctx.stroke();
  }

  // taÅŸ benekleri
  ctx.fillStyle='rgba(0,0,0,.25)';
  for(let i=0;i<80;i++){
    ctx.fillRect((i*53%W), (i*97 + (Date.now()*0.08))%H, 2, 2);
  }
}

/* ============ Main Loop ============ */
function update(dt){
  // hareket
  if(keys['ArrowLeft'])  player.x-=player.speed;
  if(keys['ArrowRight']) player.x+=player.speed;
  player.x = Math.max(22, Math.min(W-22, player.x));

  // ateÅŸ
  if(keys[' '] || keys['Spacebar']) firePlayer();
  player.fireCD = Math.max(0, player.fireCD - dt);

  // mermi hareket
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y += b.vy;
    if(b.y<-20) bullets.splice(i,1);
  }

  // yeni dÃ¼ÅŸmanlar
  if(Math.random()<0.025) spawnEnemy();

  // dÃ¼ÅŸman hareket + atÄ±ÅŸ
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i]; e.t+=dt; e.y += e.vy;

    // sinus dalgalarÄ± ufoda (Ã¶rnek; hepsi kullanÄ±r)
    if(e.type==='white') e.x += Math.sin(e.t*0.003)*0.6;

    if(e.y>H+60){ enemies.splice(i,1); continue; }

    // ateÅŸ
    if(e.t > e.fireT){
      if(e.type==='white'){ // Ã§ift beyaz lazer
        eBullets.push({x:e.x-12,y:e.y+20,vy:3.2,w:3,h:12,color:'#ffffff'});
        eBullets.push({x:e.x+12,y:e.y+20,vy:3.2,w:3,h:12,color:'#ffffff'});
      }else{ // tek
        eBullets.push({x:e.x,y:e.y+18,vy:3.0,w:3,h:10,color:'#00ff9c'});
      }
      e.fireT += 900 + Math.random()*600;
    }
  }

  // dÃ¼ÅŸman vurulma
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(aabb(
        {x:b.x,y:b.y,w:b.w,h:b.h},
        {x:e.x,y:e.y,w:e.w,h:e.h}
      )){
        bullets.splice(j,1);
        enemies.splice(i,1);
        score+=10; HUD.setScore(score);
        break;
      }
    }
  }

  // boss ortaya Ã§Ä±kÄ±ÅŸ ve davranÄ±ÅŸ
  ensureBoss();
  if(boss){
    if(boss.y < 110) boss.y += boss.vy; // sahneye insin
    else{
      boss.x += 1.2*boss.dir;
      if(boss.x<90) boss.dir= 1;
      if(boss.x>W-90) boss.dir=-1;
      // Ã¼Ã§lÃ¼ atÄ±ÅŸ
      if(boss.t<=0){
        const c = '#63ff63';
        eBullets.push({x:boss.x, y:boss.y+60, vy:3.2, w:4, h:12, color:c});
        eBullets.push({x:boss.x-20, y:boss.y+60, vy:3.0, w:4, h:12, color:c});
        eBullets.push({x:boss.x+20, y:boss.y+60, vy:3.0, w:4, h:12, color:c});
        boss.t = 380; // ms
      } else boss.t -= dt;
    }
  }

  // dÃ¼ÅŸman mermileri
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i]; b.y += b.vy;
    if(b.y>H+16) { eBullets.splice(i,1); continue; }
    if(aabb({x:b.x,y:b.y,w:b.w,h:b.h}, player)){
      eBullets.splice(i,1);
      player.lives--; HUD.setLives(player.lives);
      if(player.lives<=0){ running=false; HUD.showOver('GAME OVER'); }
    }
  }

  // oyuncu mermileri boss hasarÄ±
  if(boss){
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(aabb({x:b.x,y:b.y,w:b.w,h:b.h}, boss)){
        bullets.splice(j,1);
        boss.hp--;
        if(boss.hp<=0){ running=false; HUD.showOver('LEVEL COMPLETE'); }
      }
    }
  }
}

function draw(){
  drawMarsBackground();

  // oyuncu
  if(IMGS.player.complete){
    ctx.drawImage(IMGS.player, player.x-player.w/2, player.y-player.h/2, player.w, player.h);
  }else{
    ctx.fillStyle='#22d3ee';
    ctx.beginPath(); ctx.moveTo(player.x,player.y-16); ctx.lineTo(player.x-14,player.y+16); ctx.lineTo(player.x+14,player.y+16); ctx.closePath(); ctx.fill();
  }

  // oyuncu mermileri
  ctx.fillStyle='#ffd24a';
  bullets.forEach(b=>{ ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h); });

  // dÃ¼ÅŸmanlar (white ters sprite dÃ¼zeltmeli Ã§izim!)
  enemies.forEach(e=>{
    if(e.type==='white' && e.img.complete){
      ctx.save();
      ctx.translate(e.x, e.y);
      ctx.scale(1,-1);
      ctx.drawImage(e.img, -e.w/2, -e.h/2, e.w, e.h);
      ctx.restore();
    }else if(e.img.complete){
      ctx.drawImage(e.img, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
    }else{
      ctx.fillStyle = e.type==='yellow' ? '#ffe066' : '#6cff7d';
      ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h);
    }
  });

  // boss
  if(boss && boss.img.complete){
    ctx.drawImage(boss.img, boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h);
    // HP bar
    ctx.fillStyle='#1a2a23'; ctx.fillRect(10,8,W-20,8);
    ctx.fillStyle='#3cff86'; ctx.fillRect(10,8,(W-20)*Math.max(0,boss.hp/30),8);
  }

  // dÃ¼ÅŸman mermileri
  eBullets.forEach(b=>{
    ctx.fillStyle = b.color || '#00ff9c';
    ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h);
  });
}

function loop(ts){
  const dt = Math.min(32, ts - lastTime); lastTime = ts;
  if(!running) return;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

/* ============ Start ============ */
function reset(){
  bullets.length = 0; eBullets.length = 0; enemies.length = 0;
  score = 0; HUD.setScore(score);
  player.x=W/2; player.y=H-90; player.lives=3; HUD.setLives(player.lives);
  running=true; boss=null; lastTime=0; HUD.hideOver();
  requestAnimationFrame(loop);
}
HUD.btn.onclick = reset;
reset();

</script>
</body>
</html>
