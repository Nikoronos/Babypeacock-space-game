<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>BPC Space ‚Äî Mars (Level 2)</title>
<style>
  :root { --hud:#0ff; --bg:#081b23; --mars:#6b2d1e; --mars2:#562318; }
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial}
  #wrap{position:relative;max-width:480px;margin:0 auto;background:#000;height:100vh;overflow:hidden}
  canvas{display:block;width:100%;height:100%}
  /* HUD */
  #hud{position:absolute;left:0;right:0;top:0;height:54px;display:flex;align-items:center;
       justify-content:space-between;padding:8px 12px;box-sizing:border-box;
       background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.25));color:#bcd7ff;
       font-weight:800;letter-spacing:.3px;font-size:22px;user-select:none;pointer-events:none}
  #brand{display:flex;gap:8px;align-items:center}
  #brand .tree{filter:drop-shadow(0 0 6px #0f0)}
  #right{display:flex;gap:18px;align-items:center}
  #gems{font-size:14px;opacity:.85}
  #hearts{font-size:24px}
  /* Panels */
  .panel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65)}
  .card{background:#0c1622;border:1px solid #253445;color:#eaf6ff;border-radius:16px;padding:22px;max-width:360px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .card h2{margin:0 0 12px 0;font-size:26px}
  .card p{margin:0 0 14px 0;opacity:.85}
  .btn{background:#12c6b3;color:#001316;border:none;border-radius:12px;padding:12px 20px;font-weight:800;font-size:18px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  #hint{margin-top:10px;font-size:13px;opacity:.7}
  #over .card{padding:18px}
  #over h3{margin:8px 0 14px 0;font-size:28px}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div id="hud">
    <div id="brand">Babypeacock <span class="tree">ü¶ö</span></div>
    <div id="title">Mars (Level 2)</div>
    <div id="right">
      <div id="score">Score: 0</div>
      <div id="gems">üíé <span id="gemTimer">0</span>s</div>
      <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
  </div>

  <div id="start" class="panel">
    <div class="card">
      <h2>Mars G√∂revi</h2>
      <p>Parmaƒüƒ±nƒ± s√ºr√ºkle ‚Ä¢ Mavi atƒ±≈ülar otomatik ‚Ä¢ Elmas = 12s √º√ßl√º atƒ±≈ü</p>
      <button id="btnStart" class="btn">BA≈ûLAT</button>
      <div id="hint">(G√∂rseller y√ºklenmezse dosya adlarƒ±nƒ± kontrol et)</div>
    </div>
  </div>

  <div id="over" class="panel" style="display:none">
    <div class="card">
      <h3>GAME OVER</h3>
      <button id="btnRetry" class="btn">TEKRAR</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ---- Canvas & DPR
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function resize(){
    const W = document.getElementById('wrap').clientWidth;
    const H = document.getElementById('wrap').clientHeight;
    cvs.width = Math.floor(W * DPR);
    cvs.height = Math.floor(H * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ---- HUD
  const elScore = document.getElementById('score');
  const elHearts = document.getElementById('hearts');
  const elGemTimer = document.getElementById('gemTimer');
  const startPanel = document.getElementById('start');
  const overPanel  = document.getElementById('over');
  document.getElementById('btnStart').onclick = startGame;
  document.getElementById('btnRetry').onclick = startGame;

  // ---- Assets (paths must exist exactly)
  const SPR = {
    player: 'img/player/bpc_mini.png',
    green : 'mars_enemy_green.png',
    yellow: 'mars_enemy_yellow.png',
    white : 'mars_enemy_white.png',
    red   : 'mars_enemy_red.png'
  };
  const IMG = {};
  function loadOne(src){ return new Promise(res=>{ const im=new Image(); im.src=src; im.onload=()=>res(im); im.onerror=()=>res(null); }); }
  async function loadAll(){
    for(const k in SPR){ IMG[k] = await loadOne(SPR[k]); }
  }

  // ---- State
  let running=false, t0=0, last=0, elapsed=0;
  const player = {x:0,y:0,w:44,h:44,fireCD:0, inv:0};
  let bullets=[], enemies=[], ebullets=[], sparks=[], gems=[];
  let score=0, lives=3, triple=0, spawnTick=0, diff=0;

  // ---- Input (touch/mouse)
  const pointer = {x:0,y:0,down:false};
  function setPointer(e){
    const r = cvs.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
    pointer.x=x; pointer.y=y;
  }
  cvs.addEventListener('touchstart', e=>{pointer.down=true; setPointer(e); e.preventDefault();},{passive:false});
  cvs.addEventListener('touchmove',  e=>{setPointer(e); e.preventDefault();},{passive:false});
  cvs.addEventListener('touchend',   ()=>{pointer.down=false;});
  cvs.addEventListener('mousemove',  e=>setPointer(e));

  // ---- Helpers
  const R = (a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function rectHit(a,b){ return (Math.abs(a.x-b.x) < (a.w+b.w)*0.5) && (Math.abs(a.y-b.y) < (a.h+b.h)*0.5); }

  // ---- Reset/Start
  async function startGame(){
    await loadAll();                // (sadece ilk sefer load olur, sonra cache)
    overPanel.style.display='none';
    startPanel.style.display='none';
    running=true; t0=performance.now(); last=t0; elapsed=0;
    bullets.length=enemies.length=ebullets.length=sparks.length=gems.length=0;
    score=0; lives=3; triple=0; spawnTick=0; diff=0;
    player.w=44; player.h=44;
    player.x = cvs.clientWidth/2;
    player.y = cvs.clientHeight - 90;
    player.fireCD=0;
    player.inv = 1000; // 1sn ba≈ülangƒ±√ß koruma
    loop();
  }

  // ---- Spawners
  function spawnEnemy(){
    // t√ºr se√ßimi + zorluk
    const types = ['green','yellow','white','red'];
    const weights = [0.55, 0.22, 0.15, 0.08 + Math.min(0.12, diff*0.02)];
    let rnd=Math.random(), pick=0;
    for(let i=0;i<types.length;i++){ if((rnd -= weights[i])<=0){ pick=i; break; } }
    const type = types[pick];
    const spd = 120 + diff*14 + R(-8,8);
    const e = {
      type, img:IMG[type], x:R(24, cvs.clientWidth-24), y:-40,
      w:  type==='red'? 46: 40,
      h:  type==='red'? 46: 40,
      vy: spd/60,
      hp: type==='yellow'?2 : type==='white'?2 : type==='red'?3 : 1,
      fire: 0
    };
    enemies.push(e);
  }
  function spawnGem(){
    gems.push({x:R(30,cvs.clientWidth-30), y:-20, w:18,h:18, vy:1.5});
  }

  // ---- Mars background (kum + ta≈ü)
  let bgY=0;
  function drawMars(dt){
    bgY += dt*30;
    const W=cvs.clientWidth, H=cvs.clientHeight;
    ctx.fillStyle='#5a2319';
    ctx.fillRect(0,0,W,H);
    // dalgacƒ±k katmanlarƒ±
    ctx.globalAlpha=0.20;
    ctx.fillStyle='#743120';
    for(let i=0;i<5;i++){
      const y = (bgY*0.6 + i*120) % (H+140) - 140;
      ctx.fillRect(0,y,W,80);
    }
    ctx.globalAlpha=1;
    // ta≈ü noktalarƒ±
    ctx.fillStyle='#2b0f0a';
    for(let i=0;i<160;i++){
      const x=((i*73)%W), y=( (i*97 + Math.floor(bgY*0.7))%H );
      ctx.fillRect(x,y,1,1);
    }
  }

  // ---- Particles (patlama rengi tipe g√∂re)
  function boom(x,y,clr){
    for(let i=0;i<10;i++){
      sparks.push({x,y,vx:R(-2,2),vy:R(-2,2),life:400,col:clr});
    }
  }

  // ---- Loop
  function loop(ts){
    if(!running) return;
    const dt = Math.min(40, (ts||performance.now()) - last); last = (ts||performance.now());
    const f = dt/16.67;
    elapsed += dt; diff = Math.floor(elapsed/8000); // her 8sn biraz zor

    // Draw BG
    drawMars(dt/1000);

    // Player move
    const targetX = pointer.down ? pointer.x : cvs.clientWidth/2;
    player.x += (targetX - player.x)*0.25*f;
    player.x = clamp(player.x, 24, cvs.clientWidth-24);
    player.y = clamp(player.y, 60, cvs.clientHeight-70);
    if(player.inv>0) player.inv -= dt;

    // Player fire
    player.fireCD -= dt;
    const fireRate = 220;
    if(player.fireCD<=0){
      player.fireCD=fireRate;
      const bx = player.x, by=player.y-20;
      if(triple>0){
        bullets.push({x:bx-10,y:by,vx:0,vy:-6,w:4,h:10});
        bullets.push({x:bx,   y:by,vx:0,vy:-6,w:4,h:10});
        bullets.push({x:bx+10,y:by,vx:0,vy:-6,w:4,h:10});
      }else{
        bullets.push({x:bx,y:by,vx:0,vy:-6,w:4,h:10});
      }
    }

    // Bullets
    ctx.fillStyle='#78d7ff';
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; b.y+=b.vy*f; b.x+=b.vx*f;
      ctx.fillRect(b.x-2,b.y-8,4,12);
      if(b.y<-12) bullets.splice(i,1);
    }

    // Spawn
    spawnTick += dt;
    if(spawnTick> 550 - Math.min(250,diff*25)){ spawnTick=0; spawnEnemy(); if(Math.random()<0.22) spawnGem(); }

    // Enemies
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i]; e.y += e.vy*f;
      // enemy fire
      e.fire -= dt;
      if(e.type==='red' && e.fire<=0){ e.fire=800; ebullets.push({x:e.x, y:e.y+12, vx:0, vy:3.2, w:4,h:10}); }
      // draw
      const im=e.img;
      if(im){
        if(e.type==='white'){ // ters √ßiz
          ctx.save();
          ctx.translate(e.x, e.y);
          ctx.scale(-1,1);
          ctx.drawImage(im, -e.w/2, -e.h/2, e.w, e.h);
          ctx.restore();
        }else{
          ctx.drawImage(im, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
        }
      }else{
        ctx.fillStyle='#fff'; ctx.fillRect(e.x-18,e.y-12,36,24);
      }
      // kill by bullets
      for(let k=bullets.length-1;k>=0;k--){
        const b=bullets[k];
        if(rectHit({x:e.x,y:e.y,w:e.w,h:e.h}, b)){
          bullets.splice(k,1);
          e.hp--;
          if(e.hp<=0){
            const pts = (e.type==='green')?2:(e.type==='yellow')?3:(e.type==='white')?3:4;
            score += pts;
            elScore.textContent = 'Score: '+score;
            boom(e.x,e.y, e.type==='yellow'?'#ffd34d': e.type==='white'?'#fff': '#6cf26c');
            enemies.splice(i,1);
          }
          break;
        }
      }
      // cross screen
      if(e.y>cvs.clientHeight+40) enemies.splice(i,1);
    }

    // Enemy bullets
    ctx.fillStyle='#ff4b4b';
    for(let i=ebullets.length-1;i>=0;i--){
      const b=ebullets[i]; b.y+=b.vy*f; b.x+=b.vx*f;
      ctx.fillRect(b.x-2,b.y-6,4,10);
      if(b.y>cvs.clientHeight+12) ebullets.splice(i,1);
    }

    // Gems
    for(let i=gems.length-1;i>=0;i--){
      const g=gems[i]; g.y+=g.vy*f;
      // draw diamond
      ctx.save();
      ctx.translate(g.x,g.y);
      ctx.fillStyle='#9ee9ff';
      ctx.beginPath();
      ctx.moveTo(0,-9); ctx.lineTo(11,0); ctx.lineTo(0,9); ctx.lineTo(-11,0); ctx.closePath(); ctx.fill();
      ctx.restore();
      if(rectHit({x:player.x,y:player.y,w:player.w,h:player.h}, g)){
        triple = 12000; // 12s
        gems.splice(i,1);
      }
      if(g.y>cvs.clientHeight+20) gems.splice(i,1);
    }

    // Particles
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.x+=s.vx*f; s.y+=s.vy*f; s.life-=dt;
      ctx.globalAlpha=Math.max(0,s.life/400);
      ctx.fillStyle=s.col; ctx.fillRect(s.x-2,s.y-2,4,4);
      ctx.globalAlpha=1;
      if(s.life<=0) sparks.splice(i,1);
    }

    // Collisions with player
    if(player.inv<=0){
      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        if(rectHit({x:player.x,y:player.y,w:player.w,h:player.h}, e)){
          enemies.splice(i,1);
          damage();
          break;
        }
      }
      for(let i=ebullets.length-1;i>=0;i--){
        const b=ebullets[i];
        if(rectHit({x:player.x,y:player.y,w:player.w,h:player.h}, b)){
          ebullets.splice(i,1);
          damage();
          break;
        }
      }
    }

    // Player draw
    if(IMG.player){
      ctx.drawImage(IMG.player, player.x-22, player.y-22, 44, 44);
    }else{
      ctx.fillStyle='#00d0ff';
      ctx.beginPath(); ctx.moveTo(player.x, player.y-18);
      ctx.lineTo(player.x-12, player.y+18);
      ctx.lineTo(player.x+12, player.y+18); ctx.closePath(); ctx.fill();
    }
    // player blink if inv
    if(player.inv>0 && Math.floor(elapsed/120)%2===0){
      ctx.fillStyle='rgba(255,255,255,.35)';
      ctx.fillRect(player.x-24,player.y-24,48,48);
    }

    // Timers
    if(triple>0){ triple-=dt; if(triple<0) triple=0; }
    elGemTimer.textContent = Math.ceil(triple/1000);

    // Hearts HUD
    elHearts.textContent = '‚ù§Ô∏è'.repeat(lives)+''.padEnd(Math.max(0,3-lives),'‚†Ä');

    // Next frame
    requestAnimationFrame(loop);
  }

  function damage(){
    lives--;
    player.inv = 1200;
    boom(player.x, player.y, '#fff');
    if(lives<=0){ gameOver(); }
  }

  function gameOver(){
    running=false;
    overPanel.style.display='flex';
  }

  // ilk y√ºklemede bekle
})();
</script>
</body>
</html>
