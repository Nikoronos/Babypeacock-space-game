<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>BPC ‚Äì Mars (Level 2)</title>
<style>
  :root{
    --hud-h: 54px;
    --brand: #9ec3ff;
    --txt: #dfe8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{
    height:var(--hud-h);
    display:flex;align-items:center;gap:10px;
    padding: max(8px, env(safe-area-inset-top)) 12px 8px;
    background:rgba(0,0,0,.9);position:sticky;top:0;z-index:5
  }
  .brand{font-weight:800; color:#7fb0ff; font-size:clamp(16px, 5.2vw, 26px); letter-spacing:.3px}
  .label{opacity:.85; font-size:clamp(12px, 3.8vw, 16px)}
  .score{font-weight:800; min-width:48px; text-align:left; font-size:clamp(14px, 4.2vw, 20px)}
  .hearts{margin-left:auto; font-size:clamp(18px, 5.2vw, 26px); letter-spacing:2px}
  #game{display:block; width:100vw; height:calc(100svh - var(--hud-h)); touch-action:none; background:#000}
  .overlay{position:fixed; inset:var(--hud-h) 0 0 0; display:grid; place-items:center; background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.5)); z-index:10}
  .card{background:#0f131a; border:1px solid #1e2732; border-radius:16px; padding:20px; width:min(92vw,380px); text-align:center}
  .card h1{margin:.2em 0 .6em; font-size:clamp(18px, 5vw, 24px)}
  .btn{background:#14b8a6; color:#041016; border:none; border-radius:12px; padding:12px 18px; font-weight:800; font-size:clamp(16px,4.6vw,18px)}
  .hint{opacity:.8; margin-top:10px; font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="brand">Babypeacock ü¶ö</div>
    <div class="label">Mars (Level 2)</div>
    <div class="label">Score:</div><div id="score" class="score">0</div>
    <div class="label">üíé <span id="gemSec">0</span>s</div>
    <div id="hearts" class="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  </header>

  <canvas id="game"></canvas>

  <div id="ovStart" class="overlay">
    <div class="card">
      <h1>Mars G√∂revi</h1>
      <p style="opacity:.9">Green 2p ¬∑ Yellow 3p ¬∑ White 3p ¬∑ Red 5p<br/>üíé = 15sn √º√ßl√º ate≈ü. √áarpƒ±nca can gider.</p>
      <button id="btnStart" class="btn">START</button>
      <div class="hint">Parmaƒüƒ±nla s√ºr√ºkle ‚Äî atƒ±≈ü otomatik</div>
    </div>
  </div>

  <div id="ovOver" class="overlay" style="display:none">
    <div class="card">
      <h1>GAME OVER</h1>
      <div style="margin:8px 0 16px">Skor: <b id="finalScore">0</b></div>
      <button id="btnRetry" class="btn">RETRY</button>
    </div>
  </div>

<script>
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
let W=0,H=0,DPR=1;
function resize(){
  DPR=Math.max(1, Math.min(2, devicePixelRatio||1));
  const w=innerWidth, h=Math.max(460, innerHeight - document.querySelector('header').offsetHeight);
  cvs.style.width=w+'px'; cvs.style.height=h+'px';
  cvs.width=Math.floor(w*DPR); cvs.height=Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  W=w; H=h;
  if(player) player.y=Math.min(player.y, H-72);
}
addEventListener('resize', resize);

/* ---- assets ---- */
function img(s){const i=new Image(); i.src=s; return i;}
const ASSETS={
  player: img('../img/player/bpc_mini.png'),
  green:  img('../mars_enemy_green.png'),
  yellow: img('../mars_enemy_yellow.png'),
  white:  img('../mars_enemy_white.png'),
  red:    img('../bpc_enemy_red.png')
};

/* ---- state ---- */
let running=false, score=0, lives=3, t=0;
let bullets=[], enemies=[], eBullets=[], parts=[], drops=[];
let spawn=0, tripleUntil=0;

const scoreEl=document.getElementById('score');
const heartsEl=document.getElementById('hearts');
const gemSecEl=document.getElementById('gemSec');

const player={x:0,y:0,w:40,h:40, fireCd:0, fireRate:120, sp:Math.min(420, innerWidth*0.9)};

function reset(){
  bullets.length=enemies.length=eBullets.length=parts.length=drops.length=0;
  score=0; lives=3; spawn=0; tripleUntil=0; t=performance.now();
  scoreEl.textContent=0; heartsEl.textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
  // √∂l√ßekli boyutlar
  const base = Math.max(36, Math.min(54, W*0.11));
  player.w=player.h=base; player.x=W*0.5; player.y=H-80;
}

/* ---- input ---- */
let ptr=null;
cvs.addEventListener('pointerdown',e=>{ ptr={id:e.pointerId}; move(e);});
cvs.addEventListener('pointermove',e=>{ if(ptr&&ptr.id===e.pointerId) move(e);});
addEventListener('pointerup',e=>{ if(ptr&&ptr.id===e.pointerId) ptr=null;});
function move(e){
  const r=cvs.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  player.x=Math.max(player.w*0.5, Math.min(W-player.w*0.5, x));
  player.y=Math.max(player.h*0.5, Math.min(H-player.h*0.5, y));
}

/* ---- utils ---- */
const rand=(a,b)=>Math.random()*(b-a)+a;
const clamp=(v,a,b)=>v<a?a:v>b?b:v;
function boom(x,y,c,n=14){for(let i=0;i<n;i++) parts.push({x,y,vx:rand(-140,140),vy:rand(-240,40),r:rand(2,4),life:rand(320,580),c});}

/* ---- background Mars ---- */
let bgOff=0;
function mars(dt){
  bgOff+=dt*40;
  // degrade
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#5a2416'); g.addColorStop(1,'#7a3823');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  // kum benekleri (√ßizgi yok)
  ctx.fillStyle='rgba(0,0,0,.22)';
  for(let i=0;i<70;i++){
    const x=(i*83.7+(bgOff*.8))%(W+30)-15;
    const y=(i*57.3*1.1+(bgOff*1.1))%(H+30)-15;
    ctx.fillRect(x,y,2,2);
  }
}

/* ---- enemies ---- */
const SIZES=()=>({
  ew: Math.max(34, Math.min(56, W*0.12)),
  eh: Math.max(34, Math.min(56, W*0.12)),
});
const ENEMY={
  green:{hp:1, sp:[70,120], fire:false, pts:2},
  yellow:{hp:1, sp:[90,160], fire:true,  rate:950, bullet:'#facc15', dual:false, pts:3},
  white:{hp:2, sp:[80,140], fire:true,  rate:950, bullet:'#f1f1f1', dual:true,  pts:3},
  red:{  hp:3, sp:[80,130], fire:true,  rate:750, bullet:'#ff3b3b', dual:false, pts:5},
};
const IMG={green:ASSETS.green,yellow:ASSETS.yellow,white:ASSETS.white,red:ASSETS.red};
function spawnEnemy(){
  const pool=['green','green','yellow','white']; if(score>120) pool.push('red'); if(score>260) pool.push('red');
  const t=pool[Math.floor(Math.random()*pool.length)];
  const sp=ENEMY[t].sp;
  enemies.push({t, x:rand(24,W-24), y:-50, vy:rand(sp[0],sp[1]), hp:ENEMY[t].hp, cd:0});
}

/* ---- main loop ---- */
function loop(now){
  if(!running) return;
  const dt=(now-t)/1000; t=now;

  mars(dt);

  // player fire
  player.fireCd -= dt*1000;
  if(player.fireCd<=0){
    player.fireCd=player.fireRate;
    const triple = now<tripleUntil;
    const offs = triple ? [-10,0,10] : [0];
    offs.forEach(ox=> bullets.push({x:player.x+ox, y:player.y-player.h*0.5-6, vy:-520, c:'#7fd8ff'}));
  }
  // draw player
  ctx.drawImage(ASSETS.player, player.x-player.w/2, player.y-player.h/2, player.w, player.h);

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y+=b.vy*dt;
    ctx.fillStyle=b.c; ctx.fillRect(b.x-2,b.y-10,4,12);
    if(b.y<-20) bullets.splice(i,1);
  }

  // enemy spawn (skora g√∂re hƒ±z)
  spawn-=dt;
  if(spawn<=0){
    spawnEnemy();
    const base=0.95, minGap=0.28;
    spawn = base * clamp(1 - score/900, minGap, 1);
  }

  // enemies
  const {ew,eh}=SIZES();
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i], spec=ENEMY[e.t];
    e.y += e.vy*dt;

    // fire
    if(spec.fire){
      e.cd -= dt*1000;
      if(e.cd<=0 && e.y>30){
        e.cd = spec.rate * clamp(1 - score/900, .55, 1);
        if(spec.dual){
          eBullets.push({x:e.x-14,y:e.y+eh*0.35,vy:240,c:spec.bullet});
          eBullets.push({x:e.x+14,y:e.y+eh*0.35,vy:240,c:spec.bullet});
        }else{
          eBullets.push({x:e.x,y:e.y+eh*0.35,vy:(e.t==='red'?320:260),c:spec.bullet});
        }
      }
    }

    ctx.drawImage(IMG[e.t], e.x-ew/2, e.y-eh/2, ew, eh);

    // collide with player
    if (Math.abs(e.x-player.x)<(ew+player.w)*0.42 && Math.abs(e.y-player.y)<(eh+player.h)*0.42){
      enemies.splice(i,1);
      boom(e.x,e.y,'#ff6b6b',18);
      hit();
      continue;
    }
    // off-screen
    if(e.y>H+60){ enemies.splice(i,1); continue; }

    // bullet hits
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if (Math.abs(b.x-e.x)<ew*0.45 && Math.abs(b.y-e.y)<eh*0.45){
        bullets.splice(j,1); e.hp--;
        if(e.hp<=0){
          const col=e.t==='green'?'#86efac':e.t==='yellow'?'#facc15':e.t==='white'?'#e5e7eb':'#ff6b6b';
          boom(e.x,e.y,col,20);
          enemies.splice(i,1);
          score += ENEMY[e.t].pts; scoreEl.textContent=score;
        }
        break;
      }
    }
  }

  // enemy bullets
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i]; b.y+=b.vy*dt;
    ctx.fillStyle=b.c; ctx.fillRect(b.x-2,b.y-6,4,10);
    if(b.y>H+20){ eBullets.splice(i,1); continue; }
    if(Math.abs(b.x-player.x)<player.w*0.35 && Math.abs(b.y-player.y)<player.h*0.35){
      eBullets.splice(i,1); hit();
    }
  }

  // particles
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i]; p.life-=dt*1000; if(p.life<=0){parts.splice(i,1); continue;}
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=120*dt;
    ctx.globalAlpha=Math.max(0,p.life/600); ctx.fillStyle=p.c; ctx.fillRect(p.x-2,p.y-2,4,4); ctx.globalAlpha=1;
  }

  // diamonds (en fazla 2 ekranda)
  if(drops.length<2 && Math.random()< (0.0012 + Math.min(0.002, score/10000))){
    drops.push({x:rand(24,W-24), y:-20, vy:110});
  }
  for(let i=drops.length-1;i>=0;i--){
    const d=drops[i]; d.y+=d.vy*dt;
    ctx.font='22px system-ui'; ctx.fillStyle='#9ee5ff'; ctx.fillText('üíé', d.x-10, d.y+6);
    if(d.y>H+30){ drops.splice(i,1); continue; }
    if(Math.abs(d.x-player.x)<18 && Math.abs(d.y-player.y)<18){
      drops.splice(i,1); tripleUntil=performance.now()+15000;
    }
  }

  // gem timer
  gemSecEl.textContent=Math.max(0, Math.floor((tripleUntil-now)/1000));

  requestAnimationFrame(loop);
}

function hit(){
  lives--; heartsEl.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));
  boom(player.x, player.y, '#ff6961', 22);
  if(lives<=0){ running=false; document.getElementById('finalScore').textContent=score; document.getElementById('ovOver').style.display='grid'; }
}

/* ---- start/over ---- */
function start(){
  document.getElementById('ovStart').style.display='none';
  document.getElementById('ovOver').style.display='none';
  resize(); reset(); running=true; requestAnimationFrame(loop);
}
document.getElementById('btnStart').onclick=start;
document.getElementById('btnRetry').onclick=start;

resize();
</script>
</body>
</html>
