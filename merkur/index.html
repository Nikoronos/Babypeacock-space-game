<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>BPC Space — Level 1</title>
<style>
  html,body{margin:0;background:#001b23;color:#e5f8f5;font-family:system-ui,Segoe UI,Roboto,Arial}
  canvas{display:block;margin:0 auto;touch-action:none;image-rendering:pixelated}
  #hud{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
  #startOverlay{gap:16px;flex-direction:column}
  #over{gap:12px;flex-direction:column;display:none}
  #topbar{position:fixed;left:0;top:0;right:0;height:34px;display:flex;align-items:center;gap:10px;padding:6px 10px;
          font:700 14px system-ui,Arial;color:#c8fff4}
  #topbar .chip{background:#062a33;border-radius:10px;padding:4px 8px}
  #bossbar{position:absolute;left:60px;top:10px;height:10px;width:calc(100vw - 120px);background:#1a1a1a;border-radius:8px;display:none}
  #bossfill{height:100%;width:0;background:#19d34b;border-radius:8px}
  button{font-weight:800;border:0;border-radius:10px;padding:10px 16px;background:#00ffc8;color:#00322c}
  button:active{transform:translateY(1px)}
</style>
</head>
<body>

<div id="topbar">
  <span class="chip">BPC Space — Level 1</span>
  <span class="chip">❤️ <span id="lives">3</span></span>
  <span class="chip">⚡ <span id="px">0</span>s</span>
  <span class="chip">SCORE: <span id="sc">0</span></span>
</div>
<div id="bossbar"><div id="bossfill"></div></div>

<canvas id="game" width="420" height="740"></canvas>

<div id="hud" class="hud" style="display:flex">
  <div id="startOverlay" style="display:flex">
    <div style="font-size:20px;font-weight:900;color:#a7f3d0;text-align:center">Babypeacock</div>
    <button id="startBtn">BAŞLAT</button>
  </div>
  <div id="over" class="hud">
    <div style="color:#ff5; font-weight:900; font-size:26px">GAME OVER</div>
    <button id="restart">RETRY</button>
  </div>
</div>

<audio id="boom" preload="auto">
  <source src="assets/boom.mp3" type="audio/mpeg" />
</audio>

<script>
/* ---------- Canvas / HUD ---------- */
const cv = document.getElementById("game"), ctx = cv.getContext("2d"); ctx.imageSmoothingEnabled=false;
const scEl=document.getElementById("sc"), pxEl=document.getElementById("px"), livesEl=document.getElementById("lives");
const startOverlay=document.getElementById("startOverlay"), startBtn=document.getElementById("startBtn");
const hud=document.getElementById("hud"), overEl=document.getElementById("over"), restartBtn=document.getElementById("restart");
const bossbar=document.getElementById("bossbar"), bossfill=document.getElementById("bossfill"), boom=document.getElementById("boom");

/* ---------- Utils ---------- */
const clamp=(v,a,b)=>v<a?a:v>b?b:v;
const rand=(a,b)=>a+Math.random()*(b-a);
const rectHit=(a,b)=>!(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);
function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
function keyOutDark(img,TH=76){ // koyu arka planı şeffaflaştır
  const w=img.width,h=img.height,off=document.createElement('canvas');off.width=w;off.height=h; const g=off.getContext('2d');
  g.drawImage(img,0,0); const d=g.getImageData(0,0,w,h),a=d.data;
  for(let i=0;i<a.length;i+=4){const r=a[i],g1=a[i+1],b=a[i+2],lum=0.2126*r+0.7152*g1+0.0722*b; if(lum<TH && r<TH && g1<TH && b<TH) a[i+3]=0;}
  g.putImageData(d,0,0); return off;
}

/* ---------- Assets ---------- */
const PLAYER_SRC = "img/player/bpc_mini.png";
const ENEMY_SRC = {
  red:"bpc_enemy_red.png",
  green:"bpc_enemy_green.png",
  ufo_red:"bpc_enemy_ufo_red.png",
  ufo_gray:"bpc_enemy_ufo_gray.png"
};
const PLAYER = {img:null};
const SPRITES = {};
const PEACOCK_BG = "yc3ku6.jpg"; // oyun sonu küçük rozet için (montaj önleyici yazı)

/* ---------- Game State ---------- */
let started=false, running=false, gameOver=false;
let score=0, lives=3, fireTimer=0, FIRE_MS=170, powerTime=0;
let enemies=[], bullets=[], enemyBullets=[], particles=[];
let elapsed=0, spawnT=0;
const player={x:cv.width/2-30,y:cv.height-120,w:60,h:60};

/* ---------- Boss (WOLF) ---------- */
const NEXT_LEVEL_URL="merkür/index.html"; // not: repo klasörün "merkür"
const WOLF_SPAWN_SCORE=500;
const wolf={ x:cv.width/2-140, y:-220, w:280, h:220, vx:1.6, dir:1, hp:25, entered:false, fireT:0, fireInt:700 };
let wolfActive=false, wolfImg=null, wolfRaw=null;

async function loadAssets(){
  PLAYER.img = await loadImage(PLAYER_SRC);
  for(const k in ENEMY_SRC){ const im = await loadImage(ENEMY_SRC[k]); SPRITES[k]=keyOutDark(im); }
  wolfRaw = await loadImage("enemy_wolf.png"); // mevcut dosya adın buysa; farklıysa değiştir
  wolfImg = keyOutDark(wolfRaw, 60);
}
loadAssets();

/* ---------- Controls ---------- */
function startGame(){
  if(started) return;
  started=true; running=true;
  hud.style.display="none";
  try{ if(window.BPC_incrementOnStart) window.BPC_incrementOnStart(); }catch{}
  try{ if(window.BPC_logCountryOnStart) window.BPC_logCountryOnStart(); }catch{}
}
startBtn.onclick=startGame; cv.onclick=startGame;

let holding=false;
const getX = (e)=>(e.clientX ?? (e.touches?e.touches[0].clientX:0)) - cv.getBoundingClientRect().left;
cv.addEventListener("pointerdown",e=>{ if(!started)return; holding=true; player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w); });
cv.addEventListener("pointermove",e=>{ if(!holding)return; player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w); });
cv.addEventListener("pointerup",()=>holding=false); cv.addEventListener("pointercancel",()=>holding=false);
restartBtn.onclick=()=>location.reload();

/* ---------- Spawners ---------- */
function spawnEnemy(kindList){
  const kind = kindList[Math.floor(Math.random()*kindList.length)];
  const s = (kind.includes("ufo")?64:58), x = rand(10, cv.width-10-s);
  const base = {x,y:-s,w:s,h:s,vy: rand(1.2,2.1),canShoot:false,shootT:0,shootInt:1000,img:SPRITES[kind],type:kind};
  let y=-s;
  if(kind==="red"){ base.canShoot=false; }
  if(kind==="green"){ base.canShoot=true; base.shootInt=1100; }
  if(kind==="ufo_red"){ base.canShoot=true; base.shootInt=900; base.vy=1.3; }
  if(kind==="ufo_gray"){ base.canShoot=true; base.shootInt=1400; base.vy=1.0; }
  enemies.push(base);
}
function allowedKinds(){ return ["red","green","ufo_red","ufo_gray"]; }

function enemyShoot(e){
  // kırmızı → tek sarı; green → tek yeşil; ufo'lar dikine kırmızı
  const vy = 3.2;
  enemyBullets.push({x:e.x+e.w/2-3,y:e.y+e.h-6,w:6,h:10,vy,color:(e.type==="green"?"#22c55e":"#ff3b3b")});
}

/* ---------- Player Fire ---------- */
function shoot(){
  if(powerTime>0){
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:3});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:-3});
  } else {
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
  }
}

/* ---------- Explosions ---------- */
function explosion(x,y,n=16){
  for(let i=0;i<Math.min(n,80-particles.length);i++){
    const a=Math.random()*Math.PI*2, sp=1+Math.random()*2.2;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:420+Math.random()*260,size:1.6+Math.random()*2.4});
  }
  try{ boom.currentTime=0; boom.play().catch(()=>{});}catch{}
}

/* ---------- Draw ---------- */
function draw(t){
  // arka plan
  ctx.fillStyle="#001b23"; ctx.fillRect(0,0,cv.width,cv.height);
  // yıldızlar
  ctx.fillStyle="#0b3c49"; for(let i=0;i<36;i++){ ctx.fillRect((i*33+t*0.05)%cv.width, (i*21+t*0.09)%cv.height, 2, 2); }

  // mermiler
  ctx.fillStyle="#ffeb3b";
  bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x+b.w/2, b.y, 3, 0, Math.PI*2); ctx.fill(); });
  // düşman mermileri
  enemyBullets.forEach(m=>{ ctx.fillStyle=m.color||"#ff3b3b"; ctx.beginPath(); ctx.arc(m.x+m.w/2, m.y+m.h/2, 4, 0, Math.PI*2); ctx.fill(); });

  // düşmanlar
  enemies.forEach(e=>{
    if(e.img) ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
    else { ctx.fillStyle="#ccc"; ctx.fillRect(e.x,e.y,e.w,e.h); }
  });

  // oyuncu
  if(PLAYER.img) ctx.drawImage(PLAYER.img, player.x, player.y, player.w, player.h);
  else { ctx.fillStyle="#80befd"; ctx.fillRect(player.x,player.y,player.w,player.h); }

  // boss
  if(wolfActive && wolf.entered){
    ctx.drawImage(wolfImg, wolf.x, wolf.y, wolf.w, wolf.h);
  }

  // skor
  scEl.textContent = score;
}

/* ---------- Update ---------- */
function endGame(){ running=false; gameOver=true; overEl.style.display="flex"; hud.style.display="flex"; }
function update(dt){
  if(!running) return;

  elapsed += dt; fireTimer += dt; spawnT += dt;
  if(holding && fireTimer>FIRE_MS){ shoot(); fireTimer=0; }

  // spawn (boss yoksa)
  if(!wolfActive && spawnT>650){
    spawnEnemy(allowedKinds()); spawnT=0;
  }

  // hareket
  bullets.forEach(b=>{ b.y+=b.vy; b.x+=(b.ang||0)*0.5; });
  bullets = bullets.filter(b=> b.y>-20);

  enemies.forEach(e=>{
    e.y += e.vy;
    e.shootT += dt;
    if(e.canShoot && e.shootT>=e.shootInt){ e.shootT=0; enemyShoot(e); }
  });
  enemies = enemies.filter(e=> e.y <= cv.height+40);

  enemyBullets.forEach(m=>{ m.y += m.vy; });
  enemyBullets = enemyBullets.filter(m=> m.y < cv.height+40);

  // çarpışmalar: oyuncu → düşman
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j];
      if(rectHit(b,{x:e.x,y:e.y,w:e.w,h:e.h})){
        bullets.splice(i,1); enemies.splice(j,1);
        score+= (e.type.includes('ufo')?20:10);
        explosion(e.x+e.w/2,e.y+e.h/2,14);
        break;
      }
    }
  }

  // çarpışmalar: düşman mermisi → oyuncu
  for(let i=enemyBullets.length-1;i>=0;i--){
    const m=enemyBullets[i];
    if(rectHit(m,player)){
      enemyBullets.splice(i,1);
      lives--; livesEl.textContent=lives;
      if(lives<=0){ endGame(); return; }
    }
  }

  // kontrol: boss tetik
  if(!wolfActive && score >= WOLF_SPAWN_SCORE){
    wolfActive=true; enemies.length=0; // sahneyi temizle
    Object.assign(wolf, {y:-wolf.h, hp:25, entered:false, fireT:0, dir:1, vx:1.6});
    bossbar.style.display="block"; bossfill.style.width="0%";
  }

  // boss davranışı
  if(wolfActive){
    if(!wolf.entered){
      wolf.y += 1.2;
      if(wolf.y >= 110){ wolf.entered=true; }
    }else{
      wolf.x += wolf.vx*wolf.dir;
      if(wolf.x<10 || wolf.x>cv.width-wolf.w-10) wolf.dir*=-1;

      wolf.fireT += dt;
      if(wolf.fireT>=700){
        wolf.fireT=0;
        // iki yandan üçlü atış
        const ports = [
          {x:wolf.x+wolf.w*0.28, y:wolf.y+wolf.h*0.70},
          {x:wolf.x+wolf.w*0.72, y:wolf.y+wolf.h*0.70}
        ];
        ports.forEach(p=>{
          enemyBullets.push({x:p.x,y:p.y,w:6,h:10,vy:3.2,color:"#ff3b3b"});
          enemyBullets.push({x:p.x-8,y:p.y,w:6,h:10,vy:3.2,color:"#ff3b3b"});
          enemyBullets.push({x:p.x+8,y:p.y,w:6,h:10,vy:3.2,color:"#ff3b3b"});
        });
      }
    }

    // oyuncu mermisi boss'a
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i];
      if(rectHit(b,wolf)){
        bullets.splice(i,1);
        wolf.hp = Math.max(0, wolf.hp-1);
        bossfill.style.width = (100 - wolf.hp*4) + "%"; // 25 hp → %0..100
        if(wolf.hp<=0){
          // level-2
          running=false;
          setTimeout(()=>{ window.location.assign(NEXT_LEVEL_URL); }, 600);
        }
      }
    }
  }

  // oyuncu hareket (ok tuşları opsiyonel)
  // mobilde pointer ile sürüklüyorsun zaten
}

/* ---------- Loop ---------- */
let last=performance.now();
function loop(){
  const now=performance.now(), dt=Math.min(33, now-last); last=now;
  // arka plan + çizimler
  draw(now);
  if(started && !gameOver) update(dt);
  requestAnimationFrame(loop);
}
loop();
</script>

<!-- Firebase sayaç & ülke (senin dosya; fonksiyon adların bu örnekle aynıysa çalışır) -->
<script src="Js/fribase.js"></script>
</body>
</html>
