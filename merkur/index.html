<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BPC Space — Mars (Level 2)</title>
<style>
  :root{
    --hud-fg:#9ed8ff;
    --hud-ac:#18e0c6;
    --hud-bad:#ff4d6d;
    --mars:#3a1b19;          /* koyu kızıl (Mars) */
    --mars2:#5a2b22;         /* hafif degrade */
    --bar:#0b0f13;           /* letterbox */
  }
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,Segoe UI,Arial,sans-serif}
  .stage-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bar);}
  canvas{background:linear-gradient(#120d0d,var(--mars));touch-action:none;image-rendering:pixelated;image-rendering:crisp-edges}
  /* HUD */
  .hud{position:fixed;left:0;right:0;top:0;height:52px;display:flex;align-items:center;justify-content:space-between;
       padding:8px 12px;color:var(--hud-fg);font-weight:800;font-size:22px;letter-spacing:.5px;
       background:linear-gradient(180deg,#000 0%,#000a 65%,transparent 100%);user-select:none}
  .hearts{display:flex;gap:6px}
  .heart{width:18px;height:18px;border-radius:50%;background:var(--hud-bad);box-shadow:0 0 12px #000a inset}
  .gemHUD{display:flex;align-items:center;gap:6px;font-size:18px}
  .hud small{font-weight:600;opacity:.9}
  /* Overlay (Start / Game Over) */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000a;backdrop-filter:blur(4px)}
  .panel{background:#0c1116;border:1px solid #12202a;color:#d8eefc;padding:20px 22px;border-radius:14px;box-shadow:0 10px 30px #0009;text-align:center;max-width:86vw}
  .panel h1{margin:0 0 10px;font-size:26px}
  .panel p{margin:4px 0 16px;font-size:14px;opacity:.85}
  .btn{background:var(--hud-ac);color:#001417;border:0;border-radius:12px;padding:10px 18px;font-weight:900;letter-spacing:.4px;font-size:16px;cursor:pointer}
  /* 9:16 sabitleme – geniş ekranlarda yanlarda bar bırak */
  @media (min-aspect-ratio:9/16){
    .stage-wrap{padding:0 10vmin}
  }
</style>
</head>
<body>
  <div class="hud">
    <div>Babypeacock</div>
    <div><small>Score:</small> <span id="score">0</span></div>
    <div class="gemHUD">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2 3 9l9 13 9-13-9-7Z" stroke="#7de3ff" stroke-width="2" fill="#37c8ff"/></svg>
      <small id="gemT">0s</small>
    </div>
    <div class="hearts" id="hearts"></div>
  </div>

  <div class="stage-wrap">
    <canvas id="cv" width="360" height="640"></canvas>
  </div>

  <div class="overlay" id="ovr">
    <div class="panel">
      <h1>Mars Görevi</h1>
      <p>Parmağını sürükle → hareket • Basılı tutarken otomatik ateş • Elmas = <b>3’lü yayılım</b> (12s)</p>
      <button class="btn" id="startBtn">BAŞLA</button>
    </div>
  </div>

<script>
(() => {
  const W = 360, H = 640;
  const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  // --- paths (senin repo yapına göre) ---
  const IMG = {
    player: 'img/player/bpc_mini.png',
    mars_green:  'mars_enemy_green.png',
    mars_yellow: 'mars_enemy_yellow.png',
    mars_white:  'mars_enemy_white.png', // ters çevrilecek
  };

  // --- load images ---
  const loadImage = src => new Promise(res => { const i=new Image(); i.onload=()=>res(i); i.src=src; });

  // offscreen flip for white ship
  const flipImageH = (img) => {
    const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
    const x = c.getContext('2d'); x.translate(img.width,0); x.scale(-1,1); x.drawImage(img,0,0); 
    const out = new Image(); out.src = c.toDataURL(); return out;
  };

  // --- game state ---
  const state = {
    lives: 3,
    score: 0,
    time: 0,
    pressed: false,
    tripleUntil: 0,
    enemies: [],
    bullets: [],
    ebullets: [],
    gems: [],
    lastSpawn: 0,
    lastGem: 0,
    player: { x: W/2, y: H*0.8, w: 38, h: 38, speed: 0.22 },
  };

  // --- HUD helpers ---
  const heartsEl = document.getElementById('hearts');
  const scoreEl = document.getElementById('score');
  const gemEl   = document.getElementById('gemT');
  function drawHearts(){
    heartsEl.innerHTML = '';
    for(let i=0;i<state.lives;i++){ const d=document.createElement('div'); d.className='heart'; heartsEl.appendChild(d); }
  }

  // --- input (drag) ---
  let dragId = null;
  const getPos = (e) => {
    const r = cv.getBoundingClientRect();
    const t = (e.touches? e.touches[0]: e);
    return { x:(t.clientX-r.left) * (W/r.width), y:(t.clientY-r.top) * (H/r.height) };
  };
  const startDrag = e => { dragId = true; state.pressed = true; e.preventDefault(); };
  const moveDrag  = e => { if(!dragId) return;
    const {x,y} = getPos(e);
    state.player.x += (x - state.player.x)*0.35;
    state.player.y += (y - state.player.y)*0.35;
  };
  const endDrag   = e => { dragId = null; state.pressed=false; };

  cv.addEventListener('mousedown',startDrag);
  window.addEventListener('mousemove',moveDrag);
  window.addEventListener('mouseup',endDrag);
  cv.addEventListener('touchstart',startDrag,{passive:false});
  window.addEventListener('touchmove',moveDrag,{passive:false});
  window.addEventListener('touchend',endDrag);

  // --- spawn ---
  function spawnEnemy(img, speed, hp, score, fire=false){
    const w = 36, h = 30;
    const x = 30 + Math.random()*(W-60);
    state.enemies.push({x,y:-40,w,h,img,speed,hp,score,fire,cd: 120+Math.random()*60});
  }
  function spawnWave(assets){
    // kademeli zorluk
    const t = state.time/1000;
    const rate = Math.max(300 - t*8, 120); // gittikçe daha sık (min 120ms)
    if(state.time - state.lastSpawn > rate){
      state.lastSpawn = state.time;
      // yeşil/yellow/white (white biraz daha hızlı)
      const r = Math.random();
      if(r < .45) spawnEnemy(assets.green, 0.65, 1, 2, false);
      else if(r < .85) spawnEnemy(assets.yellow, 0.75, 1, 3, false);
      else spawnEnemy(assets.white, 0.95, 1, 3, true); // white ateş edebilir
    }
    // elmas (12s üçlü atış)
    if(state.time - state.lastGem > 6000){
      state.lastGem = state.time;
      state.gems.push({x:30+Math.random()*(W-60), y:-20, vy:.5, r:10, t:0});
    }
  }

  // --- bullets ---
  function shoot(){
    const p = state.player;
    if(state.tripleUntil > state.time){
      const spread = 2.2;
      state.bullets.push({x:p.x, y:p.y-18, vy:-3});
      state.bullets.push({x:p.x-10, y:p.y-14, vy:-3, vx:-spread});
      state.bullets.push({x:p.x+10, y:p.y-14, vy:-3, vx: spread});
    }else{
      state.bullets.push({x:p.x, y:p.y-18, vy:-3});
    }
  }

  let fireCD = 0;

  // --- main draw helpers ---
  function drawMarsBG(){
    // sade koyu kızıl + küçük benekler
    ctx.fillStyle = '#1b0e0e';
    ctx.fillRect(0,0,W,H);
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, '#2b1210');
    grad.addColorStop(1, '#51211c');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#2a1917';
    for(let i=0;i<180;i++){
      ctx.fillRect((i*53+ (state.time/17+i)%53)%W, (i*37+ (state.time/29+i)%37)%H, 1, 1);
    }
  }

  function drawImg(img,x,y,w,h){ ctx.drawImage(img, x-w/2, y-h/2, w, h); }

  // --- collision ---
  function hit(a,b){ return Math.abs(a.x-b.x) < (a.w/2 + b.w/2) && Math.abs(a.y-b.y) < (a.h/2 + b.h/2); }

  // --- game loop ---
  let assets=null, running=false, last=0;
  function loop(ts){
    if(!running){ last = ts; return requestAnimationFrame(loop); }
    const dt = ts-last; last=ts; state.time+=dt;

    drawMarsBG();

    // spawn
    spawnWave(assets);

    // player fire
    fireCD -= dt;
    if(state.pressed && fireCD<=0){ shoot(); fireCD = 120; } // 8.3 rps

    // update bullets
    ctx.fillStyle = '#8bd9ff';
    state.bullets = state.bullets.filter(b=>{
      b.x += (b.vx||0);
      b.y += b.vy;
      ctx.fillRect(b.x-2,b.y-6,4,12);
      return b.y>-20 && b.y<H+20 && b.x>-10 && b.x<W+10;
    });

    // enemies
    state.enemies = state.enemies.filter(e=>{
      e.y += e.speed;
      e.cd -= dt;
      // enemy shooting (white)
      if(e.fire && e.cd<=0){
        e.cd = 1200+Math.random()*900;
        state.ebullets.push({x:e.x,y:e.y+10,vy:1.2});
      }
      drawImg(e.img,e.x,e.y,e.w,e.h);
      return e.y < H+50 && e.hp>0;
    });

    // enemy bullets
    ctx.fillStyle = '#ffb3b3';
    state.ebullets = state.ebullets.filter(b=>{
      b.y += b.vy;
      ctx.fillRect(b.x-1,b.y-6,2,10);
      return b.y<H+20;
    });

    // gems
    state.gems = state.gems.filter(g=>{
      g.t += dt; g.y += g.vy;
      // elmas çizimi
      const R = g.r, x=g.x, y=g.y;
      ctx.beginPath();
      ctx.moveTo(x, y-R);
      ctx.lineTo(x+R, y);
      ctx.lineTo(x, y+R*1.2);
      ctx.lineTo(x-R, y);
      ctx.closePath();
      ctx.fillStyle = '#37c8ff';
      ctx.fill();
      ctx.strokeStyle = '#7de3ff'; ctx.lineWidth = 2; ctx.stroke();
      return g.y < H+30;
    });

    // player
    drawImg(assets.player, state.player.x, state.player.y, state.player.w, state.player.h);

    // bullet vs enemy
    for(const b of state.bullets){
      for(const e of state.enemies){
        if(hit({x:b.x,y:b.y,w:4,h:12}, e)){
          e.hp--; b.y = -999;
          if(e.hp<=0){ state.score += e.score; scoreEl.textContent = state.score; e.y = H+999; }
        }
      }
    }
    // enemy bullet or enemy touch vs player
    const P = {x:state.player.x,y:state.player.y,w:state.player.w,h:state.player.h};
    for(const eb of state.ebullets){
      if(hit(P,{x:eb.x,y:eb.y,w:6,h:12})){ eb.y=H+999; damage(); break; }
    }
    for(const e of state.enemies){
      if(hit(P,e)){ e.hp=0; e.y=H+999; damage(); break; }
    }
    // gem pickup
    for(const g of state.gems){
      if(hit(P,{x:g.x,y:g.y,w:g.r*2,h:g.r*2})){
        state.gems = state.gems.filter(gg=>gg!==g);
        state.tripleUntil = Math.max(state.tripleUntil, state.time + 12000);
      }
    }
    // gem HUD
    gemEl.textContent = (state.tripleUntil>state.time) ? Math.ceil((state.tripleUntil-state.time)/1000)+'s' : '0s';

    requestAnimationFrame(loop);
  }

  function damage(){
    state.lives--;
    drawHearts();
    if(state.lives<=0){ gameOver(); }
  }

  // --- start / over ---
  const ovr = document.getElementById('ovr');
  const startBtn = document.getElementById('startBtn');

  function reset(){
    state.lives=3; state.score=0; state.time=0; state.pressed=false;
    state.tripleUntil=0; state.enemies.length=0; state.bullets.length=0; state.ebullets.length=0; state.gems.length=0;
    state.lastSpawn=0; state.lastGem=0;
    scoreEl.textContent='0'; drawHearts();
    state.player.x=W/2; state.player.y=H*0.8;
  }
  function startGame(){ reset(); running=true; ovr.style.display='none'; }
  function gameOver(){
    running=false;
    ovr.querySelector('.panel h1').textContent = 'GAME OVER';
    ovr.querySelector('.panel p').innerHTML = 'Skor: <b>'+state.score+'</b>';
    ovr.querySelector('#startBtn').textContent = 'TEKRAR';
    ovr.style.display='flex';
  }

  startBtn.onclick = startGame;

  // --- boot: load sprites then run ---
  (async function boot(){
    const [p, g, y, w] = await Promise.all([
      loadImage(IMG.player),
      loadImage(IMG.mars_green),
      loadImage(IMG.mars_yellow),
      loadImage(IMG.mars_white),
    ]);
    assets = {
      player: p,
      green: g,
      yellow: y,
      white: flipImageH(w), // TERS ÇEVRİLMİŞ beyaz
    };
    ovr.style.display='flex';
    requestAnimationFrame(loop);
  })();

})();
</script>
</body>
</html>
