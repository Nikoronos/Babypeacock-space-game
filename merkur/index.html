<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>BPC Space ‚Äî Level 2 (Merk√ºr)</title>
  <style>
    html,body{margin:0;background:#00111d;color:#e8f1f7;font-family:system-ui,Segoe UI,Roboto,Arial}
    #wrap{max-width:420px;margin:0 auto;position:relative}
    canvas{display:block;margin:0 auto;background:#081b23;touch-action:none}
    #topbar{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:6px 10px;background:#072030}
    #score{font-weight:700}
    #lives{letter-spacing:1px}
    #hud, #over, #start{display:none; text-align:center}
    #start{padding:18px 0}
    button{cursor:pointer;background:#00e3e3;border:0;color:#003545;font-weight:800;padding:10px 16px;border-radius:10px}
    #bossbar{position:absolute;left:10px;right:10px;top:8px;height:10px;border-radius:6px;background:#1a1a1a;display:none}
    #bossfill{height:100%;background:#1fd34f;border-radius:6px;width:0%}
    .pill{background:#0c2d3f;padding:3px 8px;border-radius:999px}
  </style>
</head>
<body>
  <div id="wrap">
    <div id="topbar">
      <div><span class="pill">Babypeacock ü¶ö</span></div>
      <div id="score">SCORE: 0</div>
      <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="bossbar"><div id="bossfill"></div></div>

    <div id="start">
      <h3 style="margin:10px 0 14px">BPC Space ‚Äî Level 2 (Merk√ºr)</h3>
      <p style="opacity:.8;margin:0 0 12px">Ye≈üil & Sarƒ± d√º≈ümanlarƒ± temizle, <b>500</b> puanda B√∂l√ºm Sonu Canavarƒ± geliyor!</p>
      <button id="startBtn">BA≈ûLAT</button>
    </div>

    <canvas id="game" width="420" height="740"></canvas>

    <div id="over" style="padding:16px 0 26px">
      <div style="font-size:28px;font-weight:900;margin:8px 0 14px">GAME OVER</div>
      <button id="retryBtn">TEKRAR</button>
    </div>
  </div>

  <!-- Firebase saya√ß (senin repo yoluna g√∂re) -->
  <script src="../Js/fribase.js"></script>

  <script>
  /************** Genel Ayarlar **************/
  const BOSS_TRIGGER_SCORE = 500;     // Ka√ß puanda boss gelsin
  const WHITE_FLIP = true;            // White gemisini yatay √ßevir
  const GFX = {};                     // G√∂rseller cache
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const startUI = document.getElementById('start');
  const overUI  = document.getElementById('over');
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const startBtn = document.getElementById('startBtn');
  const retryBtn = document.getElementById('retryBtn');
  const bossbar = document.getElementById('bossbar');
  const bossfill = document.getElementById('bossfill');

  let running=false, gameOver=false, last=0;

  /************** Oyuncu **************/
  const player = { x: cvs.width/2, y: cvs.height-90, w: 28, h: 36, vx:0, speed:3.2, fireCD:0, lives:3 };
  const keys = {};
  addEventListener('keydown', e => keys[e.key]=true);
  addEventListener('keyup',   e => keys[e.key]=false);
  cvs.addEventListener('mousemove', e=>{
    const r=cvs.getBoundingClientRect();
    player.x = Math.max(14, Math.min(cvs.width-14, e.clientX - r.left));
  });

  /************** Mermiler & D√º≈ümanlar **************/
  let bullets=[], enemyBullets=[], enemies=[];
  let score=0, boss=null, bossActive=false;

  function addScore(v){ score+=v; scoreEl.textContent='SCORE: '+score; }

  /************** G√∂rselleri Y√ºkle **************/
  function loadImage(name, src){
    return new Promise(res=>{
      const img=new Image(); img.src=src; img.onload=()=>{ GFX[name]=img; res(); };
    });
  }

  async function loadAssets(){
    await loadImage('green','./mars_enemy_green.png');
    await loadImage('yellow','./mars_enemy_yellow.png');
    await loadImage('white','./mars_enemy_white.png');
    await loadImage('boss','./mars_enemy_bigger_green.png');
  }

  /************** Yardƒ±mcƒ±lar **************/
  function spawnEnemy(){
    // Boss tetiklenmi≈üse normal d√º≈üman √ßƒ±karmƒ±yoruz
    if (bossActive) return;

    // Rastgele tip: green / yellow / white
    const r = Math.random();
    let type = (r<0.45)? 'green' : (r<0.75? 'yellow' : 'white');

    // √ñzellikler
    const base = {
      type,
      x: Math.random()* (cvs.width-90) + 45,
      y: -80,
      w: 86, h: 86,
      vy: 0.7 + Math.random()*0.5,
      hp: (type==='white'? 3 : 2),
      fireT: 0
    };
    enemies.push(base);
  }

  function spawnBoss(){
    boss = {
      x: cvs.width/2, y: -130, w: 160, h: 180,
      vx: 0.9, vy: 1.2, dir: 1,
      hp: 30, enter:false, fireT: 0
    };
    bossActive = true;
    bossbar.style.display='block';
    updateBossBar();
  }

  function updateBossBar(){
    if(!boss) return;
    const p = Math.max(0, Math.min(1, boss.hp/30));
    bossfill.style.width = (p*100).toFixed(1)+'%';
  }

  function firePlayer(){
    if (player.fireCD>0) return;
    player.fireCD = 170;
    // 3'l√º atƒ±≈ü
    const bx = [player.x-10, player.x, player.x+10];
    bx.forEach(x=> bullets.push({x, y:player.y-18, vy:-4.8}));
  }

  function fireEnemy(e){
    // T√ºm d√º≈ümanlar tek atƒ±≈ü; white 2'li yanlardan
    if (e.type==='white'){
      enemyBullets.push({x:e.x-26,y:e.y+e.h*0.6, vy:2.4, col:'#ffffff'});
      enemyBullets.push({x:e.x+26,y:e.y+e.h*0.6, vy:2.4, col:'#ffffff'});
    }else{
      enemyBullets.push({x:e.x, y:e.y+e.h*0.55, vy:2.2, col:'#00ffd0'});
    }
  }

  function fireBoss(){
    if (!boss) return;
    // √áift ye≈üil lazer (biraz yaylƒ±)
    const spread = 0.55;
    const cannons = [
      {x: boss.x - boss.w*0.28, y: boss.y + boss.h*0.20},
      {x: boss.x + boss.w*0.28, y: boss.y + boss.h*0.20},
    ];
    cannons.forEach(c=>{
      enemyBullets.push({x:c.x, y:c.y, vy:3.0, vx: -spread, col:'#00ff6a'});
      enemyBullets.push({x:c.x, y:c.y, vy:3.0, vx:  spread, col:'#00ff6a'});
    });
  }

  function reset(){
    running=false; gameOver=false; last=0;
    player.x=cvs.width/2; player.y=cvs.height-90; player.lives=3; player.fireCD=0;
    bullets.length=0; enemyBullets.length=0; enemies.length=0;
    score=0; addScore(0);
    boss=null; bossActive=false;
    bossbar.style.display='none'; bossfill.style.width='0%';
    scoreEl.textContent='SCORE: 0';
    livesEl.textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
  }

  /************** Oyun Akƒ±≈üƒ± **************/
  startBtn.onclick = async ()=>{
    reset();
    // Firebase saya√ßlarƒ± (varsa)
    try{ if (window.BPC_incrementOnStart) window.BPC_incrementOnStart(); }catch(_){}
    try{ if (window.BPC_logCountryOnStart) window.BPC_logCountryOnStart(); }catch(_){}

    startUI.style.display='none';
    running=true; requestAnimationFrame(loop);
  };
  retryBtn.onclick = ()=>{ overUI.style.display='none'; startUI.style.display='block'; };

  function endGame(){
    running=false; gameOver=true;
    overUI.style.display='block';
  }

  /************** √áizim **************/
  function drawBackground(){
    // gradient yƒ±ldƒ±zlƒ± basit zemin
    ctx.fillStyle='#082831'; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.fillStyle='#0b3c49';
    for(let i=0;i<160;i++){ ctx.fillRect((i*33)%cvs.width, (i*21)%cvs.height, 2,2); }
  }

  function drawPlayer(){
    ctx.fillStyle='#00e3fd';
    ctx.beginPath();
    ctx.moveTo(player.x, player.y-18);
    ctx.lineTo(player.x-14, player.y+18);
    ctx.lineTo(player.x+14, player.y+18);
    ctx.closePath(); ctx.fill();
  }

  function drawEnemy(e){
    if (e.type==='white' && WHITE_FLIP){
      const img=GFX.white;
      ctx.save();
      ctx.translate(e.x, e.y);
      ctx.scale(-1,1);
      ctx.drawImage(img, -e.w/2, -e.h/2, e.w, e.h);
      ctx.restore();
    }else{
      const img = e.type==='green' ? GFX.green : (e.type==='yellow' ? GFX.yellow : GFX.white);
      ctx.drawImage(img, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
    }
  }

  function drawBoss(){
    if (!boss) return;
    ctx.drawImage(GFX.boss, boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h);
  }

  /************** √áarpƒ±≈üma **************/
  function hitRectPoint(rx,ry,rw,rh, px,py){
    return (px>rx && px<rx+rw && py>ry && py<ry+rh);
  }

  /************** Oyun D√∂ng√ºs√º **************/
  function loop(t){
    if (!running) return;
    const dt = Math.min(50, t-(last||t)); last=t;

    // Arka plan
    drawBackground();

    // Oyuncu hareket
    if (keys['ArrowLeft'])  player.x -= player.speed;
    if (keys['ArrowRight']) player.x += player.speed;
    player.x = Math.max(14, Math.min(cvs.width-14, player.x));

    // Oyuncu otomatik ate≈ü
    if (player.fireCD>0) player.fireCD -= dt;
    firePlayer();

    // Mermileri g√ºncelle & √ßiz
    ctx.fillStyle='#ffe06a';
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; b.y += b.vy;
      ctx.fillRect(b.x-2, b.y-6, 4, 8);
      if (b.y<-10) bullets.splice(i,1);
    }

    // D√º≈üman spawn
    if (!bossActive && Math.random()<0.022) spawnEnemy();
    if (!bossActive && score >= BOSS_TRIGGER_SCORE){
      enemies.length=0; spawnBoss();
    }

    // D√º≈üman g√ºncelle/√ßiz/ate≈ü
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      e.y += e.vy;
      // k√º√ß√ºk sin dalgasƒ±
      e.x += Math.sin(t*0.003 + i)*0.6;

      // Ate≈ü
      e.fireT -= dt;
      if (e.fireT<=0){
        e.fireT = (e.type==='yellow'? 1100: 1400) + Math.random()*600;
        fireEnemy(e);
      }

      // √áiz
      drawEnemy(e);

      // Oyuncu mermisi √ßarpƒ±≈üma
      for(let k=bullets.length-1;k>=0;k--){
        const b=bullets[k];
        if (hitRectPoint(e.x-e.w/2, e.y-e.h/2, e.w, e.h, b.x, b.y)){
          bullets.splice(k,1);
          if(--e.hp<=0){ enemies.splice(i,1); addScore(10); }
          break;
        }
      }

      // A≈üaƒüƒ± d√º≈üerse sil
      if (e.y - e.h/2 > cvs.height+40){ enemies.splice(i,1); }
    }

    // Boss hareket / giri≈ü
    if (bossActive && boss){
      if (!boss.enter){
        boss.y += boss.vy;
        if (boss.y > 140){ boss.enter=true; }
      }else{
        boss.x += boss.vx*boss.dir;
        if (boss.x < 80 || boss.x > cvs.width-80) boss.dir *= -1;

        boss.fireT -= dt;
        if (boss.fireT<=0){
          boss.fireT = 900;
          fireBoss();
        }
      }
      drawBoss();

      // Boss'a hasar
      for(let k=bullets.length-1;k>=0;k--){
        const b=bullets[k];
        if (hitRectPoint(boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h, b.x, b.y)){
          bullets.splice(k,1);
          boss.hp--; updateBossBar();
          if (boss.hp<=0){
            bossActive=false; boss=null;
            bossbar.style.display='none';
            // Level 2 bitti -> tebrik ekranƒ±
            running=false;
            overUI.querySelector('div').textContent='LEVEL 2 Bƒ∞TTƒ∞! üéâ';
            overUI.style.display='block';
          }
        }
      }
    }

    // D√º≈üman mermileri (oyuncuya)
    for(let i=enemyBullets.length-1;i>=0;i--){
      const b=enemyBullets[i];
      b.y += b.vy; b.x += (b.vx||0);
      ctx.fillStyle = b.col || '#ff3b3b';
      ctx.fillRect(b.x-2, b.y-6, 4, 8);

      if (hitRectPoint(player.x-14, player.y-18, 28, 36, b.x, b.y)){
        enemyBullets.splice(i,1);
        player.lives--;
        livesEl.textContent = (player.lives<=0)? 'üíî' : '‚ù§Ô∏è'.repeat(player.lives);
        if (player.lives<=0) return endGame();
      }else if (b.y>cvs.height+12 || b.x<-12 || b.x>cvs.width+12){
        enemyBullets.splice(i,1);
      }
    }

    // Oyuncu
    drawPlayer();

    requestAnimationFrame(loop);
  }

  // ƒ∞lk ekran
  (async function init(){
    await loadAssets();
    startUI.style.display='block';
  })();
  </script>
</body>
</html>
