<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>BPC ‚Äì Mars (Level 2)</title>
<style>
  :root{ --hud:56px; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:#e6f0ff;font-family:system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:5;height:var(--hud);display:flex;align-items:center;gap:10px;padding:8px 12px;background:#04070c}
  .brand{color:#8fb6ff;font-weight:800;font-size:clamp(16px,5.2vw,26px)}
  .tag{opacity:.85;font-size:clamp(12px,3.6vw,16px)}
  #score{font-weight:800}
  #hearts{margin-left:auto;font-size:clamp(18px,5vw,24px);letter-spacing:2px}
  #game{display:block;width:100vw;height:calc(100svh - var(--hud));touch-action:none;background:#000}
  .ov{position:fixed;inset:var(--hud) 0 0 0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.5));z-index:10}
  .card{background:#0f131a;border:1px solid #1f2a37;border-radius:16px;width:min(92vw,380px);padding:20px;text-align:center}
  .btn{background:#14b8a6;color:#031014;border:none;border-radius:12px;padding:12px 18px;font-weight:800;font-size:clamp(16px,4.6vw,18px)}
  .hint{opacity:.8;margin-top:10px;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">Babypeacock ü¶ö</div>
  <div class="tag">Mars (Level 2)</div>
  <div class="tag">Score:</div><div id="score">0</div>
  <div class="tag">üíé <span id="gems">0</span>s</div>
  <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
</header>

<canvas id="game"></canvas>

<div id="startOv" class="ov">
  <div class="card">
    <h3 style="margin:.2em 0 .6em">Mars G√∂revi</h3>
    <div style="opacity:.9;margin:.2em 0 .9em">
      Green 2p ‚Ä¢ Yellow 3p ‚Ä¢ White 3p ‚Ä¢ Red 5p<br>üíé = 15sn √º√ßl√º ate≈ü
    </div>
    <button id="startBtn" class="btn">START</button>
    <div class="hint">Parmaƒüƒ±nla s√ºr√ºkle ‚Äî atƒ±≈ü otomatik</div>
  </div>
</div>

<div id="overOv" class="ov" style="display:none">
  <div class="card">
    <h3>GAME OVER</h3>
    <div style="margin:8px 0 16px">Skor: <b id="final">0</b></div>
    <button id="retryBtn" class="btn">RETRY</button>
  </div>
</div>

<script>
const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
let W=0,H=0,DPR=1;
function fit(){
  DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
  const h = Math.max(460, innerHeight - document.querySelector('header').offsetHeight);
  cvs.style.width=innerWidth+'px'; cvs.style.height=h+'px';
  cvs.width=(innerWidth*DPR)|0; cvs.height=(h*DPR)|0; ctx.setTransform(DPR,0,0,DPR,0,0);
  W=innerWidth; H=h;
}
addEventListener('resize',fit);

/* ------------ ASSETS (beyaz zemin temizleme) ------------- */
function stripWhite(img, thr=245){ // -> HTMLImageElement (transparan)
  const off=document.createElement('canvas'), oc=off.getContext('2d');
  off.width=img.naturalWidth; off.height=img.naturalHeight; oc.drawImage(img,0,0);
  const d=oc.getImageData(0,0,off.width,off.height); const a=d.data;
  for(let i=0;i<a.length;i+=4){
    if (a[i] > thr && a[i+1] > thr && a[i+2] > thr) a[i+3]=0;
  }
  oc.putImageData(d,0,0);
  const out=new Image(); out.src=off.toDataURL(); return out;
}
function load(url){return new Promise(res=>{const i=new Image(); i.onload=()=>res(i); i.src=url;});}

const paths = {
  player:'../img/player/bpc_mini.png',
  green :'../mars_enemy_green.png',
  yellow:'../mars_enemy_yellow.png',
  white :'../mars_enemy_white.png',
  red   :'../bpc_enemy_red.png'
};
const GFX = {};
async function loadAll(){
  const [p,g,y,w,r] = await Promise.all([paths.player,paths.green,paths.yellow,paths.white,paths.red].map(load));
  GFX.player=p;
  GFX.green = stripWhite(g,240);
  GFX.yellow= stripWhite(y,240);
  GFX.white = stripWhite(w,240);
  GFX.red   = stripWhite(r,240);
}

/* ----------------- STATE ---------------- */
let running=false, t=0, score=0, lives=3;
let bullets=[], enemies=[], eBullets=[], parts=[], gems=[];
let spawnGap=0, tripleUntil=0;

const scoreEl=document.getElementById('score');
const heartsEl=document.getElementById('hearts');
const gemsEl=document.getElementById('gems');

const player={x:0,y:0,w:44,h:44,cd:0,rate:120,spd:480};

/* ------------- INPUT ------------- */
let ptr=null;
cvs.addEventListener('pointerdown',e=>{ptr=e.pointerId; move(e);});
cvs.addEventListener('pointermove',e=>{if(ptr===e.pointerId) move(e);});
addEventListener('pointerup',e=>{if(ptr===e.pointerId) ptr=null;});
function move(e){
  const r=cvs.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  player.x=Math.max(player.w*.5,Math.min(W-player.w*.5,x));
  player.y=Math.max(player.h*.5,Math.min(H-player.h*.5,y));
}

/* ------------- HELPERS ------------- */
const R=(a,b)=>Math.random()*(b-a)+a;
const CL=(v,a,b)=>v<a?a:v>b?b:v;
function boom(x,y,c,n=16){for(let i=0;i<n;i++) parts.push({x,y,vx:R(-140,140),vy:R(-240,40),r:R(2,4),life:R(320,580),c});}

/* ------------- BACKGROUND (Mars kum + benek) ------------- */
let bg=0;
function drawMars(dt){
  bg += dt*40;
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#5a2416'); g.addColorStop(1,'#7a3823');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(0,0,0,.22)';
  for(let i=0;i<70;i++){
    const x=(i*83.7+(bg*.8))%(W+30)-15;
    const y=(i*57.3*1.1+(bg*1.1))%(H+30)-15;
    ctx.fillRect(x,y,2,2);
  }
}

/* ------------- GAME FLOW ------------- */
function reset(){
  bullets.length=enemies.length=eBullets.length=parts.length=gems.length=0;
  score=0; lives=3; spawnGap=0; tripleUntil=0; t=performance.now();
  scoreEl.textContent=0; heartsEl.textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
  const base=Math.max(36,Math.min(54,W*0.11)); player.w=player.h=base; player.x=W*.5; player.y=H-80;
}

const SPEC={
  green :{hp:1, sp:[70,120],  fire:false, pts:2},
  yellow:{hp:1, sp:[90,160],  fire:true, rate:950,  bullet:'#facc15', dual:false, pts:3},
  white :{hp:2, sp:[80,140],  fire:true, rate:950,  bullet:'#f1f1f1', dual:true,  pts:3},
  red   :{hp:3, sp:[80,130],  fire:true, rate:750,  bullet:'#ff3b3b', dual:false, pts:5}
};
function spawnEnemy(){
  const bag=['green','green','yellow','white']; if(score>120) bag.push('red'); if(score>260) bag.push('red');
  const t=bag[(Math.random()*bag.length)|0], sp=SPEC[t].sp;
  enemies.push({t,x:R(26,W-26),y:-50,vy:R(sp[0],sp[1]),hp:SPEC[t].hp,cd:0});
}
function loop(now){
  if(!running) return;
  const dt=(now-t)/1000; t=now;

  drawMars(dt);

  // player fire
  player.cd -= dt*1000;
  if(player.cd<=0){
    player.cd=player.rate;
    const triple = now<tripleUntil;
    (triple?[-10,0,10]:[0]).forEach(dx=>{
      bullets.push({x:player.x+dx,y:player.y-player.h*.5-6,vy:-520,c:'#7fd8ff'});
    });
  }
  ctx.drawImage(GFX.player,player.x-player.w/2,player.y-player.h/2,player.w,player.h);

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y+=b.vy*dt; ctx.fillStyle=b.c; ctx.fillRect(b.x-2,b.y-10,4,12);
    if(b.y<-20) bullets.splice(i,1);
  }

  // spawn pace
  spawnGap -= dt;
  if(spawnGap<=0){
    spawnEnemy();
    spawnGap = CL(0.95 * (1 - score/900), 0.28, 0.95);
  }

  // enemies
  const ew=CL(W*0.12,34,56), eh=ew;
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i], s=SPEC[e.t]; e.y+=e.vy*dt;

    // fire
    if(s.fire){
      e.cd -= dt*1000;
      if(e.cd<=0 && e.y>30){
        e.cd = s.rate * CL(1 - score/900, .55, 1);
        if(s.dual){
          eBullets.push({x:e.x-14,y:e.y+eh*.35,vy:240,c:s.bullet});
          eBullets.push({x:e.x+14,y:e.y+eh*.35,vy:240,c:s.bullet});
        }else eBullets.push({x:e.x,y:e.y+eh*.35,vy:(e.t==='red'?320:260),c:s.bullet});
      }
    }

    ctx.drawImage(GFX[e.t], e.x-ew/2, e.y-eh/2, ew, eh);

    // collide player
    if (Math.abs(e.x-player.x)<(ew+player.w)*.42 && Math.abs(e.y-player.y)<(eh+player.h)*.42){
      enemies.splice(i,1); boom(e.x,e.y,'#ff6b6b',18); hit(); continue;
    }
    if(e.y>H+60){ enemies.splice(i,1); continue; }

    // hit by bullet
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if (Math.abs(b.x-e.x)<ew*.45 && Math.abs(b.y-e.y)<eh*.45){
        bullets.splice(j,1); e.hp--;
        if(e.hp<=0){
          const col=e.t==='green'?'#86efac':e.t==='yellow'?'#facc15':e.t==='white'?'#e5e7eb':'#ff6b6b';
          boom(e.x,e.y,col,20); enemies.splice(i,1);
          score += s.pts; scoreEl.textContent=score;
        }
        break;
      }
    }
  }

  // enemy bullets
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i]; b.y+=b.vy*dt; ctx.fillStyle=b.c; ctx.fillRect(b.x-2,b.y-6,4,10);
    if(b.y>H+20){ eBullets.splice(i,1); continue; }
    if(Math.abs(b.x-player.x)<player.w*.35 && Math.abs(b.y-player.y)<player.h*.35){ eBullets.splice(i,1); hit(); }
  }

  // particles
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i]; p.life-=dt*1000; if(p.life<=0){parts.splice(i,1); continue;}
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=120*dt; ctx.globalAlpha=Math.max(0,p.life/600);
    ctx.fillStyle=p.c; ctx.fillRect(p.x-2,p.y-2,4,4); ctx.globalAlpha=1;
  }

  // diamonds (en fazla 2)
  if(gems.length<2 && Math.random()< (0.001 + Math.min(0.0015, score/12000))){
    gems.push({x:R(24,W-24),y:-20,vy:110});
  }
  for(let i=gems.length-1;i>=0;i--){
    const d=gems[i]; d.y+=d.vy*dt; ctx.font='22px system-ui'; ctx.fillStyle='#9ee5ff'; ctx.fillText('üíé', d.x-10, d.y+6);
    if(d.y>H+30){ gems.splice(i,1); continue; }
    if(Math.abs(d.x-player.x)<18 && Math.abs(d.y-player.y)<18){ gems.splice(i,1); tripleUntil=performance.now()+15000; }
  }
  gemsEl.textContent=Math.max(0,Math.floor((tripleUntil-now)/1000));

  requestAnimationFrame(loop);
}

function hit(){
  lives--; heartsEl.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));
  boom(player.x,player.y,'#ff6961',22);
  if(lives<=0){ running=false; document.getElementById('final').textContent=score; document.getElementById('overOv').style.display='grid'; }
}

/* ------------- START/RETRY ------------- */
async function start(){
  document.getElementById('startOv').style.display='none';
  document.getElementById('overOv').style.display='none';
  fit(); if(!GFX.player) await loadAll(); reset(); running=true; requestAnimationFrame(loop);
}
document.getElementById('startBtn').onclick=start;
document.getElementById('retryBtn').onclick=start;

fit();
</script>
</body>
</html>
