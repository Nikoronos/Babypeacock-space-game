<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Babypeacock ‚Äî BPC Space Game</title>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  
  /* UI ELEMENTLERƒ∞ */
  #brand{display:none; position:fixed;top:max(6px,env(safe-area-inset-top));left:max(12px,env(safe-area-inset-left));z-index:10;font-weight:900;
    background:linear-gradient(90deg,#22d3ee,#34d399);-webkit-background-clip:text;background-clip:text;color:transparent}
  #score{display:none; position:fixed;top:max(8px,env(safe-area-inset-top));left:0;right:0;text-align:center;color:#00ffc8;font-weight:700;z-index:10}
  #power{display:none; position:fixed;top:max(8px,env(safe-area-inset-top));right:max(10px,env(safe-area-inset-right));color:#a7f3d0;font-weight:700;z-index:10}
  #lives{display:none; position:fixed;bottom:max(60px,env(safe-area-inset-bottom));left:0;right:0;text-align:center;color:#f87171;font-weight:700;z-index:10}

  /* PAUSE BUTONU */
  #pauseBtn{
    display:none; position:fixed;left:50%;transform:translateX(-50%);bottom:max(15px,env(safe-area-inset-bottom));z-index:50;
    width:36px;height:36px; background:#0f172a;border:2px solid #38bdf8;color:#38bdf8;border-radius:50%;
    font-size:14px;font-weight:900;align-items:center;justify-content:center;cursor:pointer;
    box-shadow:0 0 8px rgba(56,189,248,0.4)
  }

  /* OVERLAYLER */
  #startOverlay,#gameOver,#pauseOverlay,#countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:60}
  #startOverlay{background:rgba(0,0,0,0.7);color:#fff;display:flex;overflow:hidden}
  #pauseOverlay{background:rgba(0,0,0,0.8);color:#fff;backdrop-filter:blur(3px)}
  
  /* LOGO & SLOGAN */
  #startLogo {
    width: 90px; height: 90px; border-radius: 50%; border: 3px solid #22d3ee;
    box-shadow: 0 0 25px rgba(34, 211, 238, 0.5), inset 0 0 10px rgba(34, 211, 238, 0.3);
    object-fit: cover; margin-bottom: 8px; animation: floatLogo 3.5s ease-in-out infinite;
  }
  @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  .slogan {
    font-size: 15px; font-style: italic;
    background: linear-gradient(90deg, #a7f3d0, #22d3ee); -webkit-background-clip: text; background-clip: text; color: transparent;
    margin-bottom: 25px; font-weight: 600; letter-spacing: 0.5px; text-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
  }

  /* GAME OVER */
  #gameOver { background: transparent; justify-content: flex-start; padding-top: 40vh; overflow-y: auto; }
  #mondayChampBox {
    display: none; flex-direction: column; align-items: center; margin-bottom: 10px; padding: 8px 15px;
    background: rgba(250, 204, 21, 0.15); border: 1px solid #facc15; border-radius: 8px; 
    box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); width: min(320px, 80vw); text-align: center; backdrop-filter: blur(5px);
  }
  .champ-label { color:#facc15;font-size:11px;font-weight:800;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px; }
  .champ-name { color:#fff;font-size:15px;font-weight:900;margin-bottom:4px;text-shadow:0 0 5px rgba(255,255,255,0.5); }
  #winnerSecret {
    display: none; font-family: monospace; color:#00ffc8;font-size:13px;font-weight:bold;
    background:#000;padding:4px 8px;border-radius:4px;border:1px dashed #00ffc8; margin-top:4px;
  }
  #countdownOverlay{background:transparent;pointer-events:none;z-index:70}
  #cntText{font-size:90px;font-weight:900;color:#fff;text-shadow:0 0 25px #22d3ee;font-family:monospace}
  @keyframes popIn{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}
  .btn{padding:12px 32px;border:1px solid #00ffc8;background:#0b1220;color:#00ffc8;border-radius:12px;font-weight:900;z-index:60;font-size:16px;cursor:pointer;margin-bottom:5px;box-shadow:0 0 20px rgba(0,255,200,0.4);}
  
  #soundToggle {
    margin-top: 20px; width: 44px; height: 44px; border-radius: 50%;
    border: 1px solid rgba(34, 211, 238, 0.5); background: rgba(15, 23, 42, 0.6);
    color: #22d3ee; font-size: 20px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; backdrop-filter: blur(4px); transition: all 0.3s ease; z-index: 100;
  }
  #soundToggle:hover { background: rgba(34, 211, 238, 0.15); box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); transform: scale(1.05); }

  #bpc-top10 {
    width: min(380px, 90vw); background: rgba(5, 5, 5, 0.9); border: 1px solid #333; 
    border-radius: 10px; padding: 10px; color: #fff; font-size: 13px; line-height: 1.4; margin-top: 10px; margin-bottom: 40px;
  }
  #bpc-top10 h4{margin:0 0 5px 0;font-size:12px;font-weight:800;text-align:center;color:#e2e8f0;letter-spacing:.5px;}
  #week-timer{text-align:center;font-size:11px;color:#94a3b8;margin-bottom:6px;font-weight:600;border-bottom:1px dashed #333;padding-bottom:4px}
  #bpc-top10 ol { margin:0; padding:0; list-style:none; max-height: 35vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 5px; } 
  #bpc-top10 ol::-webkit-scrollbar { width: 4px; }
  #bpc-top10 ol::-webkit-scrollbar-track { background: #111; border-radius: 2px; }
  #bpc-top10 ol::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
  #bpc-top10 li { margin-bottom:4px;display:flex;align-items:center;border-bottom:1px solid #222;padding-bottom:2px;color:#fff; }
  .rank-num { display:inline-block;width:25px;text-align:right;margin-right:8px;color:#94a3b8;font-weight:bold;font-family:monospace; }
  #bpc-top10 .me{color:#ff5c5c;font-weight:bold} 
  #bpc-top10 .me .rank-num{color:#ff5c5c}
  #globalCounterBox { margin-top:5px;font-size:12px;opacity:.9;text-align:center;color:#cbd5e1;text-shadow:0 2px 4px #000; }
  #globalCounterBox::before { content: "üåç "; }
  
  /* ARKA PLAN */
  canvas {
    display: block; margin: 0 auto;
    background: radial-gradient(circle at bottom, #0f172a 0%, #020617 50%, #000000 90%);
    touch-action: none; user-select: none; width: 100%; height: 100%
  }
</style>
</head>
<body>
  <div id="brand">Babypeacock ü¶ö</div>
  <div id="score">ü¶ö Score: <span id="sc">0</span></div>
  <div id="power">üíé <span id="px">0</span>s</div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="pauseBtn">II</div>

  <div id="startOverlay">
    <img id="startLogo" src="yc3ku6.jpg" alt="BPC Logo">
    <div class="slogan">From feather to flight</div>
    <div style="margin-bottom:12px;font-size:14px;color:#ccc;">Hold & drag to move</div>
    <button id="startBtn" class="btn">START GAME</button>
    <div id="playerCode" style="margin-top:15px;font-size:14px;color:#00ffc8;"></div>
    <div id="soundToggle">üîä</div>
  </div>

  <div id="pauseOverlay">
    <div style="font-size:32px;font-weight:900;margin-bottom:15px;color:#e2e8f0;letter-spacing:2px;">PAUSED</div>
    <button id="resumeBtn" class="btn">RESUME</button>
  </div>

  <div id="countdownOverlay"><div id="cntText"></div></div>

  <div id="gameOver">
    <div id="mondayChampBox">
      <div class="champ-label">üëë Week <span id="mc-week">--</span> Champion</div>
      <div class="champ-name" id="mc-name">Loading...</div>
      <div id="winnerSecret">CODE: <span id="mc-code">---</span></div>
    </div>
    <button id="restart" class="btn">Restart</button>
    <div id="globalCounterBox">Global plays: <span id="globalCounter">‚Ä¶</span></div>
    <div id="bpc-top10" style="display:none">
      <h4>üèÜ Weekly Top 20</h4>
      <div id="week-timer">Week <span id="wk-num">--</span> ‚Ä¢ <span id="wk-rem" style="color:#facc15">--:--:--</span></div>
      <ol id="bpc-list"></ol>
    </div>
  </div>

  <canvas id="game"></canvas>

<script>
/* ====== AUDIO ====== */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioContext();
let soundEnabled = localStorage.getItem("bpc_sound") !== "0"; 
const soundBtn = document.getElementById("soundToggle");

function updateSoundIcon() {
  soundBtn.textContent = soundEnabled ? "üîä" : "üîá";
  soundBtn.style.opacity = soundEnabled ? "1" : "0.5";
  soundBtn.style.boxShadow = soundEnabled ? "0 0 15px rgba(34, 211, 238, 0.4)" : "none";
}
updateSoundIcon();

soundBtn.onclick = (e) => {
  e.stopPropagation(); 
  soundEnabled = !soundEnabled;
  localStorage.setItem("bpc_sound", soundEnabled ? "1" : "0");
  updateSoundIcon();
  if(soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
};

function playLaser() {
  if (!soundEnabled || !audioCtx) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.type = 'triangle'; osc.frequency.setValueAtTime(350, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.08, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}
function playBoom() {
  if (!soundEnabled || !audioCtx) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
  gain.gain.setValueAtTime(0.15, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
  osc.start(); osc.stop(audioCtx.currentTime + 0.3);
}
function playLifeSound() {
  if (!soundEnabled || !audioCtx) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.15); 
  gain.gain.setValueAtTime(0.08, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  osc.start(); osc.stop(audioCtx.currentTime + 0.2);
}
function playGemSound() { playLifeSound(); }

/* ====== GAME SETUP ====== */
const cv=document.getElementById("game");
function resize(){ cv.width=window.innerWidth; cv.height=window.innerHeight; }
window.addEventListener('resize', resize); resize();
const ctx=cv.getContext("2d"); ctx.imageSmoothingEnabled=false;

const uiBrand = document.getElementById("brand");
const uiScore = document.getElementById("score");
const uiPower = document.getElementById("power");
const uiLives = document.getElementById("lives");
const uiPause = document.getElementById("pauseBtn");

const scEl=document.getElementById("sc"),pxEl=document.getElementById("px"),livesEl=document.getElementById("lives");
const startOverlay=document.getElementById("startOverlay"),startBtn=document.getElementById("startBtn");
const overEl=document.getElementById("gameOver"),restartBtn=document.getElementById("restart");
const top10Box=document.getElementById("bpc-top10");
const pauseBtn=document.getElementById("pauseBtn"), pauseOverlay=document.getElementById("pauseOverlay"), resumeBtn=document.getElementById("resumeBtn");
const countOverlay=document.getElementById("countdownOverlay"), cntText=document.getElementById("cntText");
const mondayBox = document.getElementById("mondayChampBox"), mcWeek = document.getElementById("mc-week"), mcName = document.getElementById("mc-name"), mcSecretBox = document.getElementById("winnerSecret"), mcCode = document.getElementById("mc-code");

function clamp(v,a,b){return v<a?a:v>b?b:v;}
function rand(a,b){return a+Math.random()*(b-a);}
function rectHit(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);}
function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=src;});}

/* Siyah Silici - G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON (TH=90) */
function keyOutDark(img, TH=90){
  const w=img.width,h=img.height;
  const off=document.createElement('canvas'); off.width=w; off.height=h;
  const g=off.getContext('2d'); g.drawImage(img,0,0); 
  const d=g.getImageData(0,0,w,h), a=d.data;
  for(let i=0;i<a.length;i+=4){
    const r=a[i], g1=a[i+1], b=a[i+2];
    if(r<TH && g1<TH && b<TH) a[i+3]=0;
  }
  g.putImageData(d,0,0); return off;
}

const PLAYER_SRC="img/player/bpc_mini.png";
const PEACOCK_SRC="yc3ku6.jpg";

/* === SPRITE CONFIG === */
const SPRITE_CONFIG = {
  ufo_red: { src: "ufo_red_sprite.png", frames: 85 },
  green:   { src: "bpc_enemy_green_sprite.png", frames: 60 }, 
  ufo_gray:{ src: "ufo_gray_sprite.png", frames: 60 },
  red:     { src: "bpc_enemy_red_sprite.png", frames: 60 } 
};

let bullets=[], enemies=[], enemyBullets=[], gems=[], mascots=[], particles=[];
let score=0,lives=3,started=false,gameOver=false,paused=false,inCountdown=false;
let powerTime=0, fireTimer=0, FIRE_MS=170;
let elapsed=0,enT=0,gemT=0,mascotT=0;
let scoreSent=false;
let player={x:cv.width/2-33,y:cv.height-140,w:66,h:66};

function getPlayerCode(){ let c=localStorage.getItem("playerCode"); if(!c){c="BPC"+Math.floor(100000+Math.random()*899999);localStorage.setItem("playerCode",c);} return c; }
const myCode=getPlayerCode();
(function(){const box=document.getElementById("playerCode");if(box)box.innerHTML=`üë§ Player: <b>${myCode}</b>`;})();

let playId=Math.floor(performance.now()+Math.random()*1e9);
let verifyCode="--------";
async function makeCode(){
  const t=Math.floor(Date.now()/1000);
  const msg=new TextEncoder().encode(playId+"|"+t+"|babypeacock");
  const buf=await crypto.subtle.digest("SHA-256",msg);
  verifyCode=[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,8).toUpperCase();
}
makeCode();

const starsA=[], starsB=[];
for(let i=0;i<25;i++) starsA.push({x:rand(0,cv.width),y:rand(0,cv.height), sp:rand(0.2,0.4)});
for(let i=0;i<15;i++) starsB.push({x:rand(0,cv.width),y:rand(0,cv.height), sp:rand(0.7,1.1)});

function startCountdownSequence(callback) {
  inCountdown=true; countOverlay.style.display="flex"; let count=3;
  const showNum=(num)=>{cntText.textContent=num;cntText.style.animation='none';cntText.offsetHeight;cntText.style.animation='popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275)';};
  showNum(3);
  const timer=setInterval(()=>{count--;if(count>0)showNum(count);else if(count===0)showNum("GO!");else{clearInterval(timer);countOverlay.style.display="none";inCountdown=false;if(callback)callback();}},800);
}

function initGame(){
  if(started)return;
  const doc=document.documentElement; 
  try{if(doc.requestFullscreen)doc.requestFullscreen();else if(doc.webkitRequestFullscreen)doc.webkitRequestFullscreen();}catch(e){}
  if(audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }

  startOverlay.style.display="none"; 
  uiBrand.style.display = "block"; uiScore.style.display = "block"; uiPower.style.display = "block"; uiLives.style.display = "block";
  
  startCountdownSequence(()=>{
    started=true; paused=false; uiPause.style.display="flex";
    player.y=cv.height-140; player.x=cv.width/2-player.w/2;
  });
}
startBtn.onclick=initGame;

pauseBtn.onclick=()=>{if(!started||gameOver||inCountdown)return;paused=true;pauseOverlay.style.display="flex";uiPause.style.display="none";};
resumeBtn.onclick=()=>{pauseOverlay.style.display="none";startCountdownSequence(()=>{paused=false;uiPause.style.display="flex";});};

function updateLives(){livesEl.innerHTML="‚ù§Ô∏è".repeat(lives);} updateLives();

let holding=false;
function getX(e){return (e.clientX??(e.touches?e.touches[0].clientX:0))-cv.getBoundingClientRect().left;}
cv.addEventListener("pointerdown",e=>{if(!started||paused||inCountdown)return;holding=true;player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w);});
cv.addEventListener("pointermove",e=>{if(!holding||paused||inCountdown)return;player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w);});
cv.addEventListener("pointerup",()=>holding=false); cv.addEventListener("pointercancel",()=>holding=false);

function shoot(){
  playLaser(); 
  if(powerTime>0){ bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10}); bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:3}); bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:-3}); }
  else { bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10}); }
}

function drawDiamondGem(ctx,x,y,w,h,t){ctx.save();ctx.translate(x+w/2,y+h/2);ctx.rotate(Math.sin(t*2)*0.20);
  const W=w*0.9,H=h*0.9;ctx.shadowColor="rgba(56,189,248,.7)";ctx.shadowBlur=14;
  const grad=ctx.createLinearGradient(-W/2,0,W/2,0);grad.addColorStop(0,"#baf2ff");grad.addColorStop(0.5,"#60e8ff");grad.addColorStop(1,"#99f6e4");
  ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(0,-H*0.5);ctx.lineTo(W*0.48,0);ctx.lineTo(0,H*0.56);ctx.lineTo(-W*0.48,0);ctx.closePath();ctx.fill();
  ctx.shadowBlur=0;ctx.lineWidth=1.8;ctx.strokeStyle="#0e7490";ctx.stroke();ctx.restore();}

function spawnGem(){ if(powerTime>0) return; const s=22; gems.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.5}); }

function spawnMascot(){ 
  let dyn = 1; if(score > 2000){ const over = score - 2000; dyn = 1 + over * 0.0006; dyn = Math.min(dyn, 2.0); }
  if(score >= 300 && score < 800 && Math.random() < 0.60) return;
  if(score >= 800 && score < 1300 && Math.random() < 0.90) return;
  if(score >= 1300 && score < 1500 && Math.random() < 0.95) return;
  if(score >= 1500 && Math.random() < 0.98) return;
  if(score > 2000 && Math.random() < (0.98 * dyn)) return;
  const s=22; mascots.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.4}); 
}

function explosion(x,y,count=18){
  playBoom(); 
  const left=Math.max(0,120-particles.length);const n=Math.min(count,left);
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,sp=1.2+Math.random()*2.8;particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:420+Math.random()*280,size:1.6+Math.random()*2.4});}
}

function allowedKindsByTime(t){
  // METEOR KALDIRILDI
  if(t<10) return ["ufo_red","ufo_gray"]; 
  if(t<40) return ["ufo_red","ufo_gray","green"]; 
  return ["ufo_red","ufo_gray","green","red"];
}

function spawnEnemy(k, spMul){ 
  const enemyCap = (score >= 1500) ? 22 : (score >= 1300) ? 20 : (score >= 800)  ? 18 : (score >= 500)  ? 14 : 12;
  if(enemies.length > enemyCap) return; 
  
  // KIND'I √ñNCE BELƒ∞RLE
  const kind=k[Math.floor(Math.random()*k.length)]; 
  
  // BOYUT BELƒ∞RLEME
  let size=rand(48,70); 
  // EƒûER KIRMIZI GEMƒ∞ ƒ∞SE DAHA K√ú√á√úK YAP
  if(kind === "red") {
     size = rand(38, 52); // Daha kibar boyut
  }

  // SPRITE Sƒ∞STEMƒ∞
  let isSprite = false, img = null, frames = 1;
  
  if (loadedSprites[kind]) {
    img = loadedSprites[kind].img;
    frames = loadedSprites[kind].frames;
    isSprite = (frames > 1);
  }
  
  enemies.push({
    x:rand(0,cv.width-size),y:-size,w:size,h:size,vy:rand(1.4,3) * spMul,
    kind, img, isSprite,
    frame:0, frameTimer:0, totalFrames: frames,
    canShoot:(kind==="red"||kind==="green"), 
    shootT:0,shootInt:500
  }); 
}

function enemyShoot(e){ 
  if(!e.canShoot) return; const cx=e.x+e.w/2; 
  let dyn = 1; if(score > 2000){ const over = score - 2000; dyn = 1 + over * 0.0006; dyn = Math.min(dyn, 2.0); }
  const mul = (score >= 1500) ? 1.78 : (score >= 1300) ? 1.60 : (score >= 800)  ? 1.45 : (score >= 500)  ? 1.20 : (score >= 300)  ? 1.10 : 1.00;
  const finalMul = mul * dyn;
  
  if(e.kind==="red") enemyBullets.push({x:cx-2,y:e.y+e.h,w:4,h:12,vy:6*finalMul,color:"#ef4444"});
  else enemyBullets.push({x:cx-1,y:e.y+e.h,w:2,h:18,vy:6.5*finalMul,color:"#22c55e"}); 
}

function renderFinalScore(t){
  const cx=cv.width/2; const cy=cv.height * 0.35; 
  ctx.save();
  const grd=ctx.createRadialGradient(cx,cy,20,cx,cy,Math.max(cv.width,cv.height)/1.2);
  grd.addColorStop(0,"rgba(0,0,0,0.55)"); grd.addColorStop(1,"rgba(0,0,0,0.95)");
  ctx.fillStyle=grd; ctx.fillRect(0,0,cv.width,cv.height);
  const pw=Math.min(360,cv.width-40), ph=160, rx=cx-pw/2, ry=cy-ph/2-6;
  ctx.save(); ctx.beginPath(); ctx.rect(rx-50,ry-50,pw+100,ph+100); ctx.clip();
  ctx.translate(cx,cy); ctx.rotate(Math.sin(t / 4000) * 0.15); 
  ctx.fillStyle="rgba(0,255,200,0.15)"; const line=`Babypeacock ‚Ä¢ SCORE ${score} ‚Ä¢ CODE ${verifyCode} ‚Ä¢ `;
  ctx.font="700 13px system-ui,Arial"; for(let y=-150;y<=150;y+=22){let x=-300; while(x<300){ctx.fillText(line,x,y); x+=ctx.measureText(line).width+40;}}
  ctx.restore();
  const gradText = ctx.createLinearGradient(cx - 100, 0, cx + 100, 0); gradText.addColorStop(0, "#22d3ee"); gradText.addColorStop(1, "#34d399");
  ctx.fillStyle = gradText; ctx.font="900 26px system-ui,Arial"; ctx.textAlign="center"; ctx.shadowColor="rgba(34,211,238,0.8)"; ctx.shadowBlur=15;
  ctx.fillText("Babypeacock",cx,cy-30); ctx.shadowBlur=0;
  ctx.fillStyle="rgba(0,255,200,0.18)"; ctx.font="900 80px system-ui,Arial"; ctx.fillText(String(score),cx,cy+40);
  ctx.fillStyle="#00ffc8"; ctx.font="900 48px system-ui,Arial"; ctx.fillText(score,cx,cy+20);
  ctx.restore();
}

async function endGame(){
  gameOver=true; uiPause.style.display="none"; overEl.style.display="flex"; 
  if(window.checkMondayWinner) window.checkMondayWinner();
  try{
    if(navigator.onLine){
      if (window.saveScore) await window.saveScore(score);
      if (window.incrementGlobalPlays) await window.incrementGlobalPlays();
      if (window.bumpLocation) await window.bumpLocation();
      if (window.flushPendingScores) window.flushPendingScores();
    } else { if (window.savePendingScore) window.savePendingScore(score); }
    if (window.showWeeklyPanel) window.showWeeklyPanel();
  }catch(e){ if (window.savePendingScore) window.savePendingScore(score); }
  top10Box.style.display="block";
}

function update(dt){
  starsA.forEach(s=>{s.y+=s.sp;if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);}}); 
  starsB.forEach(s=>{s.y+=s.sp;if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);}});
  
  if(!started||gameOver||paused||inCountdown)return;
  
  elapsed+=dt/1000;enT+=dt;gemT+=dt;mascotT+=dt;
  if(powerTime>0){powerTime-=dt;if(powerTime<0)powerTime=0;} pxEl.textContent=powerTime>0?Math.ceil(powerTime/1000):0;
  fireTimer+=dt;if(holding&&fireTimer>FIRE_MS){shoot();fireTimer=0;}
  
  let spMul = 1.0; let spwMul = 1.0;
  if(score >= 300 && score < 500){ spMul = 1.15; spwMul = 1.10; }
  if(score >= 500 && score < 800){ spMul = 1.25; spwMul = 1.25; }
  if(score >= 800 && score < 1300){ spMul = 1.45; spwMul = 1.75; }
  if(score >= 1300 && score < 1500){ spMul = 1.58; spwMul = 2.00; }
  if(score >= 1500){ spMul = 1.72; spwMul = 2.35; }
  let dyn = 1; if(score > 2000){ const over = score - 2000; dyn = 1 + over * 0.0006; dyn = Math.min(dyn, 2.0); }

  if(enT > 600/(spwMul * dyn)){ spawnEnemy(allowedKindsByTime(elapsed), spMul); enT = 0; }
  
  const gemInterval = (score >= 1500) ? 25000 : (score >= 1300) ? 21000 : (score >= 800)  ? 18000 : (score >= 500)  ? 11000 : (score >= 300)  ? 9500  : 9000;
  const gemChance = (score >= 1500) ? 0.28 : (score >= 1300) ? 0.35 : (score >= 800)  ? 0.40 : 0.55;
  let intervalFinal = gemInterval; let chanceFinal = gemChance;
  if(score > 2000){ intervalFinal = gemInterval * dyn; chanceFinal = gemChance / dyn; }

  if(gemT > intervalFinal){ if(Math.random() < chanceFinal) spawnGem(); gemT = 0; }
  if(mascotT>12000){spawnMascot();mascotT=0;}
  
  bullets.forEach(b=>{b.y+=b.vy;b.x+=(b.ang||0)*0.5;}); bullets=bullets.filter(b=>b.y>-20);
  
  /* --- GENEL SPRITE ANIMASYONU --- */
  enemies.forEach(e=>{
    e.y+=e.vy;
    e.shootT+=dt;
    if(e.canShoot&&e.shootT>=e.shootInt){e.shootT=0;enemyShoot(e);}
    
    // Eƒüer sprite ise (Birden fazla karesi varsa)
    if(e.isSprite && e.img) {
      e.frameTimer += dt;
      // 20ms'de bir kare deƒüi≈ütir (Hƒ±zlƒ± animasyon)
      if(e.frameTimer > 20) { 
        e.frameTimer = 0;
        e.frame = (e.frame + 1) % e.totalFrames;
      }
    }
  }); 
  enemies=enemies.filter(e=>e.y<=cv.height+40);

  enemyBullets.forEach(m=>{m.y+=m.vy;}); enemyBullets=enemyBullets.filter(m=>m.y<cv.height+40);
  gems.forEach(g=>g.y+=g.vy); gems=gems.filter(g=>g.y<cv.height+40); mascots.forEach(m=>m.y+=m.vy); mascots=mascots.filter(m=>m.y<cv.height+40);
  
  /* --- √áARPI≈ûMA (COLLISION) - HITBOX K√ú√á√úLTME --- */
  // Oyuncunun vuru≈ü alanƒ±nƒ± (Hitbox) kenarlardan 12px daraltƒ±yoruz
  const pBox = { 
    x: player.x + 12, 
    y: player.y + 12, 
    w: player.w - 24, 
    h: player.h - 24 
  };

  for(const e of enemies){
    if(rectHit(pBox,e)){
      explosion(player.x+player.w/2,player.y+player.h/2,22);
      lives--;updateLives();if(lives<=0)endGame();e.dead=1;
    }
  }
  for(const m of enemyBullets){
    if(rectHit(pBox,m)){
      explosion(player.x+player.w/2,player.y+player.h/2,22);
      lives--;updateLives();if(lives<=0)endGame();m.dead=1;
    }
  }
  // Mermiler d√º≈ümanƒ± vururken normal hitbox kullanƒ±lƒ±r (Kolaylƒ±k olsun)
  for(const b of bullets){ 
    for(const e of enemies){ 
      if(rectHit(b,e)){ 
        explosion(e.x+e.w/2,e.y+e.h/2,16); b.dead=1; e.dead=1; 
        if(!gameOver){ score++; scEl.textContent=score; } 
      } 
    } 
  }
  // Gem ve Maskot toplarken normal hitbox (Kolay toplansƒ±n)
  for(const g of gems){ if(rectHit(player,g)){ playGemSound(); powerTime=15000; g.dead=1; } } 
  for(const m of mascots){ if(rectHit(player,m)){ playLifeSound(); if(lives < 5){ lives++; updateLives(); } else { score += 2; scEl.textContent = score; } m.dead=1; } }

  enemies=enemies.filter(o=>!o.dead);bullets=bullets.filter(o=>!o.dead);enemyBullets=enemyBullets.filter(o=>!o.dead);gems=gems.filter(o=>!o.dead);mascots=mascots.filter(o=>!o.dead);
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.life-=dt;if(p.life<=0){particles.splice(i,1);continue;}p.x+=p.vx;p.y+=p.vy;p.vy+=0.02;}
}

function draw(t){
  ctx.clearRect(0,0,cv.width,cv.height);
  
  /* Arka plan zaten CSS ile siyah (gradient) */
  ctx.fillStyle="rgba(255,255,255,0.7)";starsA.forEach(s=>ctx.fillRect(s.x,s.y,1,1)); 
  ctx.fillStyle="rgba(255,255,255,0.9)";starsB.forEach(s=>ctx.fillRect(s.x,s.y,1.2,1.2));

  if(!started) return;

  if(playerImg)ctx.drawImage(playerImg,player.x,player.y,player.w,player.h); else{ctx.fillStyle="#38bdf8";ctx.fillRect(player.x,player.y,player.w,player.h);}
  
  /* MERMƒ∞ RENGƒ∞ (MAVƒ∞) - G√úNCELLENDƒ∞ */
  ctx.fillStyle="#0099ff"; 
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));
  
  enemies.forEach(e=>{
    if(e.isSprite && e.img && e.totalFrames > 0) {
      const frameW = e.img.width / e.totalFrames;
      const frameH = e.img.height; 
      const sx = e.frame * frameW;
      
      // Hata korumasƒ±
      if(frameW > 0 && sx >= 0) {
        ctx.drawImage(e.img, sx, 0, frameW, frameH, e.x, e.y, e.w, e.h);
      }
    } else if(e.img) {
      ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
    } else {
      // YEDEK Sƒ∞STEM
      ctx.fillStyle=e.kind==="green"?"#22c55e":"#ef4444";
      ctx.fillRect(e.x,e.y,e.w,e.h);
    }
  });

  enemyBullets.forEach(m=>{ctx.fillStyle=m.color;ctx.fillRect(m.x,m.y,m.w,m.h);});
  gems.forEach(g=>drawDiamondGem(ctx,g.x,g.y,g.w,g.h,performance.now()/1000)); if(peacockImg)mascots.forEach(m=>ctx.drawImage(peacockImg,m.x,m.y,m.w,m.h));
  particles.forEach(p=>{const a=Math.max(0,p.life/500);ctx.globalAlpha=a;ctx.fillStyle="rgba(255,200,80,1)";ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;});
  if(gameOver){ renderFinalScore(t); if(!scoreSent){ scoreSent=true; } }
}
function loop(t){const dt=Math.min(t-(window._lt||t),32);window._lt=t;update(dt);draw(t);requestAnimationFrame(loop);} requestAnimationFrame(loop);

restartBtn.onclick=()=>{
  if(window.bpcTimer)clearInterval(window.bpcTimer);
  score=0;lives=3;powerTime=0;scEl.textContent=0;pxEl.textContent=0;
  bullets=[];enemies=[];enemyBullets=[];gems=[];mascots=[];particles=[];
  updateLives();gameOver=false;scoreSent=false;paused=false;inCountdown=false;
  overEl.style.display="none";top10Box.style.display="none";uiPause.style.display="none";
  playId=Math.floor(performance.now()+Math.random()*1e9); makeCode();
  started=true; 
  uiBrand.style.display="block"; uiScore.style.display="block"; uiPower.style.display="block"; uiLives.style.display="block"; uiPause.style.display="flex";
  player.y=cv.height-140; player.x=cv.width/2-player.w/2;
};

let playerImg=null, peacockImg=null;
let loadedSprites = {};

(async function(){
  try{const p=await loadImage(PLAYER_SRC);playerImg=keyOutDark(p,80);}catch{}
  try{const bird=await loadImage(PEACOCK_SRC);peacockImg=keyOutDark(bird,70);}catch{}
  
  // SPRITE Y√úKLEME
  for(const key in SPRITE_CONFIG){
    try{
      const raw = await loadImage(SPRITE_CONFIG[key].src);
      const processedImg = keyOutDark(raw, 90); /* E≈ûƒ∞K 90 YAPILDI */
      
      let frames = SPRITE_CONFIG[key].frames;
      loadedSprites[key] = { img: processedImg, frames: frames };
      
    }catch(e){console.log("Sprite y√ºklenemedi: "+key, e)}
  }
})();
</script>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
const INSTANCE_URL="https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
const app=getApps().length?getApps()[0]:initializeApp({databaseURL:INSTANCE_URL}); const db=getDatabase(app); window.db=db;

function getLondonNow(d=new Date()){ return new Date(d.toLocaleString("en-US", { timeZone: "Europe/London" })); }

function weekKey(d=new Date()){
  const now = getLondonNow(d);
  const day = (now.getDay() + 6) % 7; 
  const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - day); startOfWeek.setHours(0,0,0,0);
  const startOfYear = getLondonNow(new Date(now.getFullYear(), 0, 1)); startOfYear.setHours(0,0,0,0);
  const diff = startOfWeek - startOfYear;
  const weekNumber = Math.floor(diff / (7*24*60*60*1000)) + 1;
  return `${now.getFullYear()}-W${String(weekNumber).padStart(2,"0")}`;
}

function getFlagEmoji(c){if(!c)return"üè≥Ô∏è";const cp=c.toUpperCase().split('').map(char=>127397+char.charCodeAt());return String.fromCodePoint(...cp);}

function getCountryCode(){
  try{
    const lang=(navigator.languages&&navigator.languages[0])||navigator.language||"en-US";
    let country = (lang.split('-')[1] || "").toUpperCase();
    if (!country || country.length !== 2) {
        const code = lang.split('-')[0].toLowerCase();
        const map = {
            ar:'SA', en:'US', fr:'FR', de:'DE', es:'ES', it:'IT', pt:'BR',
            ru:'RU', zh:'CN', ja:'JP', ko:'KR', tr:'TR', nl:'NL', hi:'IN',
            sv:'SE', no:'NO', da:'DK', pl:'PL', cs:'CZ', sk:'SK', ro:'RO',
            hu:'HU', fi:'FI', el:'GR', id:'ID', th:'TH', vi:'VN', uk:'UA',
            bg:'BG', sr:'RS', hr:'HR', ms:'MY', he:'IL'
        };
        country = map[code] || "TR";
    }
    if (country === "UK") country = "GB";
    return country;
  }catch{return"TR";}
}

function getLondonNowCompat(){ return getLondonNow(new Date()); }

function savePendingScore(score){
  const code = localStorage.getItem("playerCode") || "BPC";
  const country = getCountryCode();
  const wk = weekKey(new Date());
  const item = { code, score, ts: Date.now(), country, week: wk };
  const old = JSON.parse(localStorage.getItem("pendingScores") || "[]");
  old.push(item);
  localStorage.setItem("pendingScores", JSON.stringify(old));
}

async function flushPendingScores(){
  try{
    const pending = JSON.parse(localStorage.getItem("pendingScores") || "[]");
    if(pending.length === 0) return;
    for(const p of pending){
      await push(ref(db, "scores"), { code: p.code, score: p.score, ts: p.ts, country: p.country });
      await push(ref(db, `scoresWeekly/${p.week}`), { code: p.code, score: p.score, ts: p.ts, country: p.country, week: p.week });
    }
    localStorage.removeItem("pendingScores");
  }catch(e){}
}
window.addEventListener("online", flushPendingScores);
if(navigator.onLine){ flushPendingScores(); }
window.savePendingScore = savePendingScore;
window.flushPendingScores = flushPendingScores;

const refCounter=ref(db,"stats/globalPlays"); const elGC=document.getElementById("globalCounter");
const cached=Number(localStorage.getItem("bpc_global_plays"))||0; if(elGC)elGC.textContent=cached?cached.toLocaleString("en-US"):"‚Ä¶";
onValue(refCounter,s=>{const v=Number(s.val()??0);if(elGC)elGC.textContent=v.toLocaleString("en-US");localStorage.setItem("bpc_global_plays",String(v));});
function incrementGlobalPlays(){return runTransaction(refCounter,v=>(v||0)+1);}

async function bumpLocation(){
  try{ const code = getCountryCode(); const locRef = ref(db, `stats/locations/${code}`); await runTransaction(locRef, v => (v||0) + 1); }catch(e){}
}
(async function bumpLocationOncePerDay(){
  try{ const tk="bpc_loc_day"; const td=new Date().toISOString().slice(0,10); if(localStorage.getItem(tk)===td)return;
    await bumpLocation(); const tr=ref(db,"stats/totalStarts"); await runTransaction(tr,v=>(v||0)+1); localStorage.setItem(tk,td);
  }catch(e){}
})();

async function saveScore(score){
  const code=localStorage.getItem("playerCode")||"BPC"; const country=getCountryCode(); 
  const payload={code,score,ts:Date.now(),country, countryName: country}; 
  await push(ref(db,"scores"),payload);
  const wk=weekKey(new Date()); await push(ref(db,`scoresWeekly/${wk}`),{...payload,week:wk});
}

async function getWeeklyTop10(wk=weekKey()){
  const snap=await get(ref(db,`scoresWeekly/${wk}`)); const bestByCode={};
  snap.forEach(ch=>{const v=ch.val();if(!v||typeof v.score!=="number")return;if(!bestByCode[v.code]||v.score>bestByCode[v.code].score)bestByCode[v.code]=v;});
  return Object.values(bestByCode).sort((a,b)=>b.score-a.score).slice(0,20);
}

async function checkMondayWinner(){
  const now = getLondonNow(new Date());
  const londonDay = now.getDay(); 

  const isMondayActive = londonDay === 1;
  mondayBox.style.display = 'none';
  if(!isMondayActive) return;

  const d_prev = new Date(now); d_prev.setDate(d_prev.getDate() - 1); const prevWk = weekKey(d_prev);
  const list = await getWeeklyTop10(prevWk);
  if(!list || list.length === 0) return;

  const winner = list[0]; const myCode = localStorage.getItem("playerCode");
  mondayBox.style.display = 'flex';
  mcWeek.textContent = prevWk.split("-W")[1]; 
  mcName.textContent = getFlagEmoji(winner.country) + " " + winner.code;

  if(myCode === winner.code){
    const winRef = ref(db, `weeklyWinners/${prevWk}`);
    const snapshot = await get(winRef);
    let secret = "";
    if(snapshot.exists() && snapshot.val().secretCode){ secret = snapshot.val().secretCode; } 
    else { secret = "WIN-" + Math.floor(100000 + Math.random() * 900000); await set(winRef, { secretCode: secret, winnerCode: winner.code, country: winner.country, score: winner.score, ts: Date.now() }); }
    mcSecretBox.style.display = "block"; mcCode.textContent = secret;
  } else { mcSecretBox.style.display = "none"; }
}
window.checkMondayWinner = checkMondayWinner;

async function showWeeklyPanel(){
  const wk=weekKey(new Date()); const me=localStorage.getItem("playerCode");
  const ol=document.getElementById("bpc-list"); const box=document.getElementById("bpc-top10");
  const wnEl=document.getElementById("wk-num"); if(wnEl)wnEl.textContent=wk.split("-W")[1]; 
  if(window.bpcTimer)clearInterval(window.bpcTimer);
  function updateTimer(){
    const now = getLondonNowCompat();
    const target = new Date(now);
    const day = target.getDay(); 
    const daysUntilSunday = (7 - day) % 7; 
    target.setDate(now.getDate() + daysUntilSunday);
    target.setHours(23, 59, 59, 999);
    
    const diff=target-now; const remEl=document.getElementById("wk-rem"); if(!remEl)return;
    if(diff<=0){remEl.textContent="Resetting...";return;}
    const d=Math.floor(diff/(1000*60*60*24)); const h=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60)); const s=Math.floor((diff%(1000*60))/1000);
    remEl.textContent=`${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    remEl.style.color=(d===0)?"#ef4444":"#facc15";
  }
  updateTimer(); window.bpcTimer=setInterval(updateTimer,1000);

  const list=await getWeeklyTop10(wk);
  if(ol){
    ol.innerHTML=list.length
      ? list.map((it,i)=>{
          const mine=it.code===me; const flag=getFlagEmoji(it.country);
          return `<li class="${mine?'me':''}"><span class="rank-num">${i+1}.</span>${flag} ${it.code} ‚Üí ${it.score} pts</li>`;
        }).join("")
      : `<div style="opacity:.7;text-align:center">No scores this week yet.</div>`;
  }
  if(box)box.style.display="block";
}

window.incrementGlobalPlays=incrementGlobalPlays; window.saveScore=saveScore;
window.showWeeklyPanel=showWeeklyPanel; window.bumpLocation=bumpLocation;
</script>
</body>
</html>
