<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BPC Space – Level 1 (Wolf)</title>
<style>
  html,body{margin:0;background:#000;color:#0ff;font-family:system-ui,Arial}
  .hud{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  #start{gap:16px;flex-direction:column;background:rgba(0,0,0,.8)}
  #over {gap:14px;flex-direction:column;background:rgba(0,0,0,.82);display:none}
  button{padding:10px 16px;border-radius:10px;border:0;background:#0ff;color:#012;font-weight:800}
  canvas{display:block;margin:0 auto;touch-action:none}
</style>
</head>
<body>
<canvas id="game" width="420" height="740"></canvas>

<div id="start" class="hud">
  <button id="startBtn">START</button>
</div>

<div id="over" class="hud">
  <div style="color:#f55;font-weight:900;font-size:24px">GAME OVER</div>
  <button id="retryBtn">RETRY</button>
</div>

<audio id="boom" preload="auto" src="boom.mp3"></audio>

<script>
/* ===== Canvas / State ===== */
const cv=document.getElementById('game'), ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=false;
const startEl=document.getElementById('start'), startBtn=document.getElementById('startBtn');
const overEl=document.getElementById('over'), retryBtn=document.getElementById('retryBtn');
const W=cv.width,H=cv.height;

let started=false, gameOver=false, lastT=0;
let player={x:W/2, y:H-80, r:10};
let shots=[], eBullets=[];
let wolf=null; // boss

/* ===== Assets ===== */
const wolfImg=new Image(); wolfImg.src='enemy_wolf.png';

/* ===== Input (parmak / mouse) ===== */
cv.addEventListener('mousemove',e=>{
  const r=cv.getBoundingClientRect(); player.x=Math.max(16,Math.min(W-16,e.clientX-r.left));
});
cv.addEventListener('touchmove',e=>{
  const t=e.touches[0], r=cv.getBoundingClientRect();
  player.x=Math.max(16,Math.min(W-16,t.clientX-r.left)); e.preventDefault();
},{passive:false});

/* ===== Game Controls ===== */
startBtn.onclick = startGame;
retryBtn.onclick = ()=>{ resetGame(); startEl.style.display='flex'; overEl.style.display='none'; };

function startGame(){
  if(started) return;
  started=true; gameOver=false; startEl.style.display='none';
  if (window.BPC_incrementOnStart) window.BPC_incrementOnStart();
  if (window.BPC_logCountryOnStart) window.BPC_logCountryOnStart();
}

function resetGame(){
  started=false; gameOver=false; shots=[]; eBullets=[];
  player={x:W/2,y:H-80,r:10};
  wolf={
    x:W/2, y:-120, w:200, h:200, vx:1.6, dir:1,
    hp:25, entered:false, redCD:0, eyeCD:300, eyeTime:0
  };
}

function endGame(){
  gameOver=true; overEl.style.display='flex';
}

/* ===== Mechanics ===== */
function shootPlayer(){
  shots.push({x:player.x, y:player.y-18, vy:-7, r:4});
}
let shootTimer=0;

function spawnWolfReds(){
  const arms=[
    {x:wolf.x-70, y:wolf.y+20},
    {x:wolf.x+70, y:wolf.y+20},
    {x:wolf.x-90, y:wolf.y+90},
    {x:wolf.x+90, y:wolf.y+90},
  ];
  arms.forEach(a=>eBullets.push({x:a.x,y:a.y,vy:3.2,r:5,color:'#f33'}));
}
function spawnWolfBeam(){
  wolf.eyeTime=60; // ~1 sn
}

/* circle↔rect hit */
function rectHitCircle(cx,cy,r, rx,ry,rw,rh){
  const nx=Math.max(rx,Math.min(cx,rx+rw));
  const ny=Math.max(ry,Math.min(cy,ry+rh));
  return (cx-nx)**2 + (cy-ny)**2 <= r*r;
}

function update(dt){
  if(!started||gameOver) return;

  // player auto-fire
  shootTimer-=dt; if(shootTimer<=0){ shootPlayer(); shootTimer=180; } // ~0.18s
  shots.forEach(s=>s.y+=s.vy);
  shots=shots.filter(s=> s.y>-10);

  // boss
  if(!wolf.entered){ wolf.y+=1.2; if(wolf.y>=90) wolf.entered=true; }
  else{
    wolf.x += wolf.vx*wolf.dir;
    if(wolf.x<120 || wolf.x>W-120) wolf.dir*=-1;
    if(wolf.redCD<=0){ spawnWolfReds(); wolf.redCD=72; } else wolf.redCD--;
    if(wolf.eyeCD<=0){ spawnWolfBeam(); wolf.eyeCD=600; } else wolf.eyeCD--;
  }
  if(wolf.eyeTime>0) wolf.eyeTime--;

  // enemy bullets
  eBullets.forEach(b=>{ b.y+=b.vy; if(b.vx) b.x+=b.vx; });
  eBullets=eBullets.filter(b=>{
    if(b.y>H+20) return false;
    if(rectHitCircle(player.x,player.y,player.r, b.x-6,b.y-6,12,12)){ endGame(); return false; }
    return true;
  });

  // player bullets → boss
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i];
    if(rectHitCircle(s.x,s.y,s.r, wolf.x-100,wolf.y-100,200,200)){
      shots.splice(i,1); wolf.hp--; 
      if(wolf.hp<=0){ // win → start ekranına dön
        startEl.style.display='flex'; started=false;
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  // stars bg (simple)
  ctx.fillStyle='#021'; ctx.fillRect(0,0,W,H);

  // player
  ctx.fillStyle='#ffd54a'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();

  // wolf
  if(wolfImg.complete) ctx.drawImage(wolfImg, wolf.x-100,wolf.y-100,200,200);
  // beam
  if(wolf.eyeTime>0){
    ctx.strokeStyle='#29f'; ctx.lineWidth=6;
    ctx.beginPath(); ctx.moveTo(wolf.x, wolf.y-10); ctx.lineTo(wolf.x, H); ctx.stroke();
    if(Math.abs(player.x-wolf.x)<8) endGame();
  }

  // bullets
  eBullets.forEach(b=>{ ctx.fillStyle=b.color||'#f33'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||5,0,Math.PI*2); ctx.fill(); });
  shots.forEach(s=>{ ctx.fillStyle='#ff0'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); });

  // HP bar
  ctx.fillStyle='#222'; ctx.fillRect(60,16,W-120,10);
  ctx.fillStyle='#0f0'; const hpw=(W-120)*Math.max(0,wolf.hp)/25; ctx.fillRect(60,16,hpw,10);
  ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.fillText('WOLF HP',16,25);
}

function loop(t){
  const dt=Math.min(t-(lastT||t),32); lastT=t;
  update(dt); draw(); requestAnimationFrame(loop);
}

resetGame(); requestAnimationFrame(loop);
</script>

<!-- ===== Firebase (Start’ta sayaç + ülke kaydı; oyuncuya görünmez) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, runTransaction, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const INSTANCE_URL="https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
const firebaseConfig={
  apiKey:"AIzaSyAm65sARsGDTVkqe6MXcb8OObug17SEFpY",
  authDomain:"bpc-space.firebaseapp.com",
  databaseURL:INSTANCE_URL,
  projectId:"bpc-space",
  storageBucket:"bpc-space.firebasestorage.app",
  messagingSenderId:"954298087029",
  appId:"1:954298087029:web:3583f27fdd97d932de6a3c"
};
const app=initializeApp(firebaseConfig);
const db =getDatabase(app,INSTANCE_URL);

// Start'ta +1 (oyuncuya gösterme)
window.BPC_incrementOnStart=()=>runTransaction(ref(db,"stats/totalStarts"),v=>(v||0)+1);

// Start'ta ülke kaydı (sadece DB)
window.BPC_logCountryOnStart=async()=>{
  try{
    const r=await fetch("https://ipapi.co/json/"); const j=await r.json();
    const country=j?.country_name||"Unknown"; const ts=Date.now();
    await set(ref(db,"stats/lastCountry"),{country,ts});
    await runTransaction(ref(db,`stats/locations/${country}`),v=>(v||0)+1);
  }catch(e){ console.warn("geo fail",e); }
};
</script>
</body>
</html>
