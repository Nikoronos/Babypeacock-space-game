<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover" />
<title>BPC - ZIGZAG TEST (FIXED)</title>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui;overflow:hidden}
  #ui{
    position:fixed;top:10px;left:10px;
    color:#00ffc8;font-weight:bold;z-index:10;font-size:16px;
    text-shadow: 0 0 5px #000; pointer-events:none;
  }
  canvas{display:block;width:100%;height:100%;background:#020617;}
  .btn{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    padding:20px 40px; background:#0f172a; border:2px solid #00ffc8;
    color:#00ffc8; font-size:24px; font-weight:900; border-radius:12px;
    cursor:pointer; z-index:20; box-shadow: 0 0 20px rgba(0,255,200,0.3);
  }
</style>
</head>
<body>

<div id="ui">
  TEST MODU: 67 ZIG-ZAG<br>
  DURUM: AKTİF<br>
  Skor: <span id="sc">0</span>
</div>

<button id="startBtn" class="btn">BAŞLAT</button>
<canvas id="game"></canvas>

<script>
const cv=document.getElementById("game");
const ctx=cv.getContext("2d");
const startBtn=document.getElementById("startBtn");
const scEl=document.getElementById("sc");

// RESİM DOSYA İSİMLERİ (Seninkilerle aynı)
const PLAYER_SRC="img/player/bpc_mini.png"; 
// Düşman resimleri (Varsa yükler)
const ENEMY_SRC=["bpc_enemy_red.png", "bpc_enemy_green.png", "ufo_red_sprite.png"];

let playerImg=null;
let enemyImgs=[];

function resize(){ cv.width=window.innerWidth; cv.height=window.innerHeight; }
window.addEventListener('resize', resize); resize();

// Resim Yükleme Yardımcısı
const loadImage = (src) => new Promise((resolve) => {
  const img = new Image();
  img.onload = () => resolve(img);
  img.onerror = () => { console.log("Resim bulunamadı:", src); resolve(null); };
  img.src = src;
});

// Resimleri Yükle
(async function initAssets(){
  playerImg = await loadImage(PLAYER_SRC);
  for(let src of ENEMY_SRC){
    const img = await loadImage(src);
    if(img) enemyImgs.push(img);
  }
})();

// OYUN DEĞİŞKENLERİ
let player={x:cv.width/2-33, y:cv.height-120, w:66, h:66};
let bullets=[], enemies=[];
let running=false, score=0, frames=0;

// KONTROLLER
let holding=false;
const getX = (e) => (e.clientX || (e.touches && e.touches[0].clientX) || 0);

cv.addEventListener("pointerdown",e=>{holding=true; movePlayer(getX(e));});
cv.addEventListener("pointermove",e=>{if(holding) movePlayer(getX(e));});
cv.addEventListener("pointerup",()=>holding=false);
cv.addEventListener("touchend",()=>holding=false);

function movePlayer(tx){
  player.x = Math.max(0, Math.min(cv.width-player.w, tx - player.w/2));
}

// === BAŞLATMA FONKSİYONU (DÜZELTİLDİ) ===
startBtn.onclick = () => {
  startBtn.style.display="none";
  running=true;
  enemies=[]; bullets=[]; score=0; frames=0;
  player.y = cv.height - 120;
  
  // Önceki hatayı düzelttim: loop() yerine update() çağırıyoruz
  update(); 
};

function spawnEnemy(){
  // Index 67'deki MAX KALABALIK (30 Düşman)
  if(enemies.length >= 30) return;
  
  const size = 50 + Math.random()*30;
  const xStart = Math.random() * (cv.width - size);
  
  // === ZIG-ZAG MANTIĞI ===
  const dir = Math.random() < 0.5 ? -1 : 1;
  const vx = dir * (1.5 + Math.random() * 2.5); // Yatay Hız

  // Rastgele resim seç
  let selectedImg = null;
  if(enemyImgs.length > 0) {
    selectedImg = enemyImgs[Math.floor(Math.random() * enemyImgs.length)];
  }

  enemies.push({
    x: xStart, y: -size, w: size, h: size,
    vy: 3 + Math.random() * 2.5, // Dikey Hız
    vx: vx, // <-- Yatay Hareket
    img: selectedImg,
    color: Math.random()<0.5 ? "#ef4444" : "#22c55e" // Resim yoksa renk
  });
}

function update(){
  if(!running) return;
  frames++;

  // Otomatik Ateş
  if(frames % 10 === 0) {
    bullets.push({x:player.x+player.w/2-2, y:player.y, w:4, h:15, color:"#38bdf8"});
  }

  // Düşman Spawn
  if(frames % 15 === 0) spawnEnemy();

  // Mermiler
  bullets.forEach(b => b.y -= 12);
  bullets = bullets.filter(b => b.y > -20);

  // Düşmanlar
  enemies.forEach(e => {
    e.y += e.vy;
    
    // === YATAY HAREKET (ZIG-ZAG) ===
    e.x += e.vx;
    // Duvara çarpınca geri sek (Bounce)
    if(e.x <= 0 || e.x + e.w >= cv.width){
       e.vx *= -1; 
    }
  });

  // Çarpışma
  for(let i=enemies.length-1; i>=0; i--){
    let e = enemies[i];
    let hit = false;

    // Mermi vurdu mu?
    for(let j=bullets.length-1; j>=0; j--){
      let b = bullets[j];
      if(b.x < e.x+e.w && b.x+b.w > e.x && b.y < e.y+e.h && b.y+b.h > e.y){
        bullets.splice(j,1);
        hit = true;
        score++; scEl.innerText = score;
        break;
      }
    }

    if(hit) enemies.splice(i,1);
    else if(e.y > cv.height) enemies.splice(i,1);
  }

  draw();
  requestAnimationFrame(update); // Döngü devam eder
}

function draw(){
  // Arkaplan
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.fillStyle = "rgba(255,255,255,0.1)"; // Hafif yıldız efekti gibi noktalar için
  
  // Oyuncu
  if(playerImg) ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
  else {
    ctx.fillStyle="#38bdf8"; ctx.fillRect(player.x, player.y, player.w, player.h);
  }

  // Mermiler
  ctx.fillStyle="#00ffc8";
  bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

  // Düşmanlar
  enemies.forEach(e => {
    if(e.img) {
      ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
    } else {
      ctx.fillStyle = e.color;
      ctx.fillRect(e.x, e.y, e.w, e.h);
      // Ok işareti (Yönü gösterir)
      ctx.fillStyle = "white"; ctx.font="20px Arial"; ctx.fillText(e.vx>0?"→":"←", e.x, e.y);
    }
  });
}
</script>
</body>
</html>
