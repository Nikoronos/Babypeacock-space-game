<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>BPC Mini Uzay Oyunu ðŸ¦š</title>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui}
  #score{position:fixed;top:10px;left:0;right:0;text-align:center;color:#00ffc8;font-weight:700}
  #power{position:fixed;top:10px;right:10px;color:#a7f3d0;font-weight:700}
  canvas{display:block;margin:50px auto 0 auto;background:linear-gradient(#020617,#0b1220)}
  #start{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
         background:rgba(0,0,0,.8);color:#fff;font-weight:700;letter-spacing:.5px;z-index:10}
  #start .box{padding:18px 22px;border:1px solid #2dd4bf;border-radius:12px;text-align:center}
  #hint{font-size:14px;opacity:.8;margin-top:6px}
  /* GÃ¶rsel joystick */
  #joy{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);pointer-events:none;opacity:.75}
  #joy .base{width:120px;height:120px;border:2px solid #94a3b8;border-radius:9999px;background:rgba(148,163,184,.12)}
  #joy .knob{position:absolute;left:0;top:0;width:60px;height:60px;border-radius:9999px;background:rgba(45,212,191,.35);
             transform:translate(30px,30px)}
  #joy.hidden{display:none}
</style>
</head>
<body>
  <div id="score">ðŸ¦š Skor: <span id="sc">0</span></div>
  <div id="power">ðŸ’Ž x <span id="px">0</span></div>
  <div id="start"><div class="box">
    Dokun ve BaÅŸlat
    <div id="hint">ParmaÄŸÄ±nÄ± sÃ¼rÃ¼kle â†’ joystick gibi hareket â€¢ Oto-ateÅŸ aÃ§Ä±k</div>
  </div></div>
  <canvas id="game" width="480" height="720"></canvas>

  <!-- GÃ¶rsel joystick -->
  <div id="joy" class="hidden">
    <div class="base"></div>
    <div class="knob" id="knob"></div>
  </div>

<script>
const cv = document.getElementById('game'), ctx=cv.getContext('2d');
const scEl = document.getElementById('sc'), pxEl = document.getElementById('px');
const startEl = document.getElementById('start');
const joyEl = document.getElementById('joy'), knobEl = document.getElementById('knob');

function fitCanvas(){ const h = Math.min(820, window.innerHeight-20); cv.height = Math.max(620, h); }
fitCanvas(); addEventListener('resize', fitCanvas);

// ---------- GÃ¶rsel yÃ¼kleme + koyu arka planÄ± temizleme ----------
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
function keyOutDark(img, TH=80){
  const w=img.width, h=img.height;
  const off=document.createElement('canvas'); off.width=w; off.height=h;
  const ox=off.getContext('2d'); ox.drawImage(img,0,0);
  let d=ox.getImageData(0,0,w,h), a=d.data;
  for(let p=0;p<a.length;p+=4){
    const r=a[p], g=a[p+1], b=a[p+2];
    const lum=0.2126*r+0.7152*g+0.0722*b;
    if((r<TH&&g<TH&&b<TH)||lum<TH*0.8) a[p+3]=0;
    else if(lum<TH*1.1) a[p+3]=Math.max(0,a[p+3]-120);
  }
  ox.putImageData(d,0,0);
  return off;
}

// ---------- Asset yollarÄ± ----------
const PLAYER_SRC="img/player/bpc_mini.png";
const ENEMY_SRCS=["bpc_enemy_green.png","bpc_enemy_red.png","bpc_enemy_ufo_gray.png","bpc_enemy_ufo_red.png"];

// ---------- Oyun durumu ----------
const bullets=[], enemies=[], gems=[];
let score=0, keys={}, started=false, lastSpawn=0, gemTimer=0;
let powerShots=0;
const player={x:cv.width/2-28,y:cv.height-110,w:56,h:56,speed:5};

let targetX = player.x; // joystick hedefi
let holding=false, lastTouchX=null;

// BaÅŸlat
function begin(){ if(started) return; started=true; startEl.style.display='none'; }
startEl.addEventListener('click', begin);
startEl.addEventListener('touchstart', e=>{e.preventDefault(); begin();},{passive:false});
addEventListener('keydown', ()=>{ if(!started) begin(); });

// Klavye
addEventListener('keydown', e=>{keys[e.key.toLowerCase()]=true;});
addEventListener('keyup',   e=>{keys[e.key.toLowerCase()]=false;});

// Joystick benzeri kontrol (ekranda basÄ±lÄ± tut)
cv.addEventListener('pointerdown', e=>{
  if(!started) begin();
  holding=true;
  targetX = e.offsetX - player.w/2;
  showJoystick(e.clientX, e.clientY);
});
cv.addEventListener('pointermove', e=>{
  if(!holding) return;
  targetX = e.offsetX - player.w/2;
  moveKnob(e.clientX, e.clientY);
});
cv.addEventListener('pointerup', ()=>{ holding=false; hideJoystick(); });

// Joystick UI
function showJoystick(x,y){
  joyEl.classList.remove('hidden');
  const base = joyEl.querySelector('.base');
  joyEl.style.left = (x-60) + 'px';
  joyEl.style.top  = (y-120) + 'px';
  moveKnob(x,y);
}
function moveKnob(x,y){
  const rect = joyEl.getBoundingClientRect();
  const cx = rect.left + 60, cy = rect.top + 60;
  let dx = x - cx, dy = y - cy;
  const dist = Math.hypot(dx,dy), max=40;
  if(dist>max){ dx*=max/dist; dy*=max/dist; }
  knobEl.style.transform = `translate(${30+dx}px,${30+dy}px)`;
}
function hideJoystick(){ joyEl.classList.add('hidden'); }

// SÃ¼rekli ateÅŸ zamanlayÄ±cÄ±sÄ±
let fireTimer=0, FIRE_MS=180;
function autoFire(dt){
  fireTimer += dt;
  if(fireTimer > FIRE_MS){ shoot(); fireTimer=0; }
}

// AteÅŸ
function shoot(){
  if(powerShots>0){
    addBullet(player.x+player.w/2-2, -9, 0);
    addBullet(player.x+player.w/2-2, -9, -3);
    addBullet(player.x+player.w/2-2, -9,  3);
    powerShots--; pxEl.textContent=powerShots;
  } else {
    addBullet(player.x+player.w/2-2, -9, 0);
  }
}
function addBullet(x, vy, ang){ bullets.push({x, y:player.y-12, w:4, h:12, vy, ang}); }

// MasaÃ¼stÃ¼ boÅŸluk da ateÅŸ eder
addEventListener('keydown', e=>{ if((e.key===' '||e.key==='Spacebar') && started) shoot(); });

// Spawn
function spawnEnemy(){
  const img = enemyImgs[Math.floor(Math.random()*enemyImgs.length)];
  const size = 52 + Math.random()*30;
  enemies.push({x:Math.random()*(cv.width-size), y:-size, w:size, h:size, vy:1.5+Math.random()*2.2, img});
}
function spawnGem(){ const s=24; gems.push({x:Math.random()*(cv.width-s), y:-s, w:s, h:s, vy:1.8}); }
function rectHit(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);}

// Update
function update(dt){
  // klavye ile de hedefi kaydÄ±r
  if(keys['arrowleft']||keys['a'])  targetX -= player.speed*1.5;
  if(keys['arrowright']||keys['d']) targetX += player.speed*1.5;

  // joystick benzeri: hedef X'e yumuÅŸak yaklaÅŸ (pÃ¼rÃ¼zsÃ¼z)
  player.x += (targetX - player.x) * 0.25;
  player.x = Math.max(0, Math.min(cv.width-player.w, player.x));

  // sÃ¼rekli oto-ateÅŸ
  autoFire(dt);

  // mermiler
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y+=b.vy; b.x+=b.ang*0.6; if(b.y<-20) bullets.splice(i,1);
  }

  // dÃ¼ÅŸman & gem
  lastSpawn+=dt; if(lastSpawn>700){ spawnEnemy(); lastSpawn=0; }
  enemies.forEach(e=>{ e.y+=e.vy; });
  for(let i=enemies.length-1;i>=0;i--) if(enemies[i].y>cv.height+50) enemies.splice(i,1);

  gemTimer+=dt; if(gemTimer>5200){ spawnGem(); gemTimer=0; }
  gems.forEach(g=>{ g.y+=g.vy; });
  for(let i=gems.length-1;i>=0;i--) if(gems[i].y>cv.height+40) gems.splice(i,1);

  // Ã§arpÄ±ÅŸmalar
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(rectHit({x:b.x,y:b.y,w:b.w,h:b.h},{x:e.x,y:e.y,w:e.w,h:e.h})){
        enemies.splice(i,1); bullets.splice(j,1);
        score++; scEl.textContent=score; 
        break;
      }
    }
  }
  for(let i=gems.length-1;i>=0;i--){
    const g=gems[i];
    if(rectHit(player, g)){ gems.splice(i,1); powerShots+=3; pxEl.textContent=powerShots; }
  }
}

// Draw
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.drawImage(playerImgKeyed, player.x, player.y, player.w, player.h);
  ctx.fillStyle="#00ffc8"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));
  enemies.forEach(e=>ctx.drawImage(e.img, e.x, e.y, e.w, e.h));
  // gÃ¶ltaÅŸÄ±
  gems.forEach(g=>{
    const {x,y,w,h}=g; ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.scale(w/30,h/30);
    ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(8,-2); ctx.lineTo(5,10); ctx.lineTo(-5,10); ctx.lineTo(-8,-2); ctx.closePath();
    ctx.fillStyle="#22c55e"; ctx.fill(); ctx.strokeStyle="#065f46"; ctx.lineWidth=1.8; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-3,-3); ctx.lineTo(0,-6); ctx.lineTo(3,-3); ctx.lineTo(0,0); ctx.closePath();
    ctx.fillStyle="#86efac"; ctx.fill(); ctx.restore();
  });
}

// DÃ¶ngÃ¼
let last=performance.now();
function loop(t){ const dt=t-last; last=t; if(started){ update(dt); draw(); } requestAnimationFrame(loop); }
requestAnimationFrame(loop);

// Preload & key-out
let playerImgKeyed, enemyImgs=[];
(async function(){
  const p=await loadImage(PLAYER_SRC); playerImgKeyed=keyOutDark(p,80);
  for(const src of ENEMY_SRCS){ const i=await loadImage(src); enemyImgs.push(keyOutDark(i,80)); }
})();
</script>
</body>
</html>
