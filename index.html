<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>Babypeacock ‚Äî BPC Space Game</title>
  <style>
    html,body{margin:0;height:100%;background:#0b1020;color:#cfe;overflow:hidden;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    #brand{position:fixed;top:6px;left:12px;z-index:9;font-weight:900;}
    #score{position:fixed;top:6px;left:50%;transform:translateX(-50%);z-index:9;font-weight:900;}
    #power{position:fixed;top:6px;right:12px;z-index:9;}
    #playerCode{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);opacity:.35}
    #game, #cv{position:fixed;inset:0}
    #cv{display:block;margin:auto;max-width:100vmin;max-height:100vh;background:#07101f}
    #startOverlay, #gameOver{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;
      gap:20px;background:rgba(0,0,0,.84);backdrop-filter:blur(2px);z-index:8
    }
    .btn{
      padding:12px 20px;border-radius:12px;border:1px solid #1de9b6;background:#041a1a;color:#1de9b6;
      font-weight:800;box-shadow:0 0 0 1px rgba(29,233,182,.15), 0 10px 30px rgba(0,0,0,.35);
    }
    .card{
      width:min(92vw,560px);max-height:80vh;overflow:auto;border-radius:18px;background:#00141a;color:#fff;
      border:1px solid #07333a;box-shadow:0 30px 70px rgba(0,0,0,.45)
    }
    .row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:8px}
    .muted{opacity:.7}
    .badge{padding:3px 8px;border-radius:10px;border:1px solid #27e0b3;font-size:12px}
    a{color:#7ff}
  </style>
</head>
<body>
  <div id="brand">Babypeacock ü¶ö</div>
  <div id="score">Score: <b id="sc">0</b></div>
  <div id="power">üíé <b id="px">0</b>s</div>

  <div id="game">
    <canvas id="cv" width="420" height="700"></canvas>
  </div>

  <!-- START -->
  <div id="startOverlay">
    <div class="card">
      <div class="row" style="justify-content:center;font-size:28px;font-weight:900">Hold & drag to move ‚Äî auto fire while holding</div>
      <div class="row" style="justify-content:center">
        <button id="startBtn" class="btn">START</button>
      </div>
      <div class="row muted" style="justify-content:center">Tap anywhere to start</div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOver" style="display:none">
    <div class="card" id="overCard">
      <div class="row" style="justify-content:center;font-size:32px;font-weight:900">GAME OVER</div>
      <div class="row" style="justify-content:center">Score: <b id="finalScore">0</b></div>
      <div class="row" style="justify-content:center"><button id="restartBtn" class="btn">Restart</button></div>
      <div class="row muted" style="justify-content:center">üåç Global plays: <b id="globalCounter">‚Ä¶</b></div>
      <div class="row" style="justify-content:center"><button id="openWeekly" class="btn">üèÜ Weekly Leaders</button></div>
    </div>
  </div>

  <div id="playerCode"></div>

  <!-- ========================= GAME + FIREBASE (tek script) ========================= -->
  <script type="module">
  /******************** CONFIG ********************/
  const INSTANCE_URL = "https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
  const ADMIN_EMAIL  = "babypeacock2025@gmail.com";

  /******************** IMPORTS (Firebase) ********************/
  import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, get, set, push, onValue,
    runTransaction, query, orderByChild, limitToLast
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const app = getApps().length ? getApps()[0] : initializeApp({ databaseURL: INSTANCE_URL });
  const db  = getDatabase(app);

  /******************** HELPERS ********************/
  const $ = s => document.querySelector(s);
  const cv = $("#cv"), ctx = cv.getContext("2d");
  const scEl = $("#sc"), pxEl = $("#px"), finalEl = $("#finalScore");
  const overEl = $("#gameOver"), startOverlay = $("#startOverlay"), startBtn = $("#startBtn"), restartBtn = $("#restartBtn");
  const openWeeklyBtn = $("#openWeekly");
  const codeEl = $("#playerCode");

  function weekKey(d=new Date()){
    const y = d.getFullYear(), oneJan = new Date(y,0,1);
    const wk = Math.ceil( (((d - oneJan)/86400000) + oneJan.getDay()+1) / 7 );
    return `${y}-W${String(wk).padStart(2,'0')}`;
  }
  function getPlayerCode(){
    let c = localStorage.getItem("playerCode");
    if (!c) c = "BPC-" + Math.floor(10000+Math.random()*89999);
    localStorage.setItem("playerCode", c);
    codeEl.innerHTML = `Player: <b>${c}</b>`;
    return c;
  }
  const ME = getPlayerCode();

  /******************** GLOBAL COUNTER (live) ********************/
  const refCounter = ref(db, "stats/globalPlays");
  const elGC = $("#globalCounter");
  const cached = Number(localStorage.getItem("bpc_global_plays"))||0;
  elGC && (elGC.textContent = cached.toLocaleString("en-US"));
  onValue(refCounter, s => {
    const v = Number(s.val()||0);
    if (elGC) elGC.textContent = v.toLocaleString("en-US");
    localStorage.setItem("bpc_global_plays", String(v));
  });
  window.incrementGlobalPlays = () => runTransaction(refCounter, v => (v||0)+1);

  /******************** SAVE SCORE (all-time + weekly) ********************/
  async function saveScore(score){
    const data = { code: ME, score, ts: Date.now() };
    await push(ref(db, "scores"), data);
    const wk = weekKey();
    await set(ref(db, `scoresWeekly/${wk}/${ME}`), { score, ts: Date.now(), code: ME });
  }
  window.saveScoreFinal = saveScore;

  /******************** WEEKLY TOP-10 ********************/
  async function getWeeklyTop10(wk = weekKey()){
    const q = query(ref(db, `scoresWeekly/${wk}`), orderByChild("score"), limitToLast(10));
    const snap = await get(q);
    const arr = [];
    snap.forEach(ch => arr.push(ch.val()));
    arr.sort((a,b)=>(b.score||0)-(a.score||0));
    return arr;
  }

  /******************** CONTEST (auto mark active week) ********************/
  let contest = { active:false, week:weekKey(), prize:"" };
  onValue(ref(db,"contests/current"), async s=>{
    const v = s.val()||{};
    const nowWk = weekKey();
    contest = { active: !!v.active && v.week===nowWk, week: nowWk, prize: (v.prize||"") };
  });

  /******************** WEEKLY PANEL + CLAIM ********************/
  function genClaimCode(week, code){
    const b = new Uint8Array(3);
    (self.crypto||window.crypto).getRandomValues(b);
    const rnd = [...b].map(x=>x.toString(16).padStart(2,'0')).join('').slice(0,5).toUpperCase();
    return `CLAIM-${week}-${code}-${rnd}`;
  }

  function ensurePanel(){
    let el = document.getElementById("bpc-leaderboard");
    if (el) return el;
    el = document.createElement("div");
    el.id = "bpc-leaderboard";
    el.style.cssText = `
      position:fixed;inset:0;z-index:9999;display:none;
      align-items:center;justify-content:center;
      background:rgba(0,0,0,.64);backdrop-filter:blur(2px)
    `;
    el.innerHTML = `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <span style="font-weight:900;letter-spacing:.3px">üèÜ Weekly Leaders</span>
          <button id="bpc-close" aria-label="close" class="btn" style="background:transparent;border-color:#0ff;color:#0ff">close</button>
        </div>
        <div class="row muted">
          <div>Week: <b id="bpc-week">‚Äì</b></div>
          <div class="badge" id="bpc-active-badge">INACTIVE</div>
          <div>Prize: <b id="bpc-prize">‚Äì</b></div>
        </div>
        <ol id="bpc-list" style="margin:8px 12px;padding-right:12px;"></ol>
        <div id="bpc-claim" style="display:none;padding:12px">
          <button id="bpc-claim-btn" class="btn" style="width:100%">üéÅ Claim Prize</button>
          <div id="bpc-claim-info" class="muted" style="margin-top:8px;display:none"></div>
        </div>
      </div>
    `;
    document.body.appendChild(el);
    document.getElementById("bpc-close").onclick = ()=>{
      el.style.display = "none";
      document.body.style.overflow = "";
    };
    return el;
  }

  async function showWeeklyPanel(){
    const wk = weekKey();
    const my = ME;
    const wrap = ensurePanel();
    const list = await getWeeklyTop10(wk);

    // UI fill
    document.getElementById("bpc-week").textContent = wk;
    document.getElementById("bpc-prize").textContent = contest.prize||"";
    const badge = document.getElementById("bpc-active-badge");
    badge.textContent = (contest.active && contest.week===wk) ? "ACTIVE" : "INACTIVE";
    badge.style.borderColor = (contest.active && contest.week===wk) ? "#2fdb" : "#044";
    badge.style.color = (contest.active && contest.week===wk) ? "#2fdb" : "#888";

    const ol = document.getElementById("bpc-list");
    if (!list.length){
      ol.innerHTML = `<li class="muted">No scores yet.</li>`;
    }else{
      ol.innerHTML = list.map((it,i)=>{
        const rank = i+1;
        const you = it.code===my ? "(you)" : "";
        const cup = rank===1?"ü•á":rank===2?"ü•à":rank===3?"ü•â":"";
        return `<li style="padding:8px 9px;border-bottom:1px dashed rgba(255,255,255,.08);display:flex;justify-content:space-between">
                  <span style="color:#f6f">#${String(rank).padStart(2,'0')}</span>
                  <span style="opacity:.9">${it.code}${you}</span>
                  <span>${cup}</span>
                  <span style="opacity:.9">${it.score||0} pts</span>
                </li>`;
      }).join("");
    }

    // claim (only rank-1 + active)
    const box  = document.getElementById("bpc-claim");
    const btn  = document.getElementById("bpc-claim-btn");
    const info = document.getElementById("bpc-claim-info");
    const first = list[0];
    let canClaim = Boolean(contest.active && first && first.code===my);

    box.style.display = canClaim ? "block" : "none";
    info.style.display = "none"; info.textContent = "";

    // already claimed?
    try{
      const prev = await get(ref(db, `claims/${wk}/${my}`));
      if (prev.exists()) { canClaim = false; box.style.display = "block"; info.style.display='block'; info.textContent='You already claimed this week.'; }
    }catch(e){}

    btn.onclick = async ()=>{
      if (!canClaim) return;

      // unique claim code
      const claimCode = genClaimCode(wk, my);

      // save claim
      const payload = {
        code: my,
        score: first?.score||0,
        week: wk,
        ts: Date.now(),
        method: "email",
        claimCode
      };
      await set(ref(db, `claims/${wk}/${my}`), payload);

      // prepare email
      const subj = encodeURIComponent(`BPC Weekly Prize Claim ‚Äì ${wk} ‚Äì ${my}`);
      const body = encodeURIComponent(
`Hello Babypeacock Team,

I am claiming my weekly prize.

Week: ${wk}
Code: ${my}
Score: ${first?.score||0}
Claim Code: ${claimCode}
Wallet (TRX):
Contact (X/Telegram):

Thanks!`
      );
      location.href = `mailto:${ADMIN_EMAIL}?subject=${subj}&body=${body}`;
    };

    wrap.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
  window.showWeeklyPanel = showWeeklyPanel;
  if (openWeeklyBtn) openWeeklyBtn.onclick = showWeeklyPanel;

  /******************** SIMPLE GAME LOOP (starter-safe) ********************/
  // --- STATE ---
  let started=false, gameOver=false, scoreSent=false, _lt=0;
  let score=0, lives=3, powerTime=0;

  // --- INPUT ---
  let holding=false, pointerX=210, pointerY=580;
  cv.addEventListener("pointerdown",e=>{holding=true;});
  cv.addEventListener("pointerup",e=>{holding=false;});
  cv.addEventListener("pointermove",e=>{
    const r = cv.getBoundingClientRect();
    pointerX = (e.clientX-r.left)*cv.width/r.width;
    pointerY = (e.clientY-r.top )*cv.height/r.height;
  }, {passive:true});

  // --- ENTITIES (minimal demo; senin varlƒ±k sistemin varsa onunla deƒüi≈üir) ---
  const ASSETS = {
    player: "player.png",
    ufo_red: "ufo_red.png",
    ufo_green: "ufo_green.png",
    ufo_gray: "ufo_gray.png",
    peacock: "peacock.png"
  };
  const img = {};
  async function load(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.src=src; }); }
  // hƒ±zlƒ± y√ºkle (hata olsa da oyunu bloklamasƒ±n)
  (async()=>{
    for(const k of Object.keys(ASSETS)){ try{ img[k] = await load(ASSETS[k]); }catch{} }
  })();

  const player = {x:210-22,y:580,w:44,h:44,spd:0.25};
  let enemies = [];
  let bullets = [];
  let enemyBullets = [];
  let gems = []; // (s√ºs)

  function spawnEnemy(){
    const kinds = ["ufo_red","ufo_green","ufo_gray"];
    const k = kinds[(Math.random()*kinds.length)|0];
    enemies.push({k, x: Math.random()*cv.width, y:-40, w:36,h:36, vy: 0.08 + Math.random()*0.15});
  }
  function shoot(){
    bullets.push({x:player.x+player.w/2-2,y:player.y-10,vy:-0.6,w:4,h:8});
  }

  function collide(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
  }

  function update(dt){
    // player move
    if (holding){
      // yumu≈üak takip
      player.x += (pointerX-player.x-22)*0.15;
      player.y += (pointerY-player.y-22)*0.15;
      // auto fire
      powerTime += dt;
      if (powerTime>130){ shoot(); powerTime=0; }
    }

    // clamp
    player.x = Math.max(6, Math.min(cv.width - (player.w+6), player.x));
    player.y = Math.max(6, Math.min(cv.height - (player.h+6), player.y));

    // bullets
    bullets.forEach(b=>{ b.y += b.vy*dt; });
    bullets = bullets.filter(b=>b.y>-20);

    // enemies
    if (Math.random()<0.02) spawnEnemy();
    enemies.forEach(e=>{ e.y += e.vy*dt; });
    enemies = enemies.filter(e=>e.y<cv.height+40);

    // collisions
    for (const e of enemies){
      // bullet hit
      for (const b of bullets){
        if (collide({x:b.x,y:b.y,w:b.w,h:b.h}, e)){
          e.dead=true; b.dead=true; score+=5;
        }
      }
      // touch player
      if (collide(player,e)){
        e.dead=true; lives--; score=Math.max(0,score-10);
        if (lives<=0){ gameOver=true; }
      }
    }
    enemies = enemies.filter(e=>!e.dead);
    bullets = bullets.filter(b=>!b.dead);

    // UI
    scEl.textContent = score;
    pxEl.textContent = Math.floor(Math.max(0,powerTime/1000));
  }

  function draw(t){
    ctx.fillStyle="#06101e"; ctx.fillRect(0,0,cv.width,cv.height);

    // stars
    ctx.fillStyle="rgba(255,255,255,.08)";
    for(let i=0;i<120;i++){
      const x=(i*37 + (t*.02))%cv.width, y=(i*83 + (t*.06))%cv.height;
      ctx.fillRect(x,y,1,1);
    }

    // enemies
    enemies.forEach(e=>{
      const im = img[e.k];
      if (im) ctx.drawImage(im,e.x,e.y,e.w,e.h);
      else { ctx.fillStyle="#ef4444"; ctx.fillRect(e.x,e.y,e.w,e.h); }
    });

    // bullets
    ctx.fillStyle="#00ffc8"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

    // player
    if (img.player) ctx.drawImage(img.player,player.x,player.y,player.w,player.h);
    else { ctx.fillStyle="#38bdf8"; ctx.fillRect(player.x,player.y,player.w,player.h); }

    // GAME OVER
    if (gameOver){
      try{ window.incrementGlobalPlays && window.incrementGlobalPlays(); }catch(e){}
      renderFinalScore(t);
      if (!scoreSent) scoreSent = true;
    }
  }

  function loop(t){
    const dt = Math.min((t - _lt) || 16, 32);
    _lt = t;
    if (!started){ requestAnimationFrame(loop); return; }
    update(dt);
    draw(t);
    requestAnimationFrame(loop);
  }

  function renderFinalScore(){
    overEl.style.display="flex";
    finalEl.textContent = String(score);
    // kaydet (tek sefer)
    if (!scoreSent){
      scoreSent = true;
      saveScore(score).catch(()=>{});
    }
  }

  function startGame(e){
    try{ e && e.preventDefault && e.preventDefault(); }catch(_){}
    started=true; gameOver=false; scoreSent=false;
    score=0; lives=3; powerTime=0; scEl.textContent=score; pxEl.textContent=0;
    overEl.style.display="none";
    startOverlay.style.display="none";
    _lt = performance.now();
    requestAnimationFrame(loop);
  }

  // baƒüla
  if (startBtn)   startBtn.onclick = startGame;
  if (restartBtn) restartBtn.onclick = startGame;
  if (startOverlay) startOverlay.addEventListener("pointerdown", startGame, {passive:false});

  // overlay ba≈üta a√ßƒ±k
  startOverlay.style.display = "flex";

  // Haftalƒ±k panel butonu
  if (openWeeklyBtn) openWeeklyBtn.onclick = showWeeklyPanel;

  </script>
  <!-- ========================= END ========================= -->
</body>
</html>
