<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Babypeacock ‚Äî BPC Space Game</title>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  
  /* UI - Safe Area Uyumlu */
  #brand {
    position:fixed; z-index:10; font-weight:900;
    background:linear-gradient(90deg,#22d3ee,#34d399); -webkit-background-clip:text; background-clip:text; color:transparent;
    top: max(6px, env(safe-area-inset-top));
    left: max(12px, env(safe-area-inset-left));
  }

  #score {
    position:fixed; left:0; right:0; text-align:center; color:#00ffc8; font-weight:700; z-index:10;
    top: max(8px, env(safe-area-inset-top));
  }

  #power {
    position:fixed; color:#a7f3d0; font-weight:700; z-index:10;
    top: max(8px, env(safe-area-inset-top));
    right: max(10px, env(safe-area-inset-right));
  }

  #lives {
    position:fixed; left:0; right:0; text-align:center; color:#f87171; font-weight:700; z-index:10;
    /* Pause butonuna yer a√ßmak i√ßin biraz yukarƒ± aldƒ±k */
    bottom: max(60px, env(safe-area-inset-bottom)); 
  }

  /* PAUSE BUTONU (D√ºzeltildi) */
  #pauseBtn {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: max(15px, env(safe-area-inset-bottom)); /* En alta, g√ºvenli alana */
    z-index: 50; /* En √ºst katman */
    width: 44px; height: 44px;
    background: #0f172a; /* Koyu mavi arka plan */
    border: 2px solid #38bdf8; /* Parlak mavi √ßer√ßeve */
    color: #38bdf8;
    border-radius: 50%;
    font-size: 14px;
    font-weight: 900;
    display: flex; /* ƒ∞√ßini ortalamak i√ßin */
    align-items: center; 
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
  }

  /* Overlayler */
  #startOverlay, #gameOver, #pauseOverlay, #countdownOverlay {
    position:fixed; inset:0; display:none; 
    align-items:center; justify-content:center; flex-direction:column; z-index:40;
  }
  #startOverlay { background:rgba(0,0,0,.9); color:#fff; display:flex; }
  #gameOver     { background:rgba(0,0,0,0.85); color:#fff; } /* Arkasƒ± hafif koyu olsun ki yazƒ±lar karƒ±≈ümasƒ±n */
  #pauseOverlay { background:rgba(0,0,0,0.8); color:#fff; backdrop-filter:blur(3px); }
  
  /* Geri Sayƒ±m */
  #countdownOverlay { 
    background:transparent; 
    pointer-events:none; 
    z-index:60; /* Her ≈üeyin √ºst√ºnde */
  }
  #cntText {
    font-size: 90px; font-weight: 900; color: #fff;
    text-shadow: 0 0 25px #22d3ee;
    font-family: monospace; /* Sabit geni≈ülikli font, titremeyi azaltƒ±r */
  }
  @keyframes popIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }

  .btn { margin-top:12px; padding:12px 24px; border:1px solid #00ffc8; background:#0b1220; color:#00ffc8; border-radius:12px; font-weight:900; z-index:50; font-size:16px;}

  /* Top10 Listesi */
  #bpc-top10 {
    position:fixed; left:50%; transform:translateX(-50%);
    top:calc(50% + 20px); /* Game Over yazƒ±sƒ±nƒ±n altƒ±na */
    width:min(420px,92vw); background:#000; border:1px solid #222; border-radius:10px; padding:10px 12px;
    color:#fff; font-size:14px; line-height:1.5; z-index:45;
  } 
  #bpc-top10 h4 { margin:0 0 6px 0; font-size:15px; font-weight:800; text-align:center; color:#e2e8f0; }
  #week-timer { text-align:center; font-size:12px; color:#94a3b8; margin-bottom:8px; font-weight:600; border-bottom:1px dashed #333; padding-bottom:6px; }
  
  /* Lƒ∞STE D√úZELTMESƒ∞: √áift numarayƒ± engellemek i√ßin list-style kapalƒ± */
  #bpc-top10 ol { margin:0; padding-left:10px; list-style: none; } 
  #bpc-top10 li { margin-bottom:5px; border-bottom:1px solid #111; padding-bottom:2px;}
  #bpc-top10 .me { color:#ff5c5c; font-weight:bold; } 
  
  #globalCounterBox { margin-top:15px; font-size:13px; opacity: 0.8; }

  canvas { display:block; margin:0 auto; background:#020617; touch-action:none; user-select:none; width:100%; height:100%; }
</style>
</head>
<body>
  <div id="brand">Babypeacock ü¶ö</div>
  <div id="score">ü¶ö Score: <span id="sc">0</span></div>
  <div id="power">üíé <span id="px">0</span>s</div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  
  <div id="pauseBtn">II</div>

  <div id="startOverlay">
    <div style="margin-bottom:12px; font-size: 14px; color: #ccc;">Hold & drag to move</div>
    <button id="startBtn" class="btn">START GAME</button>
    <div id="playerCode" style="margin-top:15px;font-size:14px;color:#00ffc8;"></div>
  </div>

  <div id="pauseOverlay">
    <div style="font-size:32px; font-weight:900; margin-bottom:15px; color:#e2e8f0; letter-spacing: 2px;">PAUSED</div>
    <button id="resumeBtn" class="btn">RESUME</button>
  </div>

  <div id="countdownOverlay">
    <div id="cntText"></div>
  </div>

  <div id="gameOver">
    <div style="font-weight:900; font-size: 24px; margin-bottom:8px; color: #ef4444;">GAME OVER</div>
    <div style="font-size: 18px; color: #00ffc8; margin-bottom: 12px;">Final Score: <span id="finalScoreDisp">0</span></div>
    <button id="restart" class="btn">TRY AGAIN</button>
    <div id="globalCounterBox">üåç Global plays: <span id="globalCounter">‚Ä¶</span></div>
  </div>

  <div id="bpc-top10" style="display:none">
    <h4>üèÜ Weekly Top 10</h4>
    <div id="week-timer">Week <span id="wk-num">--</span> ‚Ä¢ <span id="wk-rem" style="color:#facc15">--:--:--</span></div>
    <ol id="bpc-list"></ol>
  </div>

  <canvas id="game"></canvas>

  <audio id="boom" preload="auto" playsinline>
    <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_2b1b0dcd8c.mp3" type="audio/mpeg">
  </audio>

<script>
/* ====== OYUN KODU ====== */
const cv=document.getElementById("game");
function resize(){ cv.width=window.innerWidth; cv.height=window.innerHeight; }
window.addEventListener('resize', resize); resize();

const ctx=cv.getContext("2d"); ctx.imageSmoothingEnabled=false;
const scEl=document.getElementById("sc"),pxEl=document.getElementById("px"),livesEl=document.getElementById("lives");
const startOverlay=document.getElementById("startOverlay"),startBtn=document.getElementById("startBtn");
const overEl=document.getElementById("gameOver"),restartBtn=document.getElementById("restart"),boom=document.getElementById("boom");
const top10Box=document.getElementById("bpc-top10");
const finalScoreDisp = document.getElementById("finalScoreDisp");

// Pause & Countdown Elements
const pauseBtn=document.getElementById("pauseBtn"), pauseOverlay=document.getElementById("pauseOverlay"), resumeBtn=document.getElementById("resumeBtn");
const countOverlay=document.getElementById("countdownOverlay"), cntText=document.getElementById("cntText");

/* Utils */
function clamp(v,a,b){return v<a?a:v>b?b:v;}
function rand(a,b){return a+Math.random()*(b-a);}
function rectHit(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);}
function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
function keyOutDark(img,TH=80){const w=img.width,h=img.height,off=document.createElement('canvas');off.width=w;off.height=h;
  const g=off.getContext('2d'); g.drawImage(img,0,0); const d=g.getImageData(0,0,w,h),a=d.data;
  for(let i=0;i<a.length;i+=4){const r=a[i],g1=a[i+1],b=a[i+2],lum=0.2126*r+0.7152*g1+0.0722*b;if((r<TH&&g1<TH&&b<TH)||lum<TH*0.8) a[i+3]=0;}
  g.putImageData(d,0,0); return off;}

/* Assets */
const PLAYER_SRC="img/player/bpc_mini.png";
const ENEMY_SRC={red:"bpc_enemy_red.png", green:"bpc_enemy_green.png", ufo_red:"bpc_enemy_ufo_red.png", ufo_gray:"bpc_enemy_ufo_gray.png"};
const PEACOCK_SRC="yc3ku6.jpg";

/* State */
let bullets=[], enemies=[], enemyBullets=[], gems=[], mascots=[], particles=[];
let score=0,lives=3,started=false,gameOver=false,paused=false,inCountdown=false;
let powerTime=0, fireTimer=0, FIRE_MS=170;
let elapsed=0,enT=0,gemT=0,mascotT=0;
let scoreSent=false;
let player={x:cv.width/2-33,y:cv.height-140,w:66,h:66};

/* Oyuncu kodu */
function getPlayerCode(){
  let code = localStorage.getItem("playerCode");
  if (!code){ code = "BPC" + Math.floor(10000 + Math.random()*89999); localStorage.setItem("playerCode", code); }
  return code;
}
(function(){ const box=document.getElementById("playerCode"); if(box) box.innerHTML=`üë§ Oyuncu: <b>${getPlayerCode()}</b>`; })();

/* Anti-montaj code */
let playId=Math.floor(performance.now()+Math.random()*1e9);
let verifyCode="--------";
async function makeCode(){
  const t=Math.floor(Date.now()/1000);
  const msg=new TextEncoder().encode(playId+"|"+t+"|babypeacock");
  const buf=await crypto.subtle.digest("SHA-256",msg);
  verifyCode=[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,8).toUpperCase();
}
makeCode();

/* Stars - ORƒ∞Jƒ∞NAL YAVA≈û HALƒ∞ */
const starsA=[], starsB=[];
for(let i=0;i<60;i++) starsA.push({x:rand(0,cv.width),y:rand(0,cv.height)});
for(let i=0;i<35;i++) starsB.push({x:rand(0,cv.width),y:rand(0,cv.height)});

/* --- COUNTDOWN LOGIC --- */
function startCountdownSequence(callback) {
  inCountdown = true;
  countOverlay.style.display = "flex";
  let count = 3;
  
  const showNum = (num) => {
    cntText.textContent = num;
    cntText.style.animation = 'none';
    cntText.offsetHeight; // trigger reflow
    cntText.style.animation = 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
  };

  showNum(3);

  const timer = setInterval(() => {
    count--;
    if (count > 0) {
      showNum(count);
    } else if (count === 0) {
      showNum("GO!");
    } else {
      clearInterval(timer);
      countOverlay.style.display = "none";
      inCountdown = false;
      if (callback) callback();
    }
  }, 800); 
}

/* --- GAME FLOW --- */
function initGame() {
  if(started) return;
  const doc = document.documentElement;
  try { if (doc.requestFullscreen) doc.requestFullscreen(); else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen(); } catch(e){}
  
  startOverlay.style.display="none";
  pauseBtn.style.display="none"; // Geri sayƒ±m bitene kadar gizle
  
  startCountdownSequence(() => {
    started = true;
    paused = false;
    pauseBtn.style.display="flex"; // Oyun ba≈ülayƒ±nca g√∂ster
    player.y = cv.height - 140;
    player.x = cv.width/2 - player.w/2;
  });
}

startBtn.onclick = initGame;

// Pause Logic
pauseBtn.onclick = () => {
  if (!started || gameOver || inCountdown) return;
  paused = true;
  pauseOverlay.style.display = "flex";
  pauseBtn.style.display = "none"; 
};

resumeBtn.onclick = () => {
  pauseOverlay.style.display = "none";
  // Hemen ba≈ülatma, geri sayƒ±m yap
  startCountdownSequence(() => {
    paused = false;
    pauseBtn.style.display = "flex";
  });
};

// Controls
function updateLives(){livesEl.innerHTML="‚ù§Ô∏è".repeat(lives);} updateLives();
let holding=false;
function getX(e){return (e.clientX??(e.touches?e.touches[0].clientX:0))-cv.getBoundingClientRect().left;}

cv.addEventListener("pointerdown",e=>{ if(!started || paused || inCountdown)return; holding=true; player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w); });
cv.addEventListener("pointermove",e=>{ if(!holding || paused || inCountdown)return; player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w); });
cv.addEventListener("pointerup",()=>holding=false); cv.addEventListener("pointercancel",()=>holding=false);

/* Fire */
function shoot(){
  if(powerTime>0){
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:3});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:-3});
  } else {
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
  }
}

/* Gem + Mascot + Explode */
function drawDiamondGem(ctx,x,y,w,h,t){ctx.save();ctx.translate(x+w/2,y+h/2);ctx.rotate(Math.sin(t*2)*0.20);
  const W=w*0.9,H=h*0.9;ctx.shadowColor="rgba(56,189,248,.7)";ctx.shadowBlur=14;
  const grad=ctx.createLinearGradient(-W/2,0,W/2,0);grad.addColorStop(0,"#baf2ff");grad.addColorStop(0.5,"#60e8ff");grad.addColorStop(1,"#99f6e4");
  ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(0,-H*0.5);ctx.lineTo(W*0.48,0);ctx.lineTo(0,H*0.56);ctx.lineTo(-W*0.48,0);ctx.closePath();ctx.fill();
  ctx.shadowBlur=0;ctx.lineWidth=1.8;ctx.strokeStyle="#0e7490";ctx.stroke();ctx.restore();}
function spawnGem(){ if(powerTime>0) return; const s=22; gems.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.5}); }
function spawnMascot(){ if(score>=200 && Math.random()<0.8) return; const s=22; mascots.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.4}); }
function explosion(x,y,count=18){const left=Math.max(0,120-particles.length);const n=Math.min(count,left);
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,sp=1.2+Math.random()*2.8;particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:420+Math.random()*280,size:1.6+Math.random()*2.4});}
  try{boom.currentTime=0;boom.play().catch(()=>{});}catch{}}

/* Enemy */
function allowedKindsByTime(t){if(t<10) return ["ufo_red","ufo_gray"]; if(t<40) return ["ufo_red","ufo_gray","green"]; return ["ufo_red","ufo_gray","green","red"];}
function spawnEnemy(k){ if(enemies.length>12) return; const size=rand(48,70); const kind=k[Math.floor(Math.random()*k.length)];
  const img=enemyImg[kind]||null; enemies.push({x:rand(0,cv.width-size),y:-size,w:size,h:size,vy:rand(1.4,3),kind,img,canShoot:(kind==="red"||kind==="green"),shootT:0,shootInt:500}); }
function enemyShoot(e){ if(!e.canShoot) return; const cx=e.x+e.w/2; const mul=(score>=500)?1.25:(score>=300)?1.15:1;
  if(e.kind==="red") enemyBullets.push({x:cx-2,y:e.y+e.h,w:4,h:12,vy:6*mul,color:"#ef4444"});
  else enemyBullets.push({x:cx-1,y:e.y+e.h,w:2,h:18,vy:6.5*mul,color:"#22c55e"}); }

/* END GAME */
async function endGame(){
  gameOver=true;
  pauseBtn.style.display="none"; 
  overEl.style.display="flex"; // Background CSS'te ayarlandƒ±
  finalScoreDisp.textContent = score;

  try{
    if (window.saveScore) await window.saveScore(score);
    if (window.showWeeklyPanel) window.showWeeklyPanel();
    if (window.incrementGlobalPlays) await window.incrementGlobalPlays();
    if (window.bumpLocation) await window.bumpLocation();
  }catch(err){ console.error("endGame() error:",err); }

  top10Box.style.display = "block";
}

/* Update loop */
function update(dt){
  // Orijinal yƒ±ldƒ±z hareketi (Yava≈ü ve sakin)
  starsA.forEach(s=>{ s.y+=0.35; if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);} });
  starsB.forEach(s=>{ s.y+=0.9;  if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);} });

  if(!started || gameOver || paused || inCountdown) return;

  elapsed += dt/1000; enT += dt; gemT += dt; mascotT += dt;
  if(powerTime>0){ powerTime-=dt; if(powerTime<0) powerTime=0; }
  pxEl.textContent = powerTime>0 ? Math.ceil(powerTime/1000) : 0;
  fireTimer += dt; if(holding && fireTimer>FIRE_MS){ shoot(); fireTimer=0; }

  let speedMultiplier=1, spawnMultiplier=1;
  if(score>=300) speedMultiplier=1.30;
  if(score>=500){ speedMultiplier=1.30; spawnMultiplier=1.40; }

  if(enT>600/spawnMultiplier){ spawnEnemy(allowedKindsByTime(elapsed)); enT=0; }
  if(gemT>(score>=200?13000:9000)){ if(Math.random()<0.55) spawnGem(); gemT=0; }
  if(mascotT>12000){ spawnMascot(); mascotT=0; }

  bullets.forEach(b=>{ b.y+=b.vy; b.x+=(b.ang||0)*0.5; });
  bullets=bullets.filter(b=> b.y>-20);

  enemies.forEach(e=>{ e.y+=e.vy; e.shootT+=dt; if(e.canShoot && e.shootT>=e.shootInt){ e.shootT=0; enemyShoot(e);} });
  enemies=enemies.filter(e=> e.y<=cv.height+40);

  enemyBullets.forEach(m=>{ m.y+=m.vy; });
  enemyBullets=enemyBullets.filter(m=> m.y<cv.height+40);

  gems.forEach(g=> g.y+=g.vy);       gems=gems.filter(g=> g.y<cv.height+40);
  mascots.forEach(m=> m.y+=m.vy);    mascots=mascots.filter(m=> m.y<cv.height+40);

  for(const e of enemies){ if(rectHit(player,e)){ explosion(player.x+player.w/2,player.y+player.h/2,22); lives--; updateLives(); if(lives<=0) endGame(); e.dead=1; } }
  for(const m of enemyBullets){ if(rectHit(player,m)){ explosion(player.x+player.w/2,player.y+player.h/2,22); lives--; updateLives(); if(lives<=0) endGame(); m.dead=1; } }
  for(const b of bullets){ for(const e of enemies){ if(rectHit(b,e)){ explosion(e.x+e.w/2,e.y+e.h/2,16); b.dead=1; e.dead=1; score++; scEl.textContent=score; } } }
  for(const g of gems){ if(rectHit(player,g)){ powerTime=15000; g.dead=1; } }
  for(const m of mascots){ if(rectHit(player,m)){ lives=Math.min(5,lives+1); updateLives(); m.dead=1; } }

  enemies=enemies.filter(o=>!o.dead); bullets=bullets.filter(o=>!o.dead);
  enemyBullets=enemyBullets.filter(o=>!o.dead); gems=gems.filter(o=>!o.dead); mascots=mascots.filter(o=>!o.dead);

  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.life-=dt; if(p.life<=0){particles.splice(i,1);continue;}
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; }
}

/* Draw & Loop */
function draw(t){
  ctx.clearRect(0,0,cv.width,cv.height);
  // Yƒ±ldƒ±zlarƒ± √ßiz
  ctx.fillStyle="rgba(190,220,255,.85)"; starsA.forEach(s=>ctx.fillRect(s.x,s.y,1,1));
  ctx.fillStyle="rgba(255,255,255,.95)";  starsB.forEach(s=>ctx.fillRect(s.x,s.y,1.2,1.2));

  if(playerImg) ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
  else { ctx.fillStyle="#38bdf8"; ctx.fillRect(player.x,player.y,player.w,player.h); }

  ctx.fillStyle="#00ffc8"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));
  enemies.forEach(e=>{ if(e.img) ctx.drawImage(e.img,e.x,e.y,e.w,e.h); else { ctx.fillStyle=e.kind==="green"?"#22c55e":"#ef4444"; ctx.fillRect(e.x,e.y,e.w,e.h);} });
  enemyBullets.forEach(m=>{ ctx.fillStyle=m.color; ctx.fillRect(m.x,m.y,m.w,m.h); });

  gems.forEach(g=> drawDiamondGem(ctx,g.x,g.y,g.w,g.h, performance.now()/1000));
  if(peacockImg) mascots.forEach(m=>ctx.drawImage(peacockImg,m.x,m.y,m.w,m.h));

  particles.forEach(p=>{ const a=Math.max(0,p.life/500); ctx.globalAlpha=a; ctx.fillStyle="rgba(255,200,80,1)";
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; });

  // Final Skoru renderFinalScore fonksiyonu √ßiziyor, Game Over ekranƒ±nda altta kalƒ±yor.
  // Overlay kullandƒ±ƒüƒ±mƒ±z i√ßin renderFinalScore'u silebiliriz ya da sadece efekt i√ßin tutabiliriz.
}
function loop(t){ const dt=Math.min(t-(window._lt||t),32); window._lt=t; update(dt); draw(t); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* Restart */
restartBtn.onclick=()=>{
  if(window.bpcTimer) clearInterval(window.bpcTimer);
  score=0;lives=3;powerTime=0; scEl.textContent=score; pxEl.textContent=0;
  bullets=[];enemies=[];enemyBullets=[];gems=[];mascots=[];particles=[];
  updateLives(); gameOver=false; started=false; scoreSent=false; paused=false; inCountdown=false;
  overEl.style.display="none"; 
  top10Box.style.display="none";
  pauseBtn.style.display="none"; 
  playId=Math.floor(performance.now()+Math.random()*1e9); makeCode();
  
  startOverlay.style.display="flex";
};

/* Preload */
let playerImg=null, enemyImg={red:null,green:null,ufo_red:null,ufo_gray:null}, peacockImg=null;
(async function(){
  try{ const p=await loadImage(PLAYER_SRC); playerImg=keyOutDark(p,80);}catch{}
  for(const k of Object.keys(ENEMY_SRC)){ try{ const im=await loadImage(ENEMY_SRC[k]); enemyImg[k]=keyOutDark(im,80);}catch{} }
  try{ const bird=await loadImage(PEACOCK_SRC); peacockImg=keyOutDark(bird,70);}catch{}
})();
</script>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, get, set, push, onValue, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const INSTANCE_URL = "https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
const app = getApps().length ? getApps()[0] : initializeApp({ databaseURL: INSTANCE_URL });
const db  = getDatabase(app);
window.db = db;

function weekKey(d=new Date()){
  const y  = d.getFullYear();
  const w  = Math.floor((d - new Date(y,0,1)) / 604800000) + 1;
  return `${y}-W${String(w).padStart(2,"0")}`;
}
function getPlayerCode(){
  let c = localStorage.getItem("playerCode");
  if(!c){ c = "BPC" + Math.floor(10000 + Math.random()*89999); localStorage.setItem("playerCode", c); }
  return c;
}

function getFlagEmoji(countryCode) {
  if (!countryCode) return "üè≥Ô∏è"; 
  const codePoints = countryCode.toUpperCase().split('').map(char =>  127397 + char.charCodeAt());
  return String.fromCodePoint(...codePoints);
}
function getCountryCode() {
  try {
    const lang = (navigator.languages && navigator.languages[0]) || navigator.language || "en-US";
    let code = (lang.split('-')[1] || "").toUpperCase();
    if (code === "UK") code = "GB";
    if (!code) code = "TR";
    return code;
  } catch { return "TR"; }
}
function getCountryName() {
  try {
    const lang = (navigator.languages && navigator.languages[0]) || navigator.language || "en-US";
    const code = getCountryCode(); 
    const dn = new Intl.DisplayNames([lang, "tr-TR"], { type: "region" });
    return dn.of(code) || code;
  } catch { return "T√ºrkiye"; }
}

/* Stats */
const refCounter = ref(db, "stats/globalPlays");
const elGC       = document.getElementById("globalCounter");
const cached     = Number(localStorage.getItem("bpc_global_plays")) || 0;
if (elGC) elGC.textContent = cached ? cached.toLocaleString("en-US") : "‚Ä¶";
onValue(refCounter, s => {
  const v = Number(s.val() ?? 0);
  if (elGC) elGC.textContent = v.toLocaleString("en-US");
  localStorage.setItem("bpc_global_plays", String(v));
});
function incrementGlobalPlays(){
  return runTransaction(refCounter, v => (v||0) + 1);
}

async function bumpLocation(){
  try{
    const name = getCountryName(); 
    const locRef  = ref(db, `stats/locations/${name}`);
    await runTransaction(locRef, v => (v||0) + 1);
  }catch(e){}
}
(async function bumpLocationOncePerDay(){
  try{
    const todayKey = "bpc_loc_day";
    const today    = new Date().toISOString().slice(0,10);
    if (localStorage.getItem(todayKey) === today) return;
    await bumpLocation();
    const totalRef = ref(db, "stats/totalStarts");
    await runTransaction(totalRef, v => (v||0) + 1);
    localStorage.setItem(todayKey, today);
  }catch(e){}
})();

async function saveScore(score){
  const code = getPlayerCode();
  const country = getCountryCode(); 
  const countryName = getCountryName(); 
  const ts   = Date.now();
  
  const payload = { code, score, ts, country, countryName };
  await push(ref(db, "scores"), payload);
  const wk = weekKey();
  await push(ref(db, `scoresWeekly/${wk}`), { ...payload, week: wk });
}

async function getWeeklyTop10(wk = weekKey()){
  const snap = await get(ref(db, `scoresWeekly/${wk}`));
  const bestByCode = {};
  snap.forEach(ch => {
    const v = ch.val();
    if (!v || typeof v.score!=="number") return;
    if (!bestByCode[v.code] || v.score > bestByCode[v.code].score) bestByCode[v.code] = v;
  });
  const list = Object.values(bestByCode).sort((a,b)=>b.score-a.score).slice(0,10);
  return list;
}

async function showWeeklyPanel(){
  const wk  = weekKey();
  const me  = getPlayerCode();
  const ol  = document.getElementById("bpc-list");
  const box = document.getElementById("bpc-top10");
  
  const weekNumEl = document.getElementById("wk-num");
  if(weekNumEl) weekNumEl.textContent = wk.split("-W")[1]; 

  if(window.bpcTimer) clearInterval(window.bpcTimer);
  function updateTimer(){
    const now = new Date();
    const day = now.getUTCDay(); 
    const target = new Date(now);
    const daysUntilSunday = (7 - day) % 7; 
    target.setUTCDate(now.getUTCDate() + daysUntilSunday);
    target.setUTCHours(23, 59, 59, 999);
    const diff = target - now;
    const remEl = document.getElementById("wk-rem");
    if(!remEl) return;
    if(diff <= 0) { remEl.textContent = "Resetting..."; return; }
    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((diff % (1000 * 60)) / 1000);
    remEl.textContent = `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    remEl.style.color = (d === 0) ? "#ef4444" : "#facc15";
  }
  updateTimer(); window.bpcTimer = setInterval(updateTimer, 1000);

  const list = await getWeeklyTop10(wk);
  if (ol){
    ol.innerHTML = list.length
      ? list.map((it,i)=>{
          const mine = it.code === me;
          const flag = it.country ? getFlagEmoji(it.country) : "üè≥Ô∏è";
          // SIRA NUMARASI BURADAN GELƒ∞YOR. CSS'TE list-style KAPATILDIƒûI ƒ∞√áƒ∞N ARTIK SADECE BU G√ñR√úNECEK
          return `<li class="${mine?'me':''}">${i+1}. ${flag} ${it.code} ‚Üí ${it.score} pts</li>`;
        }).join("")
      : `<div style="opacity:.7;text-align:center">No scores this week yet.</div>`;
  }
  if (box) box.style.display = "block";
}

window.incrementGlobalPlays = incrementGlobalPlays;
window.saveScore           = saveScore;
window.showWeeklyPanel     = showWeeklyPanel;
window.bumpLocation        = bumpLocation;
</script>
</body>
</html>
