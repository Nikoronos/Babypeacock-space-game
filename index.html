<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Babypeacock ‚Äî BPC Space Game</title>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #brand{position:fixed;top:6px;left:12px;z-index:4;font-weight:900;
    background:linear-gradient(90deg,#22d3ee,#34d399);-webkit-background-clip:text;background-clip:text;color:transparent}
  #score{position:fixed;top:8px;left:0;right:0;text-align:center;color:#00ffc8;font-weight:700;z-index:4}
  #power{position:fixed;top:8px;right:10px;color:#a7f3d0;font-weight:700;z-index:4}
  #lives{position:fixed;bottom:10px;left:0;right:0;text-align:center;color:#f87171;font-weight:700;z-index:4}
  #gameOver,#startOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;
    background:rgba(0,0,0,.84);color:#fff;font-size:20px;font-weight:800;z-index:6;text-align:center}
  .btn{margin-top:12px;padding:12px 22px;border:1px solid #00ffc8;background:#0b1220;color:#00ffc8;border-radius:12px;font-weight:900}
  canvas{display:block;margin:44px auto 0 auto;background:#020617;touch-action:none;user-select:none;width:min(420px,96vw);height:auto;max-height:92vh}
</style>
</head>
<body>
  <div id="brand">Babypeacock ü¶ö</div>
  <div id="score">ü¶ö Score: <span id="sc">0</span></div>
  <div id="power">üíé <span id="px">0</span>s</div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>

  <div id="startOverlay" style="display:flex">
    <div style="margin-bottom:8px">Hold & drag to move ‚Äî auto fire while holding</div>
    <button id="startBtn" class="btn">START</button>
    <div id="playerCode" style="margin-top:10px;font-size:14px;color:#00ffc8;"></div>
    <div style="font-size:12px;opacity:.75;margin-top:8px">Tap anywhere to start</div>
  </div>

  <div id="gameOver">
    <div style="font-weight:900;margin-bottom:8px">GAME OVER</div>
    <button id="restart" class="btn">Restart</button>
    <!-- üåç Global counter (English) -->
    <div id="globalCounterBox" style="margin-top:10px;font-size:14px">
      üåç Global plays: <span id="globalCounter">‚Ä¶</span>
    </div>
  </div>

  <canvas id="game" width="420" height="700"></canvas>

  <audio id="boom" preload="auto" playsinline>
    <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_2b1b0dcd8c.mp3" type="audio/mpeg">
  </audio>

<script>
/* ---------- Canvas / HUD ---------- */
const cv=document.getElementById("game"),ctx=cv.getContext("2d"); ctx.imageSmoothingEnabled=false;
const scEl=document.getElementById("sc"),pxEl=document.getElementById("px"),livesEl=document.getElementById("lives");
const startOverlay=document.getElementById("startOverlay"),startBtn=document.getElementById("startBtn");
const overEl=document.getElementById("gameOver"),restartBtn=document.getElementById("restart"),boom=document.getElementById("boom");

/* ---------- Utils ---------- */
function clamp(v,a,b){return v<a?a:v>b?b:v;}
function rand(a,b){return a+Math.random()*(b-a);}
function rectHit(a,b){return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);}
function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
function keyOutDark(img,TH=80){
  const w=img.width,h=img.height,off=document.createElement('canvas');off.width=w;off.height=h;
  const g=off.getContext('2d'); g.drawImage(img,0,0);
  const d=g.getImageData(0,0,w,h),a=d.data;
  for(let i=0;i<a.length;i+=4){
    const r=a[i],g1=a[i+1],b=a[i+2],lum=0.2126*r+0.7152*g1+0.0722*b;
    if((r<TH&&g1<TH&&b<TH)||lum<TH*0.8) a[i+3]=0;
  }
  g.putImageData(d,0,0); return off;
}

/* ---------- Assets ---------- */
const PLAYER_SRC="img/player/bpc_mini.png";
const ENEMY_SRC={red:"bpc_enemy_red.png", green:"bpc_enemy_green.png", ufo_red:"bpc_enemy_ufo_red.png", ufo_gray:"bpc_enemy_ufo_gray.png"};
const PEACOCK_SRC="yc3ku6.jpg";

/* ---------- State ---------- */
let bullets=[], enemies=[], enemyBullets=[], gems=[], mascots=[], particles=[];
let score=0,lives=3,started=false,gameOver=false;
let powerTime=0, fireTimer=0, FIRE_MS=170;
let elapsed=0,enT=0,gemT=0,mascotT=0;
let scoreSent=false;                 // ‚¨ÖÔ∏è sadece 1 kez kayƒ±t i√ßin bayrak
const player={x:cv.width/2-33,y:cv.height-120,w:66,h:66};

/* ---- Oyuncu kodu (ba≈ülangƒ±√ßta g√∂sterilecek) ---- */
function getPlayerCode(){
  let code = localStorage.getItem("playerCode");
  if (!code){
    const rnd = Math.floor(10000 + Math.random()*89999);
    code = "BPC" + rnd;
    localStorage.setItem("playerCode", code);
  }
  return code;
}
(function showPlayerCodeOnStart(){
  const box = document.getElementById("playerCode");
  if (box) box.innerHTML = `üë§ Oyuncu: <b>${getPlayerCode()}</b>`;
})();

/* ---- verification code (canvas i√ßine g√∂m√ºlen) ---- */
let playId = Math.floor(performance.now()+Math.random()*1e9);
let verifyCode = "--------";
async function makeCode(){
  const t = Math.floor(Date.now()/1000);
  const msg = new TextEncoder().encode(playId+"|"+t+"|babypeacock");
  const buf = await crypto.subtle.digest("SHA-256", msg);
  const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  verifyCode = hex.slice(0,8).toUpperCase();
}
makeCode();

/* ---------- Stars ---------- */
const starsA=[],starsB=[];
for(let i=0;i<60;i++) starsA.push({x:rand(0,cv.width),y:rand(0,cv.height)});
for(let i=0;i<35;i++) starsB.push({x:rand(0,cv.width),y:rand(0,cv.height)});

/* ---------- Controls ---------- */
function updateLives(){livesEl.innerHTML="‚ù§Ô∏è".repeat(lives);} updateLives();
function startGame(){if(started)return; started=true; startOverlay.style.display="none";}
startBtn.onclick=startGame;cv.onclick=startGame;
let holding=false;
function getX(e){return (e.clientX??(e.touches?e.touches[0].clientX:0))-cv.getBoundingClientRect().left;}
cv.addEventListener("pointerdown",e=>{if(!started)return;holding=true;player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w);});
cv.addEventListener("pointermove",e=>{if(!holding)return;player.x=clamp(getX(e)-player.w/2,0,cv.width-player.w);});
cv.addEventListener("pointerup",()=>holding=false); cv.addEventListener("pointercancel",()=>holding=false);

/* ---------- Player fire ---------- */
function shoot(){
  if(powerTime>0){
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:3});
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10,ang:-3});
  } else {
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:12,vy:-10});
  }
}

/* ---------- Diamond (mavi hediye) ---------- */
function drawDiamondGem(ctx,x,y,w,h,tSec){
  ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.rotate(Math.sin(tSec*2)*0.20);
  const W=w*0.9,H=h*0.9; ctx.shadowColor="rgba(56,189,248,.7)"; ctx.shadowBlur=14;
  const grad=ctx.createLinearGradient(-W/2,0,W/2,0);
  grad.addColorStop(0,"#baf2ff"); grad.addColorStop(0.5,"#60e8ff"); grad.addColorStop(1,"#99f6e4");
  ctx.fillStyle=grad;
  ctx.beginPath(); ctx.moveTo(0,-H*0.5); ctx.lineTo(W*0.48,0); ctx.lineTo(0,H*0.56); ctx.lineTo(-W*0.48,0); ctx.closePath(); ctx.fill();
  ctx.shadowBlur=0; ctx.lineWidth=1.8; ctx.strokeStyle="#0e7490"; ctx.stroke();
  ctx.restore();
}

/* ---------- Spawns & difficulty ---------- */
function allowedKindsByTime(t){
  if(t<10) return ["ufo_red","ufo_gray"];
  if(t<40) return ["ufo_red","ufo_gray","green"];
  return ["ufo_red","ufo_gray","green","red"];
}
function spawnEnemy(kinds){
  if(enemies.length>12) return;
  const size=rand(48,70);
  const kind=kinds[Math.floor(Math.random()*kinds.length)];
  const img=enemyImg[kind]||null;
  enemies.push({x:rand(0,cv.width-size),y:-size,w:size,h:size,vy:rand(1.4,3),kind,img,canShoot:(kind==="red"||kind==="green"),shootT:0,shootInt:500});
}
function enemyShoot(e){
  if(!e.canShoot) return;
  const cx=e.x+e.w/2;
  const bulletMul = (score>=500)?1.25:(score>=300)?1.15:1;
  if(e.kind==="red")   enemyBullets.push({x:cx-2,y:e.y+e.h,w:4,h:12,vy:6*bulletMul,color:"#ef4444"});
  else                 enemyBullets.push({x:cx-1,y:e.y+e.h,w:2,h:18,vy:6.5*bulletMul,color:"#22c55e"});
}
function spawnGem(){ if(powerTime>0) return; const s=22; gems.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.5}); }
function spawnMascot(){ if(score>=200 && Math.random()<0.8) return; const s=22; mascots.push({x:rand(0,cv.width-s), y:-s, w:s, h:s, vy:1.4}); }

/* ---------- Explosion ---------- */
function explosion(x,y,count=18){
  const left = Math.max(0, 120 - particles.length);
  const n = Math.min(count, left);
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, sp=1.2+Math.random()*2.8;
    particles.push({x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:420+Math.random()*280, size:1.6+Math.random()*2.4});
  }
  try{ boom.currentTime=0; boom.play().catch(()=>{}); }catch{}
}

/* ---------- Anti-montaj Game Over ---------- */
function renderFinalScore(t){
  const cx=cv.width/2, cy=cv.height/2;
  ctx.save();

  // Vinyet + yumu≈üak karartma
  const grd=ctx.createRadialGradient(cx,cy,20,cx,cy,Math.max(cv.width,cv.height)/1.2);
  grd.addColorStop(0,"rgba(0,0,0,0.55)");
  grd.addColorStop(1,"rgba(0,0,0,0.85)");
  ctx.fillStyle=grd; ctx.fillRect(0,0,cv.width,cv.height);

  // Panel
  const pw=Math.min(360,cv.width-40), ph=160, rx=cx-pw/2, ry=cy-ph/2-6;
  ctx.beginPath(); const r=14;
  ctx.moveTo(rx+r,ry);
  ctx.arcTo(rx+pw,ry,rx+pw,ry+ph,r);
  ctx.arcTo(rx+pw,ry+ph,rx,ry+ph,r);
  ctx.arcTo(rx,ry+ph,rx,ry,r);
  ctx.arcTo(rx,ry,rx+pw,ry,r); ctx.closePath();
  ctx.fillStyle="rgba(2,6,23,.92)"; ctx.fill();

  // D√∂nen mikro-yazƒ± deseni (score + code tekrar)
  ctx.save();
  ctx.beginPath(); ctx.rect(rx+10,ry+10,pw-20,ph-20); ctx.clip();
  ctx.translate(cx,cy); ctx.rotate((t/1000)%6.283*0.15);
  ctx.fillStyle="rgba(0,255,200,0.08)";
  const line = `Babypeacock ‚Ä¢ SCORE ${score} ‚Ä¢ CODE ${verifyCode} ‚Ä¢ `;
  ctx.font="700 12px system-ui,Arial";
  for(let y=-90;y<=90;y+=22){
    let x=-300;
    while(x<300){ ctx.fillText(line,x,y); x+=ctx.measureText(line).width+40; }
  }
  ctx.restore();

  // Ba≈ülƒ±k
  const titleGrad=ctx.createLinearGradient(cx-120,0,cx+120,0);
  titleGrad.addColorStop(0,"#22d3ee"); titleGrad.addColorStop(1,"#34d399");
  ctx.fillStyle=titleGrad; ctx.textAlign="center";
  ctx.font="900 22px system-ui,Arial";
  ctx.shadowColor="rgba(34,211,238,0.8)"; ctx.shadowBlur=12;
  ctx.fillText("Babypeacock",cx,cy-18);

  // B√ºy√ºk skor g√∂lge (arka)
  ctx.shadowBlur=0;
  ctx.fillStyle="rgba(0,255,200,0.18)"; ctx.font="900 66px system-ui,Arial";
  ctx.fillText(String(score),cx,cy+36);

  // Asƒ±l skor
  ctx.fillStyle="#00ffc8"; ctx.font="900 40px system-ui,Arial";
  ctx.shadowColor="rgba(0,255,200,0.9)"; ctx.shadowBlur=18;
  ctx.fillText("Score: "+score,cx,cy+14); ctx.shadowBlur=0;

  // Code rozet
  ctx.font="700 14px system-ui,Arial"; ctx.fillStyle="#a7f3d0";
  ctx.fillText("CODE: "+verifyCode,cx,ry+ph-14);

  ctx.restore();
}

/* ---------- Main loop ---------- */
async function endGame(){
  gameOver = true;
  overEl.style.display = "flex";
  overEl.style.background = "transparent";

  // Skoru kaydet ve haftalƒ±k paneli g√∂ster
  if (window.saveScore) await window.saveScore(score);
  if (window.showWeeklyPanel) window.showWeeklyPanel();

  // üåç Global counter: +1 on each finished game
  if (window.incrementGlobalPlays) window.incrementGlobalPlays();
}
function update(dt){
  starsA.forEach(s=>{ s.y+=0.35; if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);} });
  starsB.forEach(s=>{ s.y+=0.9;  if(s.y>cv.height){s.y=0;s.x=rand(0,cv.width);} });

  if(!started||gameOver) return;

  elapsed += dt/1000; enT += dt; gemT += dt; mascotT += dt;
  if(powerTime>0){ powerTime-=dt; if(powerTime<0) powerTime=0; }
  pxEl.textContent = powerTime>0 ? Math.ceil(powerTime/1000) : 0;
  fireTimer += dt; if(holding && fireTimer>FIRE_MS){ shoot(); fireTimer=0; }

  let speedMultiplier=1, spawnMultiplier=1;
  if(score>=300){ speedMultiplier=1.30; }
  if(score>=500){ speedMultiplier=1.30; spawnMultiplier=1.40; }

  if(enT>600/spawnMultiplier){ spawnEnemy(allowedKindsByTime(elapsed)); enT=0; }
  if(gemT>(score>=200?13000:9000)){ if(Math.random()<0.55) spawnGem(); gemT=0; }
  if(mascotT>12000){ spawnMascot(); mascotT=0; }

  bullets.forEach(b=>{ b.y+=b.vy; b.x+=(b.ang||0)*0.5; });
  bullets=bullets.filter(b=> b.y>-20);

  enemies.forEach(e=>{
    e.y += e.vy * speedMultiplier;
    e.shootT += dt;
    if(e.canShoot && e.shootT>=e.shootInt){ e.shootT=0; enemyShoot(e); }
  });
  enemies = enemies.filter(e=> e.y<=cv.height+40);

  enemyBullets.forEach(m=>{ m.y+=m.vy; });
  enemyBullets = enemyBullets.filter(m=> m.y<cv.height+40);

  gems.forEach(g=> g.y+=g.vy);       gems = gems.filter(g=> g.y<cv.height+40);
  mascots.forEach(m=> m.y+=m.vy);    mascots = mascots.filter(m=> m.y<cv.height+40);

  for(const e of enemies){
    if(rectHit(player,e)){ explosion(player.x+player.w/2,player.y+player.h/2,22); lives--; updateLives(); if(lives<=0) endGame(); e.dead=1; }
  }
  for(const m of enemyBullets){
    if(rectHit(player,m)){ explosion(player.x+player.w/2,player.y+player.h/2,22); lives--; updateLives(); if(lives<=0) endGame(); m.dead=1; }
  }
  for(const b of bullets){
    for(const e of enemies){
      if(rectHit(b,e)){ explosion(e.x+e.w/2, e.y+e.h/2, 16); b.dead=1; e.dead=1; score++; scEl.textContent=score; }
    }
  }
  for(const g of gems){ if(rectHit(player,g)){ powerTime=15000; g.dead=1; } }
  for(const m of mascots){ if(rectHit(player,m)){ lives=Math.min(5,lives+1); updateLives(); m.dead=1; } }

  enemies=enemies.filter(o=>!o.dead);
  bullets=bullets.filter(o=>!o.dead);
  enemyBullets=enemyBullets.filter(o=>!o.dead);
  gems=gems.filter(o=>!o.dead);
  mascots=mascots.filter(o=>!o.dead);

  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=dt;
    if(p.life<=0){ particles.splice(i,1); continue; }
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.02;
  }
}

function draw(t){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.fillStyle="rgba(190,220,255,.85)"; starsA.forEach(s=>ctx.fillRect(s.x,s.y,1,1));
  ctx.fillStyle="rgba(255,255,255,.95)";  starsB.forEach(s=>ctx.fillRect(s.x,s.y,1.2,1.2));

  if(playerImg) ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
  else { ctx.fillStyle="#38bdf8"; ctx.fillRect(player.x,player.y,player.w,player.h); }

  ctx.fillStyle="#00ffc8"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  enemies.forEach(e=>{
    if(e.img) ctx.drawImage(e.img,e.x,e.y,e.w,e.h);
    else { ctx.fillStyle=e.kind==="green"?"#22c55e":"#ef4444"; ctx.fillRect(e.x,e.y,e.w,e.h); }
  });

  enemyBullets.forEach(m=>{ ctx.fillStyle=m.color; ctx.fillRect(m.x,m.y,m.w,m.h); });

  gems.forEach(g=> drawDiamondGem(ctx,g.x,g.y,g.w,g.h, performance.now()/1000));
  if(peacockImg) mascots.forEach(m=>ctx.drawImage(peacockImg,m.x,m.y,m.w,m.h));

  particles.forEach(p=>{
    const a = Math.max(0, p.life/500);
    ctx.globalAlpha=a; ctx.fillStyle="rgba(255,200,80,1)";
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
  });

  if(gameOver){
    renderFinalScore(t);
    if(!scoreSent){ scoreSent=true; } // skor kaydƒ± endGame i√ßinden yapƒ±lƒ±yor
  }
}

function loop(t){ const dt=Math.min(t-(window._lt||t),32); window._lt=t; update(dt); draw(t); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

restartBtn.onclick=()=>{
  score=0;lives=3;powerTime=0; scEl.textContent=score; pxEl.textContent=0;
  bullets=[];enemies=[];enemyBullets=[];gems=[];mascots=[];particles=[];
  updateLives(); gameOver=false; started=false; scoreSent=false;
  overEl.style.display="none"; overEl.style.background="rgba(0,0,0,.84)";
  playId=Math.floor(performance.now()+Math.random()*1e9); makeCode();
  startOverlay.style.display="flex";
};

/* ---------- Preload ---------- */
let playerImg=null, enemyImg={red:null,green:null,ufo_red:null,ufo_gray:null}, peacockImg=null;
(async function(){
  try{ const p=await loadImage(PLAYER_SRC); playerImg=keyOutDark(p,80);}catch{}
  for(const k of Object.keys(ENEMY_SRC)){
    try{ const im=await loadImage(ENEMY_SRC[k]); enemyImg[k]=keyOutDark(im,80);}catch{}
  }
  try{ const bird=await loadImage(PEACOCK_SRC); peacockImg=keyOutDark(bird,70);}catch{}
})();
</script>

<!-- üîå Firebase (tek app) + Global Saya√ß + Haftalƒ±k Skor/Panel -->
<script type="module">import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const INSTANCE_URL = "https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
const app = getApps().length ? getApps()[0] : initializeApp({ databaseURL: INSTANCE_URL });
const db  = getDatabase(app);

window.db = db; // üî• kritik satƒ±r: artƒ±k globalde eri≈üilebilir
  
  /* === Sadece Game Over‚Äôda g√∂ster === */
  async function showWeeklyPanel(){
    if (!contest.active) return;
    const wk   = contest.week || weekKey();
    const me   = getPlayerCode();

    let dismissed = (localStorage.getItem("bpc_claim_dismiss") === wk);
    if (dismissed){
      try {
        const snap = await get(ref(db,`claims/${wk}/${me}`));
        if (!snap.exists()) dismissed = false;
      } catch(_){ dismissed = false; }
    }
    if (dismissed) return;

    const list = await getWeeklyTop10(wk);
    const el   = ensurePanel();
    document.getElementById("bpc-week").textContent   = wk;
    document.getElementById("bpc-mycode").textContent = me;
    document.getElementById("bpc-active").textContent = contest.active ? "AKTƒ∞F" : "PASƒ∞F";
    document.getElementById("bpc-active").style.background = contest.active ? "#16a34a" : "#64748b";
    document.getElementById("bpc-prize").textContent  = contest.prize ? `üéÅ √ñd√ºl: ${contest.prize}` : "";

    const ol = document.getElementById("bpc-list");
    ol.innerHTML = list.length
      ? list.map((it,i)=>{
          const mine = it.code===me;
          const cup  = i===0?' ü•á':i===1?' ü•à':i===2?' ü•â':'';
          return `<li style="margin:2px 0;">
            <b style="${mine?'color:#ff5c5c;':''}">${i+1}. ${it.code}</b> ‚Äî ${it.score} puan${cup}
          </li>`;
        }).join('')
      : `<div style="opacity:.7;">Hen√ºz skor yok.</div>`;

    const claimBox = document.getElementById("bpc-claim");
    const first = list[0];
    if (first && first.code === me){
      claimBox.innerHTML = `
        <button id="bpc-claim-btn"
          style="display:inline-block;background:#2563eb;color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;">
          üéÅ √ñd√ºl Talep Et
        </button>`;
      claimBox.style.display="block";

      document.getElementById("bpc-claim-btn").onclick = async ()=>{
        const payload = { code:me, score:first.score, week:wk, ts:Date.now(), method:"email" };
        await set(ref(db, `claims/${wk}/${me}`), payload);
        await set(ref(db, `contests/current/claims/${me}`), payload);

        const subj = encodeURIComponent(`BPC Weekly Prize Claim ‚Äì ${wk} ‚Äì ${me}`);
        const body = encodeURIComponent(
          `Hello Babypeacock Team,\n\nI am claiming my weekly prize.\n\n`+
          `Code: ${me}\nWeek: ${wk}\nScore: ${first.score}\nWallet (TRX): \nContact (X/Telegram): \n\n`+
          `Timestamp: ${new Date().toISOString()}\n\nThanks!`
        );
        window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subj}&body=${body}`;
      };
    } else {
      claimBox.style.display="none";
      claimBox.innerHTML = "";
    }
    el.style.display = "block";
  }

  // Oyun tarafƒ±na dƒ±≈üarƒ± a√ß
  window.saveScore       = saveScore;
  window.showWeeklyPanel = showWeeklyPanel;
</script>
<script type="module">
const INSTANCE_URL="https://bpc-space-default-rtdb.europe-west1.firebasedatabase.app/";
const ADMIN_EMAIL="babypeacock2025@gmail.com";

import{getApps,initializeApp}from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getDatabase,ref,get,set,push,onValue,runTransaction,query,orderByChild,limitToLast}from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* Firebase (single app) */
const app=getApps().length?getApps()[0]:initializeApp({databaseURL:INSTANCE_URL});
const db=getDatabase(app);

/* Helpers */
function weekKey(d=new Date()){const y=d.getFullYear(),oneJan=new Date(y,0,1);const day=(d.getDay()+6)%7;d.setDate(d.getDate()-day);const w=Math.ceil(((d-oneJan)/86400000+oneJan.getDay()+1)/7);return `${y}-W${String(w).padStart(2,"0")}`;}
function getPlayerCode(){let c=localStorage.getItem("playerCode");if(!c){c="BPC"+Math.floor(10000+Math.random()*89999);localStorage.setItem("playerCode",c);}return c}

/* Start overlay label (English) */
(()=>{const el=document.getElementById("playerCode");if(el)el.innerHTML=`üë§ Player: <b>${getPlayerCode()}</b>`;})();

/* Global plays (live + increment hook) */
const refCounter=ref(db,"stats/globalPlays");
const elGC=document.getElementById("globalCounter");
const cached=Number(localStorage.getItem("bpc_global_plays")||0);
if(elGC)elGC.textContent=cached?cached.toLocaleString("en-US"):"‚Ä¶";
onValue(refCounter,s=>{const v=Number(s.val()??0);if(elGC)elGC.textContent=v.toLocaleString("en-US");localStorage.setItem("bpc_global_plays",String(v));});
window.incrementGlobalPlays=()=>runTransaction(refCounter,v=>(v||0)+1);

/* Save score (all-time + weekly) */
async function saveScore(score){const data={code:getPlayerCode(),score,time:Date.now()};await set(push(ref(db,"scores")),data);await set(push(ref(db,`scoresWeekly/${weekKey()}`)),data);}
window.saveScoreFinal=saveScore;

/* Weekly Top-10 */
async function getWeeklyTop10(wk=weekKey()){const s=await get(query(ref(db,`scoresWeekly/${wk}`),orderByChild("score"),limitToLast(10)));const a=[];s.forEach(c=>a.push(c.val()));a.sort((x,y)=>y.score-x.score);return a}

/* Contest (auto-close previous week) */
let contest={active:false,week:weekKey(),prize:""};
onValue(ref(db,"contests/current"),async s=>{const v=s.val()||{};const now=weekKey();contest.active=!!v.active;contest.week=v.week||now;contest.prize=v.prize||"";try{if(v.active&&v.week&&v.week!==now)await set(ref(db,"contests/current/active"),false);}catch{} });

/* Weekly panel (English, mobile-safe) */
/* ===================== PATCH: weekly contest + claimCode ===================== */

/* ‚Äî g√ºvenli rastgele claim kodu √ºret ‚Äî */
function genClaimCode(week, code) {
  // 5 hex char‚Äôlƒ±k ek par√ßa
  const b = new Uint8Array(3);
  (self.crypto || window.crypto).getRandomValues(b);
  const rnd = [...b].map(x => x.toString(16).padStart(2,'0')).join('').slice(0,5).toUpperCase();
  return `CLAIM-${week}-${code}-${rnd}`;
}

/* ‚Äî paneli tek sefer kur ‚Äî */
function ensurePanel(){
  let el = document.getElementById('bpc-leaderboard');
  if (el) return el;

  el = document.createElement('div');
  el.id = 'bpc-leaderboard';
  el.style.cssText = `
    position:fixed;inset:0;z-index:9999;display:none;
    align-items:center;justify-content:center;
    background:rgba(0,0,0,.64);backdrop-filter:blur(2px)
  `;
  el.innerHTML = `
    <div style="width:min(92vw,560px);max-height:80vh;overflow:auto;border-radius:18px;background:#0b0f14;color:#e6fff1;box-shadow:0 12px 60px rgba(0,0,0,.5)">
      <div style="position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#0b0f14;border-bottom:1px solid #123">
        <span style="font-weight:800;letter-spacing:.3px">üèÜ Weekly Leaders</span>
        <button id="bpc-close" aria-label="close" style="background:transparent;border:none;color:#b9fcff;font-size:18px">‚úï</button>
      </div>

      <div style="padding:10px 14px;font-size:14px;opacity:.9">
        <div>Week: <b id="bpc-week"></b> <span id="bpc-active-badge" style="margin-left:6px;padding:2px 6px;border-radius:9999px;font-size:11px;background:#173;border:1px solid #2b5">ACTIVE</span></div>
        <div id="bpc-prize" style="margin-top:4px">Prize: ‚Äì</div>
        <div>Your code: <b id="bpc-mycode"></b></div>
      </div>

      <ol id="bpc-list" style="margin:8px 12px 18px;padding-right:12px;"></ol>

      <div id="bpc-claim" style="display:none;padding:14px">
        <button id="bpc-claim-btn" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid #27e0b3;background:#0bf2b2;color:#023;font-weight:800">
          üéÅ Claim Prize
        </button>
        <div id="bpc-claim-info" style="display:none;margin-top:8px;font-size:12px;opacity:.8"></div>
      </div>
    </div>
  `;
  document.body.appendChild(el);

  // kapat
  document.getElementById('bpc-close').onclick = () => {
    el.style.display = "none";
    document.body.style.overflow = "";
  };

  return el;
}

/* ‚Äî haftalƒ±k top10‚Äôu oku ‚Äî */
async function getWeeklyTop10(weekKey) {
  const q = query(ref(db, `scoresWeekly/${weekKey}`), orderByChild("score"), limitToLast(10));
  const snap = await get(q);
  const arr = [];
  snap.forEach(ch => arr.push(ch.val()));
  // b√ºy√ºkten k√º√ß√ºƒüe
  arr.sort((a,b) => (b.score||0) - (a.score||0));
  return arr;
}

/* ‚Äî paneli g√∂ster ve claim akƒ±≈üƒ±nƒ± y√∂net ‚Äî */
async function showWeeklyPanel(){
  // yarƒ±≈üma durumunu oku
  const wk = weekKey();
  const contestSnap = await get(ref(db, 'contests/current'));
  const contest = contestSnap.exists() ? contestSnap.val() : {active:false, week:wk, prize:"-"};

  const myCode = getPlayerCode();
  const list = await getWeeklyTop10(wk);

  // UI doldur
  const wrap = ensurePanel();
  document.getElementById('bpc-week').textContent  = wk;
  document.getElementById('bpc-mycode').textContent = myCode;
  const badge = document.getElementById('bpc-active-badge');
  badge.textContent = contest.active && contest.week === wk ? "ACTIVE" : "INACTIVE";
  badge.style.background = (contest.active && contest.week === wk) ? "#173" : "#522";
  badge.style.borderColor = (contest.active && contest.week === wk) ? "#2b5" : "#844";
  document.getElementById('bpc-prize').textContent = `Prize: ${contest.prize || "-"}`;

  // liste
  const ol = document.getElementById('bpc-list');
  if (list.length === 0) {
    ol.innerHTML = `<li style="opacity:.7;margin:8px 14px">No scores yet.</li>`;
  } else {
    ol.innerHTML = list.map((it,i)=>{
      const rank = i+1;
      const you  = it.code === myCode;
      const cup  = rank===1?"ü•á":rank===2?"ü•à":rank===3?"ü•â":"";
      return `
        <li style="padding:8px 9px;border-bottom:1px dashed rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:12px">
          <span style="${you?'color:#ff6b6b;font-weight:800;text-shadow:0 0 8px rgba(255,90,70,.35);':''}">
            #${String(rank).padStart(2,"0")} ‚Äî ${it.code}${you?' (you)':''} ${cup}
          </span>
          <span style="opacity:.9">${it.score||0} pts</span>
        </li>`;
    }).join('');
  }

  // CLAIM g√∂r√ºn√ºrl√ºƒü√º: yalnƒ±zca 1. olan, hafta e≈üle≈üiyorsa ve yarƒ±≈üma aktifse
  const isActiveWeek = contest.active && contest.week === wk;
  const first = list[0];
  const claimBox = document.getElementById('bpc-claim');
  const claimBtn = document.getElementById('bpc-claim-btn');
  const claimInfo= document.getElementById('bpc-claim-info');

  let canClaim = Boolean(isActiveWeek && first && first.code === myCode);
  // daha √∂nce claim var mƒ±?
  try {
    const prev = await get(ref(db, `claims/${wk}/${myCode}`));
    if (prev.exists()) { canClaim = false; claimInfo.style.display='block'; claimInfo.textContent = 'You already claimed this week.'; }
  } catch {}

  claimBox.style.display = canClaim ? 'block' : 'none';

  claimBtn.onclick = async () => {
    if (!canClaim) return;

    // benzersiz claim code
    const claimCode = genClaimCode(wk, myCode);

    // kaydet
    const payload = {
      code: myCode,
      score: first.score || 0,
      week: wk,
      ts: Date.now(),
      method: "email",
      claimCode
    };
    await set(ref(db, `claims/${wk}/${myCode}`), payload);

    // e-posta hazƒ±rla
    const subj = encodeURIComponent(`BPC Weekly Prize Claim ‚Äì ${wk} ‚Äì ${myCode}`);
    const body = encodeURIComponent(
`Hello Babypeacock Team,

I am claiming my weekly prize.

Week: ${wk}
Code: ${myCode}
Score: ${first.score||0}
Claim Code: ${claimCode}
Wallet (TRX):
Contact (X/Telegram):

Thanks!`
    );
    location.href = `mailto:babypeacock2025@gmail.com?subject=${subj}&body=${body}`;
  };

  wrap.style.display = "flex";
  document.body.style.overflow = "hidden";
}

/* ‚Äî oyun sonunda √ßaƒüƒ±r: top10 sadece Game Over‚Äôda ‚Äî */
// √∂rnek: await window.saveScoreFinal(score);  // senin mevcut kaydetme √ßaƒürƒ±n
// sonra:
window.showWeeklyPanel = showWeeklyPanel;
/* END PATCH weekly contest + claimCode */

/* ================== END PATCH =================== */
</script>
</body>
</html>
